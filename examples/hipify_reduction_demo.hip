/**
 * HIPIFY çœŸå®æ¡ˆä¾‹ï¼šå½’çº¦æ“ä½œçš„å¯„å­˜å™¨ä¼˜åŒ–
 * æ¥æº: HIPIFYå®˜æ–¹æµ‹è¯•å¥—ä»¶ tests/unit_tests/samples/reduction.cu
 * 
 * æœ¬ç¤ºä¾‹å±•ç¤º3ç§ä¸åŒä¼˜åŒ–çº§åˆ«çš„å½’çº¦æ“ä½œï¼š
 * 1. æœªä¼˜åŒ–ç‰ˆæœ¬ (åŸºç¡€å¾ªç¯)
 * 2. 4å€å¾ªç¯å±•å¼€ä¼˜åŒ–
 * 3. 16å€å¾ªç¯å±•å¼€ä¼˜åŒ–
 * 
 * å­¦ä¹ ç›®æ ‡: ç†è§£å¯„å­˜å™¨ä¼˜åŒ–å¦‚ä½•å½±å“GPUæ€§èƒ½
 */

#include <hip/hip_runtime.h>
#include <iostream>
#include <chrono>

// âŒ ç‰ˆæœ¬1: æœªä¼˜åŒ– - ç®€å•å¾ªç¯ï¼Œå¯„å­˜å™¨ä½¿ç”¨æ•ˆç‡ä½
__global__ void atomic_reduction_kernel(int *in, int *out, int ARRAYSIZE) {
    int sum = int(0);
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    
    // æ¯æ¬¡è¿­ä»£åªå¤„ç†ä¸€ä¸ªå…ƒç´ 
    for (int i = idx; i < ARRAYSIZE; i += blockDim.x * gridDim.x) {
        sum += in[i];
    }
    
    atomicAdd(out, sum);
}

// âœ… ç‰ˆæœ¬2: ä¼˜åŒ– - 4å€å¾ªç¯å±•å¼€
__global__ void atomic_reduction_kernel3(int *in, int *out, int ARRAYSIZE) {
    int sum = int(0);
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    
    // ç­–ç•¥ï¼šå¾ªç¯å±•å¼€4å€ï¼Œå‡å°‘å¾ªç¯å¼€é”€å’Œå¯„å­˜å™¨æº¢å‡º
    for(int i = idx * 4; i < ARRAYSIZE - 3; i += blockDim.x * gridDim.x * 4) {
        sum += in[i] + in[i+1] + in[i+2] + in[i+3];
    }
    
    // å¤„ç†å‰©ä½™å…ƒç´ 
    for(int i = idx * 4 + ((ARRAYSIZE / 4) * 4); i < ARRAYSIZE; i += blockDim.x * gridDim.x) {
        if(i < ARRAYSIZE) sum += in[i];
    }
    
    atomicAdd(out, sum);
}

// âœ…âœ… ç‰ˆæœ¬3: æ¿€è¿›ä¼˜åŒ– - 16å€å¾ªç¯å±•å¼€
__global__ void atomic_reduction_kernel2(int *in, int *out, int ARRAYSIZE) {
    int sum = int(0);
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    
    // å±•å¼€16å€
    for(int i = idx * 16; i < ARRAYSIZE - 15; i += blockDim.x * gridDim.x * 16) {
        sum += in[i] + in[i+1] + in[i+2] + in[i+3] + in[i+4] + in[i+5] 
             + in[i+6] + in[i+7] + in[i+8] + in[i+9] + in[i+10]
             + in[i+11] + in[i+12] + in[i+13] + in[i+14] + in[i+15];
    }
    
    // å¤„ç†å‰©ä½™å…ƒç´ 
    for(int i = idx * 16 + ((ARRAYSIZE / 16) * 16); i < ARRAYSIZE; i += blockDim.x * gridDim.x) {
        if(i < ARRAYSIZE) sum += in[i];
    }
    
    atomicAdd(out, sum);
}

// é”™è¯¯æ£€æŸ¥å®
#define HIP_CHECK(call) \
{ \
    hipError_t err = call; \
    if (err != hipSuccess) { \
        std::cerr << "HIP Error: " << hipGetErrorString(err) \
                  << " (line " << __LINE__ << ")" << std::endl; \
        exit(1); \
    } \
}

// æ€§èƒ½æµ‹è¯•å‡½æ•°
template<typename KernelFunc>
double benchmark_kernel(KernelFunc kernel, int *d_in, int *d_out, int arraySize, 
                       int blockSize, int gridSize, const char* name) {
    // é‡ç½®è¾“å‡º
    int zero = 0;
    HIP_CHECK(hipMemcpy(d_out, &zero, sizeof(int), hipMemcpyHostToDevice));
    
    // é¢„çƒ­
    hipLaunchKernelGGL(kernel, dim3(gridSize), dim3(blockSize), 0, 0, d_in, d_out, arraySize);
    HIP_CHECK(hipDeviceSynchronize());
    
    // è®¡æ—¶
    auto start = std::chrono::high_resolution_clock::now();
    
    for(int i = 0; i < 10; i++) {
        HIP_CHECK(hipMemcpy(d_out, &zero, sizeof(int), hipMemcpyHostToDevice));
        hipLaunchKernelGGL(kernel, dim3(gridSize), dim3(blockSize), 0, 0, d_in, d_out, arraySize);
    }
    
    HIP_CHECK(hipDeviceSynchronize());
    auto end = std::chrono::high_resolution_clock::now();
    
    double elapsed = std::chrono::duration<double, std::milli>(end - start).count() / 10.0;
    
    // éªŒè¯ç»“æœ
    int result;
    HIP_CHECK(hipMemcpy(&result, d_out, sizeof(int), hipMemcpyDeviceToHost));
    
    std::cout << "ğŸ”¹ " << name << std::endl;
    std::cout << "   æ‰§è¡Œæ—¶é—´: " << elapsed << " ms" << std::endl;
    std::cout << "   ç»“æœ: " << result << " (æœŸæœ›: " << arraySize << ")" << std::endl;
    std::cout << "   å¸¦å®½: " << (arraySize * sizeof(int) / elapsed / 1e6) << " GB/s" << std::endl;
    
    return elapsed;
}

int main(int argc, char** argv) {
    // é»˜è®¤æ•°ç»„å¤§å°
    int arraySize = 52428800;  // ~50M elements
    if(argc > 1) {
        arraySize = atoi(argv[1]);
    }
    
    std::cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" << std::endl;
    std::cout << "ğŸ“Š HIPIFY å½’çº¦ä¼˜åŒ–ç¤ºä¾‹" << std::endl;
    std::cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" << std::endl;
    std::cout << "æ•°ç»„å¤§å°: " << arraySize << " elements" << std::endl;
    std::cout << "å†…å­˜å ç”¨: " << (arraySize * sizeof(int) / 1024.0 / 1024.0) << " MB" << std::endl;
    
    // åˆ†é…å†…å­˜
    int *h_in = new int[arraySize];
    for(int i = 0; i < arraySize; i++) {
        h_in[i] = 1;  // æ¯ä¸ªå…ƒç´ ä¸º1ï¼Œæ€»å’Œåº”ç­‰äºarraySize
    }
    
    int *d_in, *d_out;
    HIP_CHECK(hipMalloc(&d_in, arraySize * sizeof(int)));
    HIP_CHECK(hipMalloc(&d_out, sizeof(int)));
    HIP_CHECK(hipMemcpy(d_in, h_in, arraySize * sizeof(int), hipMemcpyHostToDevice));
    
    // é…ç½®
    int blockSize = 256;
    int gridSize = 512;
    
    std::cout << "\nâš™ï¸  é…ç½®:" << std::endl;
    std::cout << "   Block Size: " << blockSize << std::endl;
    std::cout << "   Grid Size: " << gridSize << std::endl;
    std::cout << "   æ€»çº¿ç¨‹æ•°: " << (blockSize * gridSize) << std::endl;
    std::cout << "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" << std::endl;
    
    // æµ‹è¯•ä¸‰ä¸ªç‰ˆæœ¬
    double time1 = benchmark_kernel(atomic_reduction_kernel, d_in, d_out, arraySize, 
                                    blockSize, gridSize, "ç‰ˆæœ¬1: æœªä¼˜åŒ– (åŸºç¡€å¾ªç¯)");
    std::cout << std::endl;
    
    double time2 = benchmark_kernel(atomic_reduction_kernel3, d_in, d_out, arraySize, 
                                    blockSize, gridSize, "ç‰ˆæœ¬2: 4å€å¾ªç¯å±•å¼€");
    std::cout << std::endl;
    
    double time3 = benchmark_kernel(atomic_reduction_kernel2, d_in, d_out, arraySize, 
                                    blockSize, gridSize, "ç‰ˆæœ¬3: 16å€å¾ªç¯å±•å¼€");
    
    // æ€§èƒ½å¯¹æ¯”
    std::cout << "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" << std::endl;
    std::cout << "ğŸ“ˆ æ€§èƒ½å¯¹æ¯”:" << std::endl;
    std::cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" << std::endl;
    std::cout << "ç‰ˆæœ¬2 vs ç‰ˆæœ¬1: " << (time1 / time2) << "x åŠ é€Ÿ ("
              << ((time1 - time2) / time1 * 100) << "% æå‡)" << std::endl;
    std::cout << "ç‰ˆæœ¬3 vs ç‰ˆæœ¬1: " << (time1 / time3) << "x åŠ é€Ÿ ("
              << ((time1 - time3) / time1 * 100) << "% æå‡)" << std::endl;
    std::cout << "ç‰ˆæœ¬3 vs ç‰ˆæœ¬2: " << (time2 / time3) << "x åŠ é€Ÿ ("
              << ((time2 - time3) / time2 * 100) << "% æå‡)" << std::endl;
    std::cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" << std::endl;
    
    // å­¦ä¹ è¦ç‚¹
    std::cout << "ğŸ’¡ å­¦ä¹ è¦ç‚¹:" << std::endl;
    std::cout << "   1. å¾ªç¯å±•å¼€å‡å°‘å¾ªç¯å¼€é”€å’Œåˆ†æ”¯åˆ¤æ–­" << std::endl;
    std::cout << "   2. æ›´å¥½çš„æŒ‡ä»¤çº§å¹¶è¡Œï¼ˆILPï¼‰" << std::endl;
    std::cout << "   3. ä½†è¿‡åº¦å±•å¼€å¯èƒ½å¯¼è‡´å¯„å­˜å™¨æº¢å‡º" << std::endl;
    std::cout << "   4. éœ€è¦åœ¨å¯„å­˜å™¨å‹åŠ›å’ŒILPä¹‹é—´æƒè¡¡" << std::endl;
    std::cout << "\nğŸ”§ ä¼˜åŒ–å»ºè®®:" << std::endl;
    std::cout << "   - ä½¿ç”¨ 'hipcc --resource-usage' æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨" << std::endl;
    std::cout << "   - ä½¿ç”¨ 'rocprof --stats' è¿›è¡Œè¯¦ç»†æ€§èƒ½åˆ†æ" << std::endl;
    std::cout << "   - æ ¹æ®å…·ä½“GPUæ¶æ„è°ƒæ•´å±•å¼€å€æ•°" << std::endl;
    std::cout << "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" << std::endl;
    
    // æ¸…ç†
    HIP_CHECK(hipFree(d_in));
    HIP_CHECK(hipFree(d_out));
    delete[] h_in;
    
    return 0;
}

