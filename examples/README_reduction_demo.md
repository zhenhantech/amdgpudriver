# HIPIFY çœŸå®æ¡ˆä¾‹ä½¿ç”¨æŒ‡å—ï¼šå½’çº¦ä¼˜åŒ–

> ğŸ“– æœ¬ç¤ºä¾‹æ¥è‡ª AMD HIPIFY å®˜æ–¹æµ‹è¯•å¥—ä»¶  
> ğŸ¯ å­¦ä¹ ç›®æ ‡ï¼šç†è§£å¯„å­˜å™¨ä¼˜åŒ–å¦‚ä½•æå‡ 15-30% æ€§èƒ½

## ğŸ“¦ æ–‡ä»¶è¯´æ˜

```
examples/
â”œâ”€â”€ hipify_reduction_demo.hip    # å®Œæ•´ç¤ºä¾‹ä»£ç ï¼ˆåŒ…å«3ä¸ªä¼˜åŒ–ç‰ˆæœ¬ï¼‰
â”œâ”€â”€ run_reduction_demo.sh        # ä¸€é”®ç¼–è¯‘è¿è¡Œè„šæœ¬
â””â”€â”€ README_reduction_demo.md     # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: ä¸€é”®è¿è¡Œï¼ˆæ¨èï¼‰

```bash
cd /mnt/md0/zhehan/code/coderampup/examples
chmod +x run_reduction_demo.sh
./run_reduction_demo.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨ç¼–è¯‘

```bash
# åŸºç¡€ç¼–è¯‘
hipcc -O3 hipify_reduction_demo.hip -o reduction_demo

# æ˜¾ç¤ºå¯„å­˜å™¨ä½¿ç”¨ï¼ˆå­¦ä¹ é‡ç‚¹ï¼ï¼‰
hipcc -O3 --resource-usage hipify_reduction_demo.hip -o reduction_demo

# è¿è¡Œ
./reduction_demo 52428800  # å‚æ•°æ˜¯æ•°ç»„å¤§å°
```

### æ–¹æ³•3: ä»GitHubè·å–åŸå§‹ä»£ç 

```bash
# å…‹éš†HIPIFYå®˜æ–¹ä»“åº“
git clone https://github.com/ROCm-Developer-Tools/HIPIFY.git
cd HIPIFY/tests/unit_tests/samples

# ç¼–è¯‘åŸå§‹ç¤ºä¾‹
hipcc reduction.cu -o reduction

# è¿è¡Œ
./reduction 52428800
```

## ğŸ“Š é¢„æœŸè¾“å‡º

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š HIPIFY å½’çº¦ä¼˜åŒ–ç¤ºä¾‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ•°ç»„å¤§å°: 52428800 elements
å†…å­˜å ç”¨: 200.0 MB

âš™ï¸  é…ç½®:
   Block Size: 256
   Grid Size: 512
   æ€»çº¿ç¨‹æ•°: 131072

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”¹ ç‰ˆæœ¬1: æœªä¼˜åŒ– (åŸºç¡€å¾ªç¯)
   æ‰§è¡Œæ—¶é—´: 1.234 ms
   ç»“æœ: 52428800 (æœŸæœ›: 52428800)
   å¸¦å®½: 162.5 GB/s

ğŸ”¹ ç‰ˆæœ¬2: 4å€å¾ªç¯å±•å¼€
   æ‰§è¡Œæ—¶é—´: 0.895 ms
   ç»“æœ: 52428800 (æœŸæœ›: 52428800)
   å¸¦å®½: 224.3 GB/s

ğŸ”¹ ç‰ˆæœ¬3: 16å€å¾ªç¯å±•å¼€
   æ‰§è¡Œæ—¶é—´: 0.756 ms
   ç»“æœ: 52428800 (æœŸæœ›: 52428800)
   å¸¦å®½: 265.8 GB/s

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ æ€§èƒ½å¯¹æ¯”:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç‰ˆæœ¬2 vs ç‰ˆæœ¬1: 1.38x åŠ é€Ÿ (27.5% æå‡)
ç‰ˆæœ¬3 vs ç‰ˆæœ¬1: 1.63x åŠ é€Ÿ (38.7% æå‡)
ç‰ˆæœ¬3 vs ç‰ˆæœ¬2: 1.18x åŠ é€Ÿ (15.5% æå‡)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## ğŸ” æ·±å…¥åˆ†æ

### Step 1: æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨

```bash
# ç¼–è¯‘æ—¶æ˜¾ç¤ºèµ„æºä½¿ç”¨
hipcc -O3 --resource-usage hipify_reduction_demo.hip -o reduction_demo

# è¾“å‡ºç¤ºä¾‹:
# kernel.hip:18: Kernel 'atomic_reduction_kernel' uses 24 VGPRs, 16 SGPRs
# kernel.hip:29: Kernel 'atomic_reduction_kernel3' uses 28 VGPRs, 18 SGPRs
# kernel.hip:44: Kernel 'atomic_reduction_kernel2' uses 36 VGPRs, 20 SGPRs
```

**å…³é”®è§‚å¯Ÿ**ï¼š
- ç‰ˆæœ¬1ï¼š24ä¸ªVGPRï¼ˆå‘é‡å¯„å­˜å™¨ï¼‰
- ç‰ˆæœ¬2ï¼š28ä¸ªVGPRï¼ˆ+16.7%ï¼‰
- ç‰ˆæœ¬3ï¼š36ä¸ªVGPRï¼ˆ+50%ï¼‰

**ç»“è®º**ï¼šå¾ªç¯å±•å¼€ä¼šå¢åŠ å¯„å­˜å™¨ä½¿ç”¨ï¼Œä½†å¸¦æ¥çš„æ€§èƒ½æå‡è¶…è¿‡äº†å¯„å­˜å™¨å‹åŠ›çš„è´Ÿé¢å½±å“ã€‚

### Step 2: æ€§èƒ½åˆ†æï¼ˆéœ€è¦rocprofï¼‰

```bash
# è¯¦ç»†æ€§èƒ½åˆ†æ
rocprof --stats ./reduction_demo 52428800

# æŸ¥çœ‹å…³é”®æŒ‡æ ‡
rocprof --hip-trace --stats ./reduction_demo 52428800

# è¾“å‡ºä¼šåŒ…å«:
# - Kernelæ‰§è¡Œæ—¶é—´
# - å†…å­˜å¸¦å®½åˆ©ç”¨ç‡
# - Wavefrontå ç”¨ç‡
# - L2ç¼“å­˜å‘½ä¸­ç‡
```

### Step 3: å®éªŒä¸åŒé…ç½®

ä¿®æ”¹ä»£ç ä¸­çš„è¿™äº›å‚æ•°ï¼Œè§‚å¯Ÿæ€§èƒ½å˜åŒ–ï¼š

```cpp
// åœ¨ main() å‡½æ•°ä¸­
int blockSize = 256;  // å°è¯•: 128, 256, 512
int gridSize = 512;   // å°è¯•: 256, 512, 1024

// åœ¨ kernel å‡½æ•°ä¸­
// å°è¯•ä¸åŒçš„å±•å¼€å€æ•°: 2, 4, 8, 16, 32
```

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### 1. å¾ªç¯å±•å¼€çš„ä¼˜åŠ¿
```cpp
// âŒ æœªå±•å¼€: æ¯æ¬¡å¾ªç¯éœ€è¦
// - æ›´æ–°å¾ªç¯è®¡æ•°å™¨ (i += stride)
// - è¾¹ç•Œæ£€æŸ¥ (i < ARRAYSIZE)
// - æ¡ä»¶è·³è½¬
for (int i = idx; i < ARRAYSIZE; i += stride) {
    sum += in[i];
}

// âœ… å±•å¼€4å€: 
// - å¾ªç¯æ¬¡æ•°å‡å°‘4å€
// - åˆ†æ”¯é¢„æµ‹æ›´å‡†ç¡®
// - æ›´å¥½çš„æŒ‡ä»¤çº§å¹¶è¡Œï¼ˆILPï¼‰
for(int i = idx * 4; i < ARRAYSIZE; i += stride * 4) {
    sum += in[i] + in[i+1] + in[i+2] + in[i+3];
}
```

### 2. å¯„å­˜å™¨ vs æ€§èƒ½æƒè¡¡

| å±•å¼€å€æ•° | VGPRä½¿ç”¨ | æ€§èƒ½æå‡ | é€‚ç”¨åœºæ™¯ |
|---------|---------|---------|---------|
| 1x (ä¸å±•å¼€) | æœ€ä½ | åŸºå‡† | å¯„å­˜å™¨å‹åŠ›å¤§çš„å¤æ‚kernel |
| 4x | ä½ | +20-30% | **æ¨èé»˜è®¤é€‰æ‹©** âœ… |
| 16x | ä¸­ | +30-40% | ç®€å•è®¡ç®—å¯†é›†å‹kernel |
| 32x+ | é«˜ | å¯èƒ½ä¸‹é™ | âš ï¸ å°å¿ƒå¯„å­˜å™¨æº¢å‡º |

### 3. AMD GPU ç‰¹æ€§

```
VGPR (Vector General Purpose Register):
- CDNA2 (MI200): æ¯ä¸ªçº¿ç¨‹æœ€å¤š 256 ä¸ª VGPR
- æ¯ä¸ªVGPR: 32-bit
- ä½¿ç”¨è¿‡å¤šä¼šé™ä½å ç”¨ç‡

å ç”¨ç‡è®¡ç®—:
Occupancy = å®é™…æ´»è·ƒWavefrontæ•° / ç†è®ºæœ€å¤§Wavefrontæ•°

å¯„å­˜å™¨å½±å“:
- 24 VGPR: å¯ä»¥åŒæ—¶è¿è¡Œ 10+ wavefront âœ…
- 128 VGPR: åªèƒ½è¿è¡Œ 2 wavefront âŒ
```

## ğŸ§ª å®éªŒä»»åŠ¡

### ä»»åŠ¡1: åŸºç¡€å¯¹æ¯”ï¼ˆ10åˆ†é’Ÿï¼‰
1. è¿è¡Œç¨‹åºï¼Œè®°å½•ä¸‰ä¸ªç‰ˆæœ¬çš„æ€§èƒ½æ•°æ®
2. è®¡ç®—æ€§èƒ½æå‡ç™¾åˆ†æ¯”
3. éªŒè¯ç»“æœæ­£ç¡®æ€§

### ä»»åŠ¡2: å¯„å­˜å™¨åˆ†æï¼ˆ20åˆ†é’Ÿï¼‰
1. ä½¿ç”¨ `--resource-usage` æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨
2. ä¿®æ”¹å±•å¼€å€æ•°ä¸º 2x, 8x, 32x
3. è§‚å¯Ÿå¯„å­˜å™¨ä½¿ç”¨å’Œæ€§èƒ½çš„å…³ç³»
4. æ‰¾åˆ°æœ€ä¼˜å±•å¼€å€æ•°

### ä»»åŠ¡3: é…ç½®è°ƒä¼˜ï¼ˆ30åˆ†é’Ÿï¼‰
1. æµ‹è¯•ä¸åŒçš„ blockSize: 128, 256, 512
2. æµ‹è¯•ä¸åŒçš„ gridSize: 256, 512, 1024
3. ç»˜åˆ¶æ€§èƒ½çƒ­åŠ›å›¾
4. æ‰¾åˆ°æœ€ä¼˜é…ç½®

### ä»»åŠ¡4: æ€§èƒ½åˆ†æï¼ˆ40åˆ†é’Ÿï¼Œéœ€è¦rocprofï¼‰
1. ä½¿ç”¨ rocprof åˆ†æå†…å­˜å¸¦å®½
2. æŸ¥çœ‹ Wavefront å ç”¨ç‡
3. åˆ†æ L2 ç¼“å­˜å‘½ä¸­ç‡
4. æ’°å†™æ€§èƒ½æŠ¥å‘Š

## ğŸ“š æ‰©å±•é˜…è¯»

### ç›¸å…³æ¡ˆä¾‹
- **å ç”¨ç‡ä¼˜åŒ–**: `2_Cookbook/13_occupancy/occupancy.cpp`
- **å…±äº«å†…å­˜**: `static_shared_memory.cu`
- **çŸ©é˜µè½¬ç½®**: `transpose_optimization.cu`

### å®˜æ–¹æ–‡æ¡£
- [AMD CDNAæ¶æ„ç™½çš®ä¹¦](https://www.amd.com/en/technologies/cdna)
- [ROCmæ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://rocm.docs.amd.com/en/latest/how-to/tuning-guides/)
- [HIPIFY GitHubä»“åº“](https://github.com/ROCm-Developer-Tools/HIPIFY)

### è¿›é˜¶ä¼˜åŒ–æŠ€å·§
1. **Warp Shuffleä¼˜åŒ–** (éš¾åº¦ â­â­â­)
2. **å…±äº«å†…å­˜Bankå†²çªä¼˜åŒ–** (éš¾åº¦ â­â­â­)
3. **å¤šçº§å½’çº¦ç­–ç•¥** (éš¾åº¦ â­â­â­â­)
4. **æ··åˆç²¾åº¦è®¡ç®—** (éš¾åº¦ â­â­â­â­)

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘æŠ¥é”™ "hipcc: command not found"
**è§£å†³**ï¼š
```bash
# æ£€æŸ¥ROCmæ˜¯å¦å®‰è£…
ls /opt/rocm

# è®¾ç½®ç¯å¢ƒå˜é‡
export PATH=/opt/rocm/bin:$PATH
export LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
```

### Q2: è¿è¡Œæ—¶é”™è¯¯ "HIP Error: hipErrorInvalidDevice"
**è§£å†³**ï¼š
```bash
# æ£€æŸ¥GPUæ˜¯å¦å¯ç”¨
rocminfo | grep "Name:"

# è®¾ç½®å¯è§GPU
export HIP_VISIBLE_DEVICES=0
```

### Q3: æ€§èƒ½æå‡ä¸æ˜æ˜¾
**å¯èƒ½åŸå› **ï¼š
1. ç¼–è¯‘ä¼˜åŒ–æœªå¼€å¯ï¼ˆç¡®ä¿ä½¿ç”¨ `-O3`ï¼‰
2. æ•°ç»„å¤ªå°ï¼ˆå°è¯•æ›´å¤§çš„æ•°ç»„ï¼‰
3. GPUè¢«å…¶ä»–ç¨‹åºå ç”¨
4. å†…å­˜å¸¦å®½å·²è¾¾åˆ°ç¡¬ä»¶ä¸Šé™

### Q4: å¦‚ä½•æŸ¥çœ‹æˆ‘çš„GPUè§„æ ¼ï¼Ÿ
```bash
rocminfo | grep -E "Name:|Max Clock|Compute Unit"
```

## ğŸ¯ å­¦ä¹ æ£€æŸ¥ç‚¹

å®Œæˆæœ¬ç¤ºä¾‹åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… ç†è§£å¾ªç¯å±•å¼€çš„ä¼˜åŒ–åŸç†
- âœ… ä½¿ç”¨ `--resource-usage` æŸ¥çœ‹å¯„å­˜å™¨ä½¿ç”¨
- âœ… åˆ†æå¯„å­˜å™¨å‹åŠ›å¯¹æ€§èƒ½çš„å½±å“
- âœ… æ‰¾åˆ°æœ€ä¼˜çš„å±•å¼€å€æ•°
- âœ… ä½¿ç”¨ rocprof è¿›è¡Œæ€§èƒ½åˆ†æ
- âœ… ç†è§£ AMD GPU çš„å¯„å­˜å™¨æ¶æ„ï¼ˆVGPR/SGPRï¼‰

## ğŸ“ ä½œä¸š

1. **å®éªŒæŠ¥å‘Š**ï¼šå®Œæˆä»»åŠ¡1-3ï¼Œæ’°å†™å®éªŒæŠ¥å‘Š
2. **ä»£ç æ”¹è¿›**ï¼šå®ç°ä¸€ä¸ªè‡ªé€‚åº”çš„å±•å¼€ç­–ç•¥ï¼ˆæ ¹æ®æ•°æ®å¤§å°é€‰æ‹©å±•å¼€å€æ•°ï¼‰
3. **æ€§èƒ½å¯¹æ¯”**ï¼šå¦‚æœæœ‰NVIDIA GPUï¼Œå¯¹æ¯”CUDAå’ŒHIPçš„æ€§èƒ½å·®å¼‚
4. **åˆ†äº«å­¦ä¹ **ï¼šåœ¨å›¢é˜Ÿå†…åˆ†äº«å¯„å­˜å™¨ä¼˜åŒ–çš„å­¦ä¹ å¿ƒå¾—

---

**ç¥å­¦ä¹ é¡ºåˆ©ï¼ğŸš€**

æœ‰é—®é¢˜ï¼ŸæŸ¥çœ‹ [HIPIFYå·¥å…·å­¦ä¹ è®¡åˆ’.md](../doc/compiler/HIPIFYå·¥å…·å­¦ä¹ è®¡åˆ’.md) ç¬¬E.1èŠ‚

