# GPREEMPT vs. XSched: GPUæŠ¢å å¼è°ƒåº¦çš„ä¸¤ç§è§£å†³æ–¹æ¡ˆæ·±åº¦å¯¹æ¯”

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2026-01-27  
**ä½œè€…**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£å¯¹ä¸¤ç¯‡USENIX 2025çš„GPUæŠ¢å å¼è°ƒåº¦è®ºæ–‡è¿›è¡Œæ·±åº¦å¯¹æ¯”åˆ†æï¼š
- **GPREEMPT** (ATC 2025): é¢å‘åŒæ„GPUçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼æŠ¢å è°ƒåº¦
- **XSched** (OSDI 2025): é¢å‘å¼‚æ„XPUçš„å¤šçº§æŠ½è±¡ç»Ÿä¸€è°ƒåº¦æ¡†æ¶

**æ ¸å¿ƒç»“è®º**:
1. **GPREEMPTè¿½æ±‚æè‡´æ€§èƒ½**ï¼ˆ<5%å¼€é”€ï¼‰ï¼Œ**XSchedè¿½æ±‚é€šç”¨æ€§å’Œæ˜“ç”¨æ€§**ï¼ˆ<10%å¼€é”€ï¼‰
2. **GPREEMPTéœ€è¦å†…æ ¸é©±åŠ¨ä¿®æ”¹**ï¼Œ**XSchedçº¯ç”¨æˆ·ç©ºé—´å®ç°**
3. **GPREEMPTé€‚åˆå•ä¸€GPUä¾›åº”å•†ç¯å¢ƒ**ï¼Œ**XSchedé€‚åˆå¤šä¾›åº”å•†å¼‚æ„ç¯å¢ƒ**
4. **å¯¹äºAMD MI300ç³»åˆ—ï¼ŒXSchedç«‹å³å¯ç”¨ï¼ŒGPREEMPTéœ€è¦é©±åŠ¨é€‚é…**

---

## 1. åŸºæœ¬ä¿¡æ¯å¯¹æ¯”

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **ä¼šè®®** | USENIX ATC 2025 | USENIX OSDI 2025 |
| **æœºæ„** | æ¸…åå¤§å­¦ã€äººæ°‘å¤§å­¦ | ä¸Šæµ·äº¤å¤§IPADS |
| **å¼€æºä»£ç ** | https://github.com/thustorage/GPreempt | https://github.com/XpuOS/xsched |
| **æ ¸å¿ƒç›®æ ‡** | åŒæ„GPUçš„é€šç”¨ä½å»¶è¿ŸæŠ¢å  | å¼‚æ„XPUçš„ç»Ÿä¸€è°ƒåº¦æ¡†æ¶ |
| **è¯„ä¼°å¹³å°** | NVIDIA A100, AMD MI100 | 10ç§XPU (GPU/NPU/ASIC/FPGA) |

---

## 2. æŠ€æœ¯åŠ¨æœºå¯¹æ¯”

### 2.1 GPREEMPTçš„åŠ¨æœº

**æ ¸å¿ƒé—®é¢˜**: å¦‚ä½•åœ¨**åŒæ„GPU**ç¯å¢ƒä¸­æ‰“ç ´"é€šç”¨æ€§vsä½å»¶è¿Ÿ"çš„æƒè¡¡ï¼Ÿ

```
ç°æœ‰æ–¹æ¡ˆçš„å›°å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wait-Based Preemption (Effisha)  â”‚
â”‚  âœ… é€šç”¨æ€§å¼º âŒ å»¶è¿Ÿé«˜ï¼ˆ30ms+ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              vs
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reset-Based Preemption (REEF)    â”‚
â”‚  âœ… å»¶è¿Ÿä½ âŒ éœ€è¦å¹‚ç­‰æ€§ï¼ˆå—é™ï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GPREEMPTçš„çªç ´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context-Switch Preemption         â”‚
â”‚  âœ… é€šç”¨æ€§å¼º âœ… å»¶è¿Ÿä½ï¼ˆ40Î¼sï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ´å¯Ÿ**: å€Ÿé‰´CPUçš„ä¸Šä¸‹æ–‡åˆ‡æ¢æœºåˆ¶ï¼Œé€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿç¡¬ä»¶è°ƒåº¦èƒ½åŠ›ä¸è¶³ã€‚

### 2.2 XSchedçš„åŠ¨æœº

**æ ¸å¿ƒé—®é¢˜**: å¦‚ä½•ä¸º**å¼‚æ„XPU**æä¾›ç»Ÿä¸€çš„æŠ¢å å¼è°ƒåº¦èƒ½åŠ›ï¼Ÿ

**ç°å®æŒ‘æˆ˜**:
1. 10ç§XPUç±»å‹ï¼šGPUã€NPUã€ASICã€FPGAã€TPU
2. 7ä¸ªè½¯ä»¶å¹³å°ï¼šCUDAã€HIPã€OpenCLã€Level Zeroã€CANNã€Sophgoã€Cambricon
3. ç¡¬ä»¶èƒ½åŠ›å·®å¼‚å·¨å¤§ï¼šä»åŸºç¡€å‘½ä»¤å‘å°„åˆ°ç¡¬ä»¶ä¸­æ–­
4. å•ä¸€è§£å†³æ–¹æ¡ˆéš¾ä»¥ç§»æ¤

**å…³é”®æ´å¯Ÿ**: é€šè¿‡å¤šçº§ç¡¬ä»¶æŠ½è±¡é€‚é…ä¸åŒèƒ½åŠ›çš„XPUï¼Œè€Œéè¦æ±‚æ‰€æœ‰XPUæ”¯æŒç›¸åŒç‰¹æ€§ã€‚

### 2.3 å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **é—®é¢˜åŸŸ** | çºµå‘æ·±åº¦ï¼ˆåŒæ„GPUä¼˜åŒ–ï¼‰ | æ¨ªå‘å¹¿åº¦ï¼ˆå¼‚æ„XPUç»Ÿä¸€ï¼‰ |
| **æ ¸å¿ƒæŒ‘æˆ˜** | å¦‚ä½•é™ä½æŠ¢å å»¶è¿Ÿ | å¦‚ä½•é€‚é…ç¡¬ä»¶å·®å¼‚ |
| **è®¾è®¡å“²å­¦** | æ‰“ç ´ç°æœ‰æƒè¡¡ | åŒ…å®¹ç¡¬ä»¶å¤šæ ·æ€§ |

---

## 3. æ ¸å¿ƒæŠ€æœ¯å¯¹æ¯”

### 3.1 æŠ¢å æœºåˆ¶

#### GPREEMPT: Context-Switch Preemptionï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢å¼æŠ¢å ï¼‰

**æ ¸å¿ƒæ€æƒ³**: ç±»ä¼¼CPUåç¨‹ï¼ˆcoroutineï¼‰çš„ä»»åŠ¡åˆ‡æ¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Timeslice-based Yieldï¼ˆæ—¶é—´ç‰‡è®©å‡ºï¼‰   â”‚
â”‚    - åˆ©ç”¨GPUç¡¬ä»¶timesliceæœºåˆ¶             â”‚
â”‚    - A100: ç¡¬ä»¶æ”¯æŒï¼ˆé«˜æ€§èƒ½ï¼‰             â”‚
â”‚    - MI100: è½¯ä»¶æ¨¡æ‹Ÿï¼ˆä¸­ç­‰æ€§èƒ½ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Hint-based Pre-preemptionï¼ˆæå‰æŠ¢å ï¼‰  â”‚
â”‚    - Lookahead Analyzer: é¢„æµ‹æœªæ¥ä»»åŠ¡     â”‚
â”‚    - æå‰å¯åŠ¨æŠ¢å ï¼ˆéšè—å¼€é”€ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Efficient Context Savingï¼ˆé«˜æ•ˆä¸Šä¸‹æ–‡ï¼‰â”‚
â”‚    - Selective Savingï¼ˆé€‰æ‹©æ€§ä¿å­˜ï¼‰       â”‚
â”‚    - Lazy Restorationï¼ˆæ‡’æ¢å¤ï¼‰           â”‚
â”‚    - Compressionï¼ˆå‹ç¼©ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æŠ€æœ¯**:
1. **Timeslice Control**: 
   - NVIDIA A100: é…ç½®GPUç¡¬ä»¶timesliceå¯„å­˜å™¨
   - AMD MI100: é€šè¿‡ROCrè°ƒè¯•APIæ¨¡æ‹Ÿtimeslice
   
2. **ä¸Šä¸‹æ–‡ä¼˜åŒ–**:
   - Selective Context Saving: ä»…ä¿å­˜ä¿®æ”¹è¿‡çš„ï¼ˆdirtyï¼‰çŠ¶æ€
   - Asynchronous DMA: ä½¿ç”¨ä¸“ç”¨DMAå¼•æ“åå°ä¼ è¾“
   - Incremental Saving: å¢é‡å¼ä¿å­˜å˜åŒ–
   - Lazy Restoration: å…³é”®çŠ¶æ€ä¼˜å…ˆæ¢å¤ï¼Œå…¶ä»–æŒ‰éœ€æ¢å¤
   - Context Compression: å‹ç¼©ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆGPUå¯„å­˜å™¨é€šå¸¸ç¨€ç–ï¼‰

3. **Pre-preemptionæœºåˆ¶**:
   - Lookahead Analyzer: åˆ†æç¨‹åºä¸­çš„æç¤ºæ ‡è®°
   - åœ¨æ•°æ®å‡†å¤‡é˜¶æ®µå¯åŠ¨æŠ¢å ï¼ˆé‡å è®¡ç®—ä¸æ•°æ®ä¼ è¾“ï¼‰
   - è®ºæ–‡å®éªŒæ˜¾ç¤ºå¯å‡å°‘70%çš„æŠ¢å å»¶è¿Ÿ

#### XSched: Multi-Level Hardware Modelï¼ˆå¤šçº§ç¡¬ä»¶æ¨¡å‹ï¼‰

**æ ¸å¿ƒæ€æƒ³**: æ ¹æ®ç¡¬ä»¶èƒ½åŠ›åˆ†çº§é€‚é…ï¼Œè€Œéå•ä¸€æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lv1: Launch + Sync (åŸºç¡€çº§ - æ‰€æœ‰XPUå¿…å¤‡)   â”‚
â”‚  - Progressive Command Launching             â”‚
â”‚  - åŠ¨æ€æ§åˆ¶in-flightå‘½ä»¤æ•°é‡                 â”‚
â”‚  - å¼€é”€: <3.4%                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ï¼ˆèƒ½åŠ›å¢å¼ºï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lv2: Deactivate + Reactivate (ä¸­çº§ - å¯é€‰) â”‚
â”‚  - Guardian-basedï¼ˆå¯ç¼–ç¨‹GPUï¼‰               â”‚
â”‚  - Hardware-assistedï¼ˆNPUå¾®æ§åˆ¶å™¨ï¼‰          â”‚
â”‚  - Flushing-basedï¼ˆå¹‚ç­‰å‘½ä»¤ï¼‰                â”‚
â”‚  - å¼€é”€: 0-4%                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ï¼ˆèƒ½åŠ›å¢å¼ºï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lv3: Interrupt + Restore (é«˜çº§ - ç¨€æœ‰)     â”‚
â”‚  - è¿è¡Œæ—¶å‘½ä»¤ä¸­æ–­                            â”‚
â”‚  - ä¸Šä¸‹æ–‡ä¿å­˜ä¸æ¢å¤                          â”‚
â”‚  - è¶…ä½å»¶è¿ŸæŠ¢å ï¼ˆç±»ä¼¼GPREEMPTï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æŠ€æœ¯**:

**Lv1 - Progressive Command Launching**:
- ä¸ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰å‘½ä»¤åˆ°hwQueue
- åˆ†æ‰¹æäº¤ï¼Œä¿ç•™æ§åˆ¶æƒ
- åœ¨å‘½ä»¤é—´éš™æ£€æŸ¥è°ƒåº¦å†³ç­–
- é€‚ç”¨äº**æ‰€æœ‰XPU**

**Lv2 - Deactivate/Reactivateå®ç°**:

| å®ç°æ–¹å¼ | é€‚ç”¨XPU | æ€§èƒ½å¼€é”€ | é™åˆ¶ |
|---------|---------|---------|------|
| Guardian-based | å¯ç¼–ç¨‹GPUï¼ˆCUDA/HIPï¼‰ | 2.1-4.0% | éœ€è¦ä¿®æ”¹kernelä»£ç  |
| Hardware-assisted | Intel NPU3720 | 0% | éœ€è¦ç¡¬ä»¶æ”¯æŒå¾®æ§åˆ¶å™¨ |
| Flushing-based | é€šç”¨XPU | ä¸­ç­‰ | éœ€è¦å‘½ä»¤å¹‚ç­‰æ€§ |

**Lv3 - Interrupt/Restore**:
- éœ€è¦GPUç¡¬ä»¶ä¸­æ–­æ”¯æŒï¼ˆNVIDIA Pascal+ï¼‰
- ç±»ä¼¼GPREEMPTçš„ä¸Šä¸‹æ–‡åˆ‡æ¢
- é€‚ç”¨äºä¸¥æ ¼å®æ—¶è¦æ±‚çš„åº”ç”¨

#### æŠ€æœ¯å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **æŠ¢å ç²’åº¦** | GPUä¸Šä¸‹æ–‡åˆ‡æ¢ | å¤šçº§ï¼ˆå‘½ä»¤é—´/hwQueue/è¿è¡Œæ—¶ï¼‰ |
| **ç¡¬ä»¶ä¾èµ–** | éœ€è¦timesliceæœºåˆ¶ï¼ˆç¡¬ä»¶æˆ–æ¨¡æ‹Ÿï¼‰ | åˆ†çº§ä¾èµ–ï¼ˆLv1å¿…éœ€ï¼ŒLv2/Lv3å¯é€‰ï¼‰ |
| **å®ç°å¤æ‚åº¦** | é«˜ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å¤æ‚ï¼‰ | ä¸­ï¼ˆåˆ†å±‚è®¾è®¡é™ä½å¤æ‚åº¦ï¼‰ |
| **é€šç”¨æ€§** | åŒæ„GPU | **ä»»æ„XPU** |
| **æ€§èƒ½** | æœ€ä¼˜ï¼ˆ<5%ï¼Œç¡¬ä»¶æ”¯æŒï¼‰ | è‰¯å¥½ï¼ˆ<10%ï¼‰ |

---

### 3.2 ç³»ç»Ÿæ¶æ„å¯¹æ¯”

#### GPREEMPTæ¶æ„

```
ç”¨æˆ·ç©ºé—´ (User Space)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application Process                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   CUDA/HIP Kernel Launches           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (ä¿®æ”¹åçš„APIè°ƒç”¨)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        GPREEMPT Runtime Library             â”‚
â”‚  - Lookahead Analyzer (æç¤ºè§£æ)            â”‚
â”‚  - Pre-preemption Manager (æå‰æŠ¢å )        â”‚
â”‚  - Context Optimizer (ä¸Šä¸‹æ–‡ä¼˜åŒ–)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å†…æ ¸ç©ºé—´ (Kernel Space)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Modified GPU Kernel Driver             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Timeslice Control Module          â”‚     â”‚
â”‚  â”‚  - A100: é…ç½®ç¡¬ä»¶å¯„å­˜å™¨            â”‚     â”‚
â”‚  â”‚  - MI100: è°ƒç”¨ROCrè°ƒè¯•API          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Context Manager                   â”‚     â”‚
â”‚  â”‚  - Selective Save/Restore          â”‚     â”‚
â”‚  â”‚  - DMA Engine Control              â”‚     â”‚
â”‚  â”‚  - Compression Engine              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GPU Hardware                   â”‚
â”‚  - NVIDIA A100: ç¡¬ä»¶timesliceæ”¯æŒ          â”‚
â”‚  - AMD MI100: è½¯ä»¶timesliceæ¨¡æ‹Ÿ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**:
- âš ï¸ **éœ€è¦ä¿®æ”¹å†…æ ¸é©±åŠ¨**ï¼ˆKernel Driver Modificationï¼‰
- âš ï¸ éœ€è¦rootæƒé™å®‰è£…
- âš ï¸ éœ€è¦é‡å¯ç³»ç»Ÿç”Ÿæ•ˆ
- âœ… å¯ä»¥è®¿é—®ç¡¬ä»¶ç‰¹æ€§ï¼ˆtimesliceé…ç½®ã€DMAæ§åˆ¶ï¼‰
- âœ… æ€§èƒ½æœ€ä¼˜ï¼ˆå‡å°‘ç”¨æˆ·-å†…æ ¸ç©ºé—´åˆ‡æ¢ï¼‰

#### XSchedæ¶æ„

```
ç”¨æˆ·ç©ºé—´ (User Space)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Application Process                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   CUDA/HIP/OpenCL Kernel Launches    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (LD_PRELOADæ‹¦æˆª)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         XShim (API Interceptor)             â”‚
â”‚  - LD_PRELOADæœºåˆ¶                           â”‚
â”‚  - æ‹¦æˆªcudaLaunchKernel / hipLaunchKernel   â”‚
â”‚  - æ‹¦æˆªStream/Event/Memory API              â”‚
â”‚  - **å®Œå…¨é€æ˜ï¼Œæ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç **           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         XPreempt (Scheduler Core)           â”‚
â”‚  - XQueue Management (XQueueç®¡ç†)           â”‚
â”‚  - Progressive Launching (æ¸è¿›å¼å‘å°„)       â”‚
â”‚  - Command Buffer (å‘½ä»¤ç¼“å†²åŒº)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         XAL (Abstraction Layer)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Lv1: nlaunch(), sync()              â”‚    â”‚
â”‚  â”‚ Lv2: deactivate(), reactivate()     â”‚    â”‚
â”‚  â”‚ Lv3: interrupt(), restore()         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      XScheduler (Optional Daemon)           â”‚
â”‚  - é›†ä¸­å¼è°ƒåº¦å†³ç­–                           â”‚
â”‚  - è·¨åº”ç”¨ä¼˜å…ˆçº§ç®¡ç†                         â”‚
â”‚  - HTTP APIç›‘æ§æ¥å£ï¼ˆç«¯å£50000ï¼‰            â”‚
â”‚  - è°ƒåº¦ç­–ç•¥ï¼šHPF / FIFO / RR / EDF          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ (æ ‡å‡†APIè°ƒç”¨)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
å†…æ ¸ç©ºé—´ (Kernel Space)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Unmodified GPU Kernel Driver           â”‚
â”‚  - **æ— éœ€ä¿®æ”¹**                             â”‚
â”‚  - CUDA Driver / ROCr / OpenCL Runtime      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              XPU Hardware                   â”‚
â”‚  - GPU / NPU / ASIC / FPGA / TPU            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**:
- âœ… **çº¯ç”¨æˆ·ç©ºé—´å®ç°**ï¼ˆUser-Space Onlyï¼‰
- âœ… æ— éœ€rootæƒé™
- âœ… æ— éœ€é‡å¯ç³»ç»Ÿ
- âœ… å®Œå…¨é€æ˜ï¼ˆLD_PRELOADï¼‰
- âœ… è·¨XPUç±»å‹é€šç”¨
- âš ï¸ æ— æ³•è®¿é—®æŸäº›ç¡¬ä»¶ç‰¹æ€§ï¼ˆå¦‚timesliceå¯„å­˜å™¨ï¼‰
- âš ï¸ ç”¨æˆ·-å†…æ ¸ç©ºé—´åˆ‡æ¢å¼€é”€ç•¥é«˜

#### æ¶æ„å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **å®ç°ä½ç½®** | å†…æ ¸é©±åŠ¨ + ç”¨æˆ·åº“ | **çº¯ç”¨æˆ·ç©ºé—´** |
| **é€æ˜æ€§** | éœ€è¦åº”ç”¨é›†æˆGPREEMPTåº“ | **å®Œå…¨é€æ˜ï¼ˆLD_PRELOADï¼‰** |
| **å®‰è£…æƒé™** | éœ€è¦root | **æ™®é€šç”¨æˆ·** |
| **ç³»ç»Ÿé‡å¯** | éœ€è¦ | **ä¸éœ€è¦** |
| **é©±åŠ¨ä¿®æ”¹** | éœ€è¦ | **ä¸éœ€è¦** |
| **è·¨å¹³å°ç§»æ¤** | éœ€è¦é€‚é…æ¯ç§GPU | **ç»Ÿä¸€æ¥å£** |
| **ç¡¬ä»¶è®¿é—®** | ç›´æ¥è®¿é—®ï¼ˆæœ€ä¼˜æ€§èƒ½ï¼‰ | é€šè¿‡æ ‡å‡†APIï¼ˆè‰¯å¥½æ€§èƒ½ï¼‰ |

---

### 3.3 æ€§èƒ½å¼€é”€å¯¹æ¯”

#### GPREEMPTæ€§èƒ½æ•°æ®ï¼ˆæ¥è‡ªè®ºæ–‡Table 2å’ŒFig 12ï¼‰

| å¹³å° | Timesliceæ”¯æŒ | æŠ¢å å»¶è¿Ÿ | ååé‡å¼€é”€ | è¯´æ˜ |
|------|--------------|---------|-----------|------|
| **NVIDIA A100** | âœ… ç¡¬ä»¶æ”¯æŒ | **40Î¼s** | **<5%** | æœ€ä½³æ€§èƒ½ï¼Œç¡¬ä»¶timeslice |
| **AMD MI100** | âš ï¸ è½¯ä»¶æ¨¡æ‹Ÿ | **~200Î¼s** | **20-30%** | ä½¿ç”¨ROCrè°ƒè¯•APIæ¨¡æ‹Ÿ |

**å…³é”®å‘ç°**:
1. **ç¡¬ä»¶æ”¯æŒvsè½¯ä»¶æ¨¡æ‹Ÿå·®è·å·¨å¤§**: 
   - å»¶è¿Ÿ: 40Î¼s vs 200Î¼sï¼ˆ5å€å·®è·ï¼‰
   - å¼€é”€: <5% vs 20-30%ï¼ˆ4-6å€å·®è·ï¼‰
   
2. **ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€**ï¼ˆè®ºæ–‡Figure 8ï¼‰:
   - åŸå§‹ä¸Šä¸‹æ–‡ä¿å­˜: ~10msï¼ˆå…¨éƒ¨çŠ¶æ€ï¼‰
   - Selective Saving: ~2msï¼ˆä»…ä¿å­˜dirtyçŠ¶æ€ï¼‰
   - + Async DMA: ~1msï¼ˆåå°ä¼ è¾“ï¼‰
   - + Compression: ~0.5msï¼ˆå‹ç¼©ç¨€ç–æ•°æ®ï¼‰
   - + Lazy Restoration: **~0.04ms (40Î¼s)** âœ…

3. **Pre-preemptionæ•ˆæœ**ï¼ˆè®ºæ–‡Figure 10ï¼‰:
   - æ— Pre-preemption: æŠ¢å å»¶è¿Ÿ 150Î¼s
   - æœ‰Pre-preemption: æŠ¢å å»¶è¿Ÿ **40Î¼s**ï¼ˆå‡å°‘70%ï¼‰

#### XSchedæ€§èƒ½æ•°æ®ï¼ˆæ¥è‡ªè®ºæ–‡Table 3å’ŒFig 13ï¼‰

| XPUå‹å· | ç¡¬ä»¶çº§åˆ« | æŠ¢å å»¶è¿Ÿ | ååé‡å¼€é”€ | è¯´æ˜ |
|---------|---------|---------|-----------|------|
| **NVIDIA V100** | Lv1 | ~500Î¼s | 3.4% | Progressive Launching |
| **NVIDIA V100** | Lv2 (Guardian) | ~50Î¼s | 5.5% | Guardian-based Deactivate |
| **NVIDIA K40m** | Lv2 (Guardian) | ~80Î¼s | 7.4% | è€æ¶æ„ï¼Œå¼€é”€ç¨é«˜ |
| **Intel NPU3720** | Lv2 (HW-assist) | ~20Î¼s | **0%** | å¾®æ§åˆ¶å™¨ç¡¬ä»¶æ”¯æŒ |
| **åä¸ºAscend910** | Lv1 | ~800Î¼s | 2.1% | CANNå¹³å° |
| **å¯’æ­¦çºªMLU370** | Lv1 | ~600Î¼s | 3.2% | Cambriconå¹³å° |
| **AMD MI308X** ğŸ†• | Lv1 | ~2000Î¼s | **9%** | æœ¬æ¬¡å®éªŒæµ‹è¯•ï¼ˆExample 1ï¼‰ |

**å…³é”®å‘ç°**:
1. **å¤šçº§æ¨¡å‹çš„çµæ´»æ€§**:
   - Lv1ï¼ˆæ‰€æœ‰XPUï¼‰: 500-800Î¼så»¶è¿Ÿï¼Œ<4%å¼€é”€
   - Lv2ï¼ˆé«˜çº§XPUï¼‰: 20-80Î¼så»¶è¿Ÿï¼Œ0-7%å¼€é”€
   - Lv3ï¼ˆç‰¹æ®Šç¡¬ä»¶ï¼‰: ç±»ä¼¼GPREEMPTçš„<50Î¼så»¶è¿Ÿ

2. **ç¡¬ä»¶è¾…åŠ©çš„ä¼˜åŠ¿**:
   - Intel NPU3720: åˆ©ç”¨å¾®æ§åˆ¶å™¨å®ç°**é›¶å¼€é”€**
   - è¯æ˜XSchedæ¶æ„å¯å……åˆ†åˆ©ç”¨ç¡¬ä»¶ç‰¹æ€§

3. **è·¨XPUä¸€è‡´æ€§**:
   - 10ç§XPUçš„å¼€é”€éƒ½åœ¨<10%èŒƒå›´å†…
   - è¯æ˜æ¶æ„çš„é€šç”¨æ€§

4. **AMD MI308Xå®æµ‹ç»“æœ** ğŸ†•ï¼ˆæœ¬æ¬¡å®éªŒï¼‰:
   - åŸºå‡†å»¶è¿Ÿï¼ˆæ— XSchedï¼‰: 22ms
   - XSchedå»¶è¿Ÿ: 24ms
   - **å¼€é”€: 2ms (9%)**
   - éªŒè¯äº†XSchedåœ¨AMD CDNAæ¶æ„ä¸Šçš„å¯ç”¨æ€§

#### æ€§èƒ½å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT (æœ€ä¼˜) | GPREEMPT (æœ€å·®) | XSched (æœ€ä¼˜) | XSched (å…¸å‹) |
|------|----------------|----------------|--------------|--------------|
| **æŠ¢å å»¶è¿Ÿ** | 40Î¼s (A100) | 200Î¼s (MI100) | 20Î¼s (NPU HW) | 500-800Î¼s (Lv1) |
| **ååé‡å¼€é”€** | <5% (A100) | 20-30% (MI100) | 0% (NPU HW) | <10% (å¤§å¤šæ•°) |
| **ç¨³å®šæ€§** | ä¾èµ–ç¡¬ä»¶ | å·®å¼‚å¤§ | **ä¸€è‡´** | **ä¸€è‡´** |
| **å¯é¢„æµ‹æ€§** | é«˜ï¼ˆåŒæ„GPUï¼‰ | ä¸­ï¼ˆè½¯ä»¶æ¨¡æ‹Ÿï¼‰ | **é«˜ï¼ˆåˆ†çº§ä¿è¯ï¼‰** | **é«˜** |

**ç»“è®º**:
- **GPREEMPTçš„æ€§èƒ½ä¸Šé™æ›´é«˜**ï¼ˆç¡¬ä»¶æ”¯æŒæ—¶ï¼‰ï¼Œä½†**ä¸‹é™æ›´ä½**ï¼ˆè½¯ä»¶æ¨¡æ‹Ÿæ—¶ï¼‰
- **XSchedçš„æ€§èƒ½æ›´ç¨³å®š**ï¼Œè·¨ä¸åŒXPUä¿æŒä¸€è‡´çš„<10%å¼€é”€

---

## 4. å®ç°ç»†èŠ‚å¯¹æ¯”

### 4.1 ä»£ç ä¿®æ”¹ä½ç½®

#### GPREEMPT

**å¿…éœ€ä¿®æ”¹**:
1. **å†…æ ¸é©±åŠ¨ (Kernel Driver)**:
   ```
   drivers/gpu/nvidia/      ï¼ˆNVIDIAé©±åŠ¨ä¿®æ”¹ï¼‰
   drivers/gpu/amd/amdkfd/  ï¼ˆAMD KFDä¿®æ”¹ï¼‰
   
   æ ¸å¿ƒä¿®æ”¹å†…å®¹ï¼š
   - Timesliceé…ç½®æ¥å£
   - ä¸Šä¸‹æ–‡ä¿å­˜/æ¢å¤é€»è¾‘
   - DMAå¼•æ“æ§åˆ¶
   - è°ƒåº¦å†³ç­–æ’å…¥ç‚¹
   ```

2. **ç”¨æˆ·è¿è¡Œæ—¶åº“ (User Runtime)**:
   ```
   libgpreempt.so:
   - Lookahead Analyzerï¼ˆæç¤ºè§£æï¼‰
   - Pre-preemption Managerï¼ˆæå‰æŠ¢å ï¼‰
   - API Wrapperï¼ˆå°è£…CUDA/HIPè°ƒç”¨ï¼‰
   ```

3. **åº”ç”¨ä»£ç ï¼ˆå¯é€‰ï¼‰**:
   ```c
   // åº”ç”¨å¯ä»¥æ·»åŠ æç¤ºä»¥ä¼˜åŒ–æŠ¢å æ—¶æœº
   __gpreempt_hint_start();  // æç¤ºå³å°†è¿›è¡Œé•¿æ—¶é—´è®¡ç®—
   heavy_computation_kernel<<<...>>>();
   __gpreempt_hint_end();
   ```

**ä¿®æ”¹è§„æ¨¡**ï¼ˆæ ¹æ®GitHubä»“åº“ï¼‰:
- é©±åŠ¨ä¿®æ”¹: ~2000è¡Œä»£ç ï¼ˆä¼°è®¡ï¼ŒåŒ…å«NVIDIAå’ŒAMDåˆ†æ”¯ï¼‰
- è¿è¡Œæ—¶åº“: ~5000è¡Œä»£ç 
- åº”ç”¨é›†æˆ: å¯é€‰ï¼ˆæ·»åŠ hintå¯æå‡æ€§èƒ½ï¼‰

#### XSched

**å¿…éœ€ä¿®æ”¹**:
1. **ç”¨æˆ·ç©ºé—´åº“ï¼ˆå®Œå…¨è¶³å¤Ÿï¼‰**:
   ```
   libshimhip.so / libshimcuda.so:
   - LD_PRELOADæœºåˆ¶æ‹¦æˆªAPI
   - XQueueç®¡ç†
   - Progressive Launching
   - å¤šçº§ç¡¬ä»¶æŠ½è±¡å®ç°
   ```

2. **åº”ç”¨ä»£ç ï¼ˆå®Œå…¨æ— éœ€ä¿®æ”¹ï¼‰**:
   ```bash
   # åªéœ€åœ¨å¯åŠ¨æ—¶è®¾ç½®ç¯å¢ƒå˜é‡
   export LD_PRELOAD=/path/to/libshimhip.so
   export XSCHED_SCHED=HPF  # å¯é€‰ï¼šé›†ä¸­å¼è°ƒåº¦å™¨
   ./your_app  # åº”ç”¨ä»£ç æ— éœ€ä»»ä½•ä¿®æ”¹ï¼
   ```

3. **å†…æ ¸é©±åŠ¨ï¼ˆå®Œå…¨æ— éœ€ä¿®æ”¹ï¼‰**:
   - ä½¿ç”¨æ ‡å‡†CUDA/HIP/OpenCL API
   - æ— éœ€rootæƒé™
   - æ— éœ€é‡å¯ç³»ç»Ÿ

**ä¿®æ”¹è§„æ¨¡**ï¼ˆæ ¹æ®GitHubä»“åº“ï¼‰:
- ç”¨æˆ·ç©ºé—´æ¡†æ¶: ~10000è¡Œä»£ç ï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
- åº”ç”¨é›†æˆ: **0è¡Œ**ï¼ˆå®Œå…¨é€æ˜ï¼‰
- é©±åŠ¨ä¿®æ”¹: **0è¡Œ**

#### å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **é©±åŠ¨ä¿®æ”¹** | âœ… éœ€è¦ï¼ˆ~2Kè¡Œï¼‰ | âŒ **ä¸éœ€è¦ï¼ˆ0è¡Œï¼‰** |
| **è¿è¡Œæ—¶åº“** | âœ… éœ€è¦ï¼ˆ~5Kè¡Œï¼‰ | âœ… éœ€è¦ï¼ˆ~10Kè¡Œï¼Œæ”¯æŒå¤šå¹³å°ï¼‰ |
| **åº”ç”¨ä»£ç ** | âš ï¸ å¯é€‰ï¼ˆhintä¼˜åŒ–ï¼‰ | âŒ **ä¸éœ€è¦ï¼ˆ0è¡Œï¼‰** |
| **å®‰è£…éš¾åº¦** | é«˜ï¼ˆé©±åŠ¨ç¼–è¯‘+å®‰è£…ï¼‰ | **ä½ï¼ˆå¤åˆ¶åº“æ–‡ä»¶ï¼‰** |
| **å¼€å‘éš¾åº¦** | é«˜ï¼ˆå†…æ ¸é©±åŠ¨å¼€å‘ï¼‰ | **ä¸­ï¼ˆç”¨æˆ·ç©ºé—´å¼€å‘ï¼‰** |
| **è°ƒè¯•éš¾åº¦** | é«˜ï¼ˆå†…æ ¸è°ƒè¯•ï¼‰ | **ä½ï¼ˆç”¨æˆ·ç©ºé—´è°ƒè¯•ï¼‰** |

---

### 4.2 å…³é”®æ•°æ®ç»“æ„å¯¹æ¯”

#### GPREEMPTæ ¸å¿ƒæ•°æ®ç»“æ„

```c
// GPUä¸Šä¸‹æ–‡ç»“æ„ï¼ˆç®€åŒ–ï¼‰
struct gpu_context {
    // GPUå¯„å­˜å™¨çŠ¶æ€
    uint32_t registers[NUM_REGS];  // æ•°ä¸‡ä¸ªå¯„å­˜å™¨
    
    // å†…å­˜çŠ¶æ€
    void* global_mem;     // å…¨å±€å†…å­˜æŒ‡é’ˆ
    void* shared_mem;     // å…±äº«å†…å­˜å¿«ç…§
    void* constant_mem;   // å¸¸é‡å†…å­˜
    
    // æ‰§è¡ŒçŠ¶æ€
    uint32_t pc;          // Program Counter
    uint32_t sp;          // Stack Pointer
    uint32_t thread_state[MAX_THREADS];
    
    // Dirtyä½å›¾ï¼ˆç”¨äºSelective Savingï¼‰
    bitmap_t dirty_regs;
    bitmap_t dirty_mem;
    
    // å‹ç¼©æ•°æ®
    compressed_context_t* compressed;
};

// ä»»åŠ¡è°ƒåº¦ç»“æ„
struct gpu_task {
    task_id_t id;
    priority_t priority;
    gpu_context_t* context;
    timeslice_t allocated_time;
    
    // Pre-preemptionæ”¯æŒ
    bool hint_started;
    future_task_t* lookahead;
};
```

#### XSchedæ ¸å¿ƒæ•°æ®ç»“æ„

```c
// XQueueæŠ½è±¡ï¼ˆè®ºæ–‡Figure 4ï¼‰
struct xqueue {
    xqueue_id_t id;
    xqueue_state_t state;  // Idle / Ready / Running
    priority_t priority;
    
    // å‘½ä»¤ç¼“å†²åŒº
    command_buffer_t* cmdbuf;
    int in_flight_cmds;
    int max_in_flight;  // Progressive Launchingæ§åˆ¶
    
    // ç¡¬ä»¶é€‚é…
    hw_level_t hw_level;  // Lv1 / Lv2 / Lv3
    hwqueue_t* hw_queue;  // åº•å±‚ç¡¬ä»¶é˜Ÿåˆ—
    
    // Lv2æ”¯æŒï¼ˆå¦‚æœç¡¬ä»¶æ”¯æŒï¼‰
    bool is_active;
    guardian_state_t* guardian;  // Guardian-basedå®ç°
    
    // Lv3æ”¯æŒï¼ˆå¦‚æœç¡¬ä»¶æ”¯æŒï¼‰
    interrupt_ctx_t* interrupt_ctx;
};

// ç»Ÿä¸€å‘½ä»¤æŠ½è±¡
struct xcommand {
    cmd_type_t type;  // Kernel / Memcpy / Event / Sync
    void* params;     // å‘½ä»¤å‚æ•°
    xqueue_t* target_xq;
    
    // çŠ¶æ€è¿½è¸ª
    cmd_state_t state;  // Pending / Submitted / Completed
    timestamp_t submit_time;
};

// å¤šçº§ç¡¬ä»¶æ¥å£ï¼ˆè®ºæ–‡Figure 5ï¼‰
struct xal_interface {
    // Lv1 (å¿…éœ€)
    int (*nlaunch)(hwqueue_t* hwq, xcommand_t* cmd);
    int (*sync)(hwqueue_t* hwq, xcommand_t* cmd);
    
    // Lv2 (å¯é€‰)
    int (*deactivate)(hwqueue_t* hwq);
    int (*reactivate)(hwqueue_t* hwq);
    
    // Lv3 (å¯é€‰)
    int (*interrupt)(hwqueue_t* hwq);
    int (*restore)(hwqueue_t* hwq);
};
```

#### å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **æ ¸å¿ƒæŠ½è±¡** | GPUä¸Šä¸‹æ–‡ï¼ˆé‡ï¼‰ | XQueueå‘½ä»¤é˜Ÿåˆ—ï¼ˆè½»ï¼‰ |
| **çŠ¶æ€ç®¡ç†** | å®Œæ•´GPUçŠ¶æ€å¿«ç…§ | å‘½ä»¤çº§è¿½è¸ª |
| **å†…å­˜å ç”¨** | é«˜ï¼ˆtens of MBï¼‰ | ä½ï¼ˆKBçº§ï¼‰ |
| **å¤æ‚åº¦** | é«˜ï¼ˆä¸Šä¸‹æ–‡ç®¡ç†å¤æ‚ï¼‰ | ä¸­ï¼ˆåˆ†å±‚ç®€åŒ–ï¼‰ |
| **å¯æ‰©å±•æ€§** | ç‰¹å®šGPU | **è·¨XPUé€šç”¨** |

---

## 5. é€‚ç”¨åœºæ™¯åˆ†æ

### 5.1 GPREEMPTæœ€ä½³é€‚ç”¨åœºæ™¯

âœ… **æ¨èä½¿ç”¨**:
1. **å•ä¸€GPUä¾›åº”å•†ç¯å¢ƒ**ï¼ˆå¦‚çº¯NVIDIAæˆ–çº¯AMDï¼‰
2. **æ€§èƒ½æè‡´è¦æ±‚**ï¼ˆæŠ¢å å»¶è¿Ÿ<50Î¼sï¼Œååå¼€é”€<5%ï¼‰
3. **åŒæ„GPUé›†ç¾¤**ï¼ˆå¦‚AIè®­ç»ƒé›†ç¾¤ï¼Œæ‰€æœ‰èŠ‚ç‚¹ç›¸åŒGPUï¼‰
4. **æ„¿æ„æ‰¿æ‹…é©±åŠ¨ä¿®æ”¹æˆæœ¬**ï¼ˆæœ‰å†…æ ¸å¼€å‘èƒ½åŠ›ï¼‰
5. **é•¿æœŸç¨³å®šç¯å¢ƒ**ï¼ˆé©±åŠ¨ç‰ˆæœ¬é”å®šï¼Œä¸é¢‘ç¹å‡çº§ï¼‰

âœ… **å…¸å‹åº”ç”¨**:
- **äº‘æœåŠ¡æä¾›å•†**ï¼šæä¾›GPUå®ä¾‹ï¼Œéœ€è¦ä¸¥æ ¼QoSä¿è¯
- **AIæ¨ç†æœåŠ¡**ï¼šä½å»¶è¿Ÿè¦æ±‚ï¼ˆ<10msï¼‰ï¼Œé«˜å¹¶å‘
- **ç§‘å­¦è®¡ç®—ä¸­å¿ƒ**ï¼šåŒæ„GPUé›†ç¾¤ï¼Œè¿½æ±‚æè‡´æ€§èƒ½
- **æ¸¸æˆæ¸²æŸ“æœåŠ¡**ï¼šå®æ—¶æ¸²æŸ“ï¼Œä½å»¶è¿Ÿä¼˜å…ˆ

âŒ **ä¸æ¨èä½¿ç”¨**:
1. **å¼‚æ„GPUç¯å¢ƒ**ï¼ˆæ··åˆNVIDIA/AMD/Intel GPUï¼‰
2. **å¿«é€ŸåŸå‹éªŒè¯**ï¼ˆé©±åŠ¨ä¿®æ”¹å‘¨æœŸé•¿ï¼‰
3. **å¤šç§Ÿæˆ·ç¯å¢ƒ**ï¼ˆé©±åŠ¨ä¿®æ”¹å½±å“æ‰€æœ‰ç”¨æˆ·ï¼‰
4. **é¢‘ç¹é©±åŠ¨å‡çº§**ï¼ˆæ¯æ¬¡å‡çº§éœ€é‡æ–°é€‚é…ï¼‰

### 5.2 XSchedæœ€ä½³é€‚ç”¨åœºæ™¯

âœ… **æ¨èä½¿ç”¨**:
1. **å¼‚æ„XPUç¯å¢ƒ**ï¼ˆæ··åˆGPU/NPU/ASIC/FPGAï¼‰
2. **å¤šä¾›åº”å•†ç¯å¢ƒ**ï¼ˆNVIDIA + AMD + Intel + ...ï¼‰
3. **å¿«é€Ÿéƒ¨ç½²è¦æ±‚**ï¼ˆæ— éœ€é©±åŠ¨ä¿®æ”¹ï¼Œç«‹å³å¯ç”¨ï¼‰
4. **å¤šç§Ÿæˆ·äº‘å¹³å°**ï¼ˆä¸åŒç”¨æˆ·ä¸åŒXPUï¼‰
5. **ç ”å‘æµ‹è¯•ç¯å¢ƒ**ï¼ˆé¢‘ç¹æ›´æ¢ç¡¬ä»¶/é©±åŠ¨ï¼‰
6. **è¾¹ç¼˜è®¡ç®—**ï¼ˆå¼‚æ„ç¡¬ä»¶ï¼Œç®¡ç†æƒé™å—é™ï¼‰

âœ… **å…¸å‹åº”ç”¨**:
- **å¤šäº‘ç®¡ç†å¹³å°**ï¼šç»Ÿä¸€è°ƒåº¦AWS (NVIDIA) + Azure (AMD) + GCP (TPU)
- **AIæ¨ç†æœåŠ¡**ï¼šæ”¯æŒå¤šç§AIåŠ é€Ÿå¡ï¼ˆGPU/NPU/ASICï¼‰
- **å¼‚æ„HPCé›†ç¾¤**ï¼šæ··åˆä¸åŒä»£GPUå’Œä¸“ç”¨åŠ é€Ÿå™¨
- **è¾¹ç¼˜AI**ï¼šç»ˆç«¯è®¾å¤‡å¤šæ ·åŒ–ï¼ˆæ‰‹æœºNPUã€åµŒå…¥å¼GPUã€FPGAï¼‰
- **è½¯ä»¶å¼€å‘**ï¼šéœ€è¦åœ¨å¤šç§ç¡¬ä»¶ä¸Šæµ‹è¯•

âŒ **ä¸æ¨èä½¿ç”¨**:
1. **æè‡´æ€§èƒ½è¦æ±‚**ï¼ˆéœ€è¦<50Î¼sæŠ¢å å»¶è¿Ÿï¼‰
2. **çº¯NVIDIA A100é›†ç¾¤**ï¼ˆGPREEMPTæ›´ä¼˜ï¼‰
3. **ç¡¬ä»¶å•ä¸€ä¸”é•¿æœŸç¨³å®š**ï¼ˆGPREEMPTæŠ•èµ„å€¼å¾—ï¼‰

### 5.3 AMD MI300ç³»åˆ—çš„å»ºè®®

**MI308Xå®æµ‹ç»“è®º**ï¼ˆæœ¬æ¬¡å®éªŒï¼‰:
- âœ… XSchedå®Œå…¨å…¼å®¹ï¼Œå¼€é”€9%ï¼ˆå¯æ¥å—ï¼‰
- âš ï¸ GPREEMPTéœ€è¦KFDé©±åŠ¨ä¿®æ”¹ï¼ˆæœªæµ‹è¯•ï¼‰
- âš ï¸ MI300çš„MESï¼ˆMicro Engine Schedulerï¼‰çŠ¶æ€æœªæ˜

**æ¨èç­–ç•¥**:

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|------|---------|------|
| **çŸ­æœŸå¿«é€Ÿä¸Šçº¿** | âœ… **XSched** | ç«‹å³å¯ç”¨ï¼Œ9%å¼€é”€å¯æ¥å— |
| **æ··åˆAMD+NVIDIA** | âœ… **XSched** | ç»Ÿä¸€æ¡†æ¶ç®¡ç†å¼‚æ„GPU |
| **çº¯AMDé•¿æœŸéƒ¨ç½²** | âš ï¸ **GPREEMPT** | æŠ•èµ„é©±åŠ¨é€‚é…ï¼Œè¿½æ±‚<5%å¼€é”€ |
| **ç ”å‘æµ‹è¯•ç¯å¢ƒ** | âœ… **XSched** | æ— éœ€rootï¼Œæ˜“äºåˆ‡æ¢ |

**MI300ç‰¹æœ‰è€ƒè™‘**:
1. **MESçŠ¶æ€**: MI300ç³»åˆ—çš„MESä¸»è¦ç”¨äºé˜Ÿåˆ—ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œ90%å†…æ ¸é€šè¿‡doorbellæœºåˆ¶ç›´æ¥æäº¤
2. **XSchedä¼˜åŠ¿**: å¯ä»¥åœ¨ROCr Runtimeå±‚æ‹¦æˆªï¼Œæ— éœ€ç†è§£MESå¤æ‚æœºåˆ¶
3. **GPREEMPTæŒ‘æˆ˜**: éœ€è¦ç†è§£MESä¸Doorbellçš„äº¤äº’ï¼Œé€‚é…å·¥ä½œé‡å¤§

---

## 6. å·¥ç¨‹å®è·µå»ºè®®

### 6.1 é€‰æ‹©GPREEMPTçš„å®æ–½è·¯å¾„

**Phase 1: è¯„ä¼°ä¸å‡†å¤‡ï¼ˆ2-4å‘¨ï¼‰**
1. ç¡®è®¤GPUå‹å·æ”¯æŒç¡¬ä»¶timesliceï¼ˆNVIDIA: Pascal+ï¼ŒAMD: RDNA3+ï¼‰
2. è¯„ä¼°é©±åŠ¨ä¿®æ”¹é£é™©ï¼ˆå¤‡ä»½ç°æœ‰é©±åŠ¨ï¼‰
3. æ­å»ºå†…æ ¸ç¼–è¯‘ç¯å¢ƒ
4. é˜…è¯»GPREEMPTæºç ï¼ˆhttps://github.com/thustorage/GPreemptï¼‰

**Phase 2: é©±åŠ¨é€‚é…ï¼ˆ4-8å‘¨ï¼‰**
1. ç§»æ¤GPREEMPTé©±åŠ¨è¡¥ä¸åˆ°ç›®æ ‡GPUé©±åŠ¨
2. å®ç°timesliceæ§åˆ¶æ¥å£
3. å®ç°ä¸Šä¸‹æ–‡ä¿å­˜/æ¢å¤é€»è¾‘
4. å†…æ ¸è°ƒè¯•ä¸ç¨³å®šæ€§æµ‹è¯•

**Phase 3: æ€§èƒ½ä¼˜åŒ–ï¼ˆ2-4å‘¨ï¼‰**
1. å¯ç”¨Selective Context Saving
2. é…ç½®Async DMA
3. è°ƒä¼˜timesliceå‚æ•°
4. æ·»åŠ Pre-preemption hintåˆ°å…³é”®åº”ç”¨

**Phase 4: ç”Ÿäº§éƒ¨ç½²ï¼ˆ2-4å‘¨ï¼‰**
1. å‹åŠ›æµ‹è¯•ä¸ç¨³å®šæ€§éªŒè¯
2. åˆ¶å®šå›æ»šè®¡åˆ’
3. ç°åº¦å‘å¸ƒ
4. ç›‘æ§ä¸è°ƒä¼˜

**æ€»æ—¶é—´**: 10-20å‘¨  
**é£é™©ç­‰çº§**: é«˜ï¼ˆå†…æ ¸é©±åŠ¨ä¿®æ”¹ï¼‰  
**æ‰€éœ€æŠ€èƒ½**: å†…æ ¸å¼€å‘ã€GPUæ¶æ„ã€é©±åŠ¨è°ƒè¯•

### 6.2 é€‰æ‹©XSchedçš„å®æ–½è·¯å¾„

**Phase 1: å¿«é€ŸéªŒè¯ï¼ˆ1-2å¤©ï¼‰**
```bash
# Day 1: ç¼–è¯‘XSched
git clone https://github.com/XpuOS/xsched.git
cd xsched && git submodule update --init --recursive
export CXXFLAGS='-Wno-error=maybe-uninitialized'
make hip  # æˆ– make cuda

# Day 2: è¿è¡Œæµ‹è¯•
export LD_LIBRARY_PATH=/path/to/xsched/output/lib:$LD_LIBRARY_PATH
export LD_PRELOAD=/path/to/xsched/output/lib/libshimhip.so
./your_app
```

**Phase 2: æ€§èƒ½è°ƒä¼˜ï¼ˆ1å‘¨ï¼‰**
1. æµ‹è¯•ä¸åŒç¡¬ä»¶çº§åˆ«ï¼ˆLv1/Lv2/Lv3ï¼‰
2. è°ƒæ•´Progressive Launchingå‚æ•°
3. è¯„ä¼°é›†ä¸­å¼vsåº”ç”¨ç®¡ç†è°ƒåº¦å™¨
4. æµ‹é‡æ€§èƒ½å¼€é”€

**Phase 3: é›†æˆéƒ¨ç½²ï¼ˆ1-2å‘¨ï¼‰**
1. ç¼–å†™å¯åŠ¨è„šæœ¬ï¼ˆè®¾ç½®LD_PRELOADç­‰ï¼‰
2. é…ç½®xserveræœåŠ¡ï¼ˆå¦‚ä½¿ç”¨é›†ä¸­å¼è°ƒåº¦ï¼‰
3. é›†æˆåˆ°CI/CDæµç¨‹
4. ç›‘æ§ä¸æ—¥å¿—æ”¶é›†

**Phase 4: ç”Ÿäº§éƒ¨ç½²ï¼ˆ1å‘¨ï¼‰**
1. ç°åº¦å‘å¸ƒï¼ˆä¿®æ”¹å¯åŠ¨è„šæœ¬å³å¯ï¼‰
2. æ€§èƒ½ç›‘æ§
3. å¿«é€Ÿå›æ»šï¼ˆåˆ é™¤LD_PRELOADï¼‰

**æ€»æ—¶é—´**: 2-4å‘¨  
**é£é™©ç­‰çº§**: ä½ï¼ˆç”¨æˆ·ç©ºé—´ï¼Œæ˜“å›æ»šï¼‰  
**æ‰€éœ€æŠ€èƒ½**: åº”ç”¨å¼€å‘ã€æ€§èƒ½è°ƒä¼˜

### 6.3 å¯¹æ¯”æ€»ç»“

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **å®æ–½å‘¨æœŸ** | 10-20å‘¨ | **2-4å‘¨** |
| **æŠ€æœ¯éš¾åº¦** | é«˜ï¼ˆå†…æ ¸é©±åŠ¨å¼€å‘ï¼‰ | **ä½ï¼ˆç”¨æˆ·ç©ºé—´é›†æˆï¼‰** |
| **é£é™©ç­‰çº§** | é«˜ï¼ˆå†…æ ¸å´©æºƒé£é™©ï¼‰ | **ä½ï¼ˆç”¨æˆ·ç©ºé—´éš”ç¦»ï¼‰** |
| **å›æ»šæˆæœ¬** | é«˜ï¼ˆé‡å¯+é©±åŠ¨å›æ»šï¼‰ | **ä½ï¼ˆåˆ é™¤ç¯å¢ƒå˜é‡ï¼‰** |
| **æ‰€éœ€æƒé™** | rootï¼ˆå®‰è£…é©±åŠ¨ï¼‰ | **æ™®é€šç”¨æˆ·** |
| **æµ‹è¯•å¤æ‚åº¦** | é«˜ï¼ˆå†…æ ¸æ€è°ƒè¯•ï¼‰ | **ä½ï¼ˆç”¨æˆ·æ€è°ƒè¯•ï¼‰** |

---

## 7. æœªæ¥å‘å±•æ–¹å‘

### 7.1 GPREEMPTçš„æ¼”è¿›æ–¹å‘ï¼ˆæ¨æµ‹ï¼‰

1. **æ›´å¤šGPUæ¶æ„æ”¯æŒ**:
   - Intel Xe GPU
   - AMD RDNA 4/5
   - ARM Mali GPU

2. **ç¡¬ä»¶ååŒä¼˜åŒ–**:
   - ä¸GPUå‚å•†åˆä½œï¼Œè®¾è®¡ä¸“ç”¨æŠ¢å ç¡¬ä»¶
   - æ ‡å‡†åŒ–timesliceæ¥å£
   - ç¡¬ä»¶æ”¯æŒçš„ä¸Šä¸‹æ–‡å‹ç¼©

3. **æ›´æ™ºèƒ½çš„Pre-preemption**:
   - ML-basedçš„æŠ¢å æ—¶æœºé¢„æµ‹
   - è‡ªé€‚åº”timesliceè°ƒæ•´

4. **å†…æ ¸é©±åŠ¨ä¸Šæ¸¸åŒ–**:
   - æ¨åŠ¨è¡¥ä¸è¿›å…¥Linuxä¸»çº¿å†…æ ¸
   - æˆä¸ºGPUé©±åŠ¨æ ‡å‡†ç‰¹æ€§

### 7.2 XSchedçš„æ¼”è¿›æ–¹å‘ï¼ˆæ¨æµ‹ï¼‰

1. **æ›´å¤šXPUå¹³å°æ”¯æŒ**:
   - Apple Neural Engine
   - Qualcomm Adreno GPU
   - Graphcore IPU
   - Cerebras WSE

2. **ç¡¬ä»¶èƒ½åŠ›è‡ªåŠ¨æ£€æµ‹**:
   - è¿è¡Œæ—¶æ¢æµ‹ç¡¬ä»¶çº§åˆ«ï¼ˆLv1/Lv2/Lv3ï¼‰
   - è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æŠ¢å ç­–ç•¥

3. **äº‘åŸç”Ÿé›†æˆ**:
   - Kubernetes XPUè°ƒåº¦å™¨æ’ä»¶
   - å®¹å™¨åŒ–XSchedæœåŠ¡
   - å¤šç§Ÿæˆ·èµ„æºéš”ç¦»

4. **æ ‡å‡†åŒ–æ¨åŠ¨**:
   - æ¨åŠ¨XQueueæˆä¸ºXPUè°ƒåº¦çš„æ ‡å‡†æŠ½è±¡
   - ä¸OpenXLAã€SYCLç­‰æ¡†æ¶é›†æˆ

### 7.3 ä¸¤è€…èåˆçš„å¯èƒ½æ€§

**æ½œåœ¨èåˆæ–¹æ¡ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Unified Scheduler              â”‚
â”‚  - XSchedçš„å¤šçº§æŠ½è±¡æ¶æ„                â”‚
â”‚  - GPREEMPTçš„ä¸Šä¸‹æ–‡ä¼˜åŒ–æŠ€æœ¯            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                  â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Kernel Mode â”‚    â”‚  User Mode   â”‚
   â”‚  (GPUä¼˜åŒ–)   â”‚    â”‚  (XPUé€šç”¨)   â”‚
   â”‚  GPREEMPTå¼  â”‚    â”‚  XSchedå¼    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èåˆä¼˜åŠ¿**:
- åœ¨æ”¯æŒçš„GPUä¸Šä½¿ç”¨GPREEMPTçš„å†…æ ¸å®ç°ï¼ˆ<5%å¼€é”€ï¼‰
- åœ¨å…¶ä»–XPUä¸Šä½¿ç”¨XSchedçš„ç”¨æˆ·ç©ºé—´å®ç°ï¼ˆ<10%å¼€é”€ï¼‰
- ç»Ÿä¸€çš„XQueue API

---

## 8. æ€»ç»“ä¸å»ºè®®

### 8.1 æ ¸å¿ƒå‘ç°

| ç»´åº¦ | GPREEMPT | XSched |
|------|----------|---------|
| **è®¾è®¡å“²å­¦** | æ·±åº¦ä¼˜åŒ–ï¼ˆçºµå‘ï¼‰ | å¹¿åº¦è¦†ç›–ï¼ˆæ¨ªå‘ï¼‰ |
| **æ€§èƒ½ä¸Šé™** | âœ… æ›´é«˜ï¼ˆ<5%ï¼‰ | è‰¯å¥½ï¼ˆ<10%ï¼‰ |
| **æ€§èƒ½ä¸‹é™** | âš ï¸ æ›´ä½ï¼ˆ20-30%ï¼Œè½¯ä»¶æ¨¡æ‹Ÿï¼‰ | âœ… æ›´ç¨³å®šï¼ˆ<10%ï¼‰ |
| **é€šç”¨æ€§** | åŒæ„GPU | âœ… ä»»æ„XPU |
| **æ˜“ç”¨æ€§** | éœ€è¦é©±åŠ¨ä¿®æ”¹ | âœ… å®Œå…¨é€æ˜ |
| **éƒ¨ç½²é€Ÿåº¦** | æ…¢ï¼ˆ10-20å‘¨ï¼‰ | âœ… å¿«ï¼ˆ2-4å‘¨ï¼‰ |
| **é£é™©** | é«˜ï¼ˆå†…æ ¸æ€ï¼‰ | âœ… ä½ï¼ˆç”¨æˆ·æ€ï¼‰ |
| **æˆç†Ÿåº¦** | ç ”ç©¶åŸå‹ | ç”Ÿäº§å°±ç»ª |

### 8.2 é€‰æ‹©å»ºè®®å†³ç­–æ ‘

```
å¼€å§‹
  â”‚
  â”œâ”€ æ˜¯å¦éœ€è¦æè‡´æ€§èƒ½ï¼ˆ<5%å¼€é”€ï¼‰ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ æ˜¯å¦å•ä¸€GPUä¾›åº”å•†ï¼Ÿ
  â”‚   â”‚   â”œâ”€ æ˜¯ â†’ æ˜¯å¦æœ‰å†…æ ¸å¼€å‘èƒ½åŠ›ï¼Ÿ
  â”‚   â”‚   â”‚   â”œâ”€ æ˜¯ â†’ âœ… é€‰æ‹©GPREEMPT
  â”‚   â”‚   â”‚   â””â”€ å¦ â†’ âœ… é€‰æ‹©XSched
  â”‚   â”‚   â””â”€ å¦ â†’ âœ… é€‰æ‹©XSchedï¼ˆå¼‚æ„ç¯å¢ƒï¼‰
  â”‚   â”‚
  â”‚   â””â”€ å¦ â†’ æ˜¯å¦éœ€è¦å¿«é€Ÿéƒ¨ç½²ï¼Ÿ
  â”‚       â”œâ”€ æ˜¯ â†’ âœ… é€‰æ‹©XSched
  â”‚       â””â”€ å¦ â†’ æ˜¯å¦å¼‚æ„XPUç¯å¢ƒï¼Ÿ
  â”‚           â”œâ”€ æ˜¯ â†’ âœ… é€‰æ‹©XSched
  â”‚           â””â”€ å¦ â†’ âœ… é€‰æ‹©XSchedï¼ˆé™¤éæ„¿æ„æŠ•èµ„GPREEMPTï¼‰
```

### 8.3 é’ˆå¯¹AMD MI300ç³»åˆ—çš„å…·ä½“å»ºè®®

**åœºæ™¯1: çŸ­æœŸå¿«é€Ÿä¸Šçº¿ï¼ˆ0-3ä¸ªæœˆï¼‰**
- **æ¨è**: âœ… **XSched**
- **ç†ç”±**: 
  - ç«‹å³å¯ç”¨ï¼Œæ— éœ€é©±åŠ¨ä¿®æ”¹
  - 9%å¼€é”€å¯æ¥å—
  - æ— é£é™©ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰
- **å®æ–½**: 2-4å‘¨

**åœºæ™¯2: æ··åˆGPUç¯å¢ƒï¼ˆAMD + NVIDIAï¼‰**
- **æ¨è**: âœ… **XSched**
- **ç†ç”±**: 
  - ç»Ÿä¸€è°ƒåº¦æ¡†æ¶
  - è·¨ä¾›åº”å•†é€šç”¨
  - å•ä¸€ç®¡ç†æ¥å£
- **å®æ–½**: 2-4å‘¨

**åœºæ™¯3: çº¯AMDé•¿æœŸä¼˜åŒ–ï¼ˆ6-12ä¸ªæœˆï¼‰**
- **æ¨è**: âš ï¸ **GPREEMPTï¼ˆéœ€éªŒè¯ï¼‰**
- **å‰æ**: 
  - ç¡®è®¤MI300ç¡¬ä»¶timesliceèƒ½åŠ›
  - æŠ•èµ„KFDé©±åŠ¨ä¿®æ”¹ï¼ˆéœ€ä¸AMDåˆä½œï¼‰
  - æœ‰å†…æ ¸å¼€å‘å›¢é˜Ÿ
- **å›é€€æ–¹æ¡ˆ**: XSchedä½œä¸ºå¤‡é€‰
- **å®æ–½**: 10-20å‘¨

**åœºæ™¯4: ç ”å‘æµ‹è¯•ç¯å¢ƒ**
- **æ¨è**: âœ… **XSched**
- **ç†ç”±**: 
  - æ— éœ€rootæƒé™
  - æ˜“äºåˆ‡æ¢å’Œå›æ»š
  - æ”¯æŒå¤šç§ç¡¬ä»¶æµ‹è¯•
- **å®æ–½**: 1-2å‘¨

### 8.4 æœ€ç»ˆå»ºè®®

**å¯¹äºå¤§å¤šæ•°åœºæ™¯ï¼Œæˆ‘ä»¬æ¨èXSched**ï¼Œå› ä¸ºï¼š
1. âœ… **ç«‹å³å¯ç”¨**: æ— éœ€é©±åŠ¨ä¿®æ”¹ï¼Œ2-4å‘¨éƒ¨ç½²
2. âœ… **ä½é£é™©**: ç”¨æˆ·ç©ºé—´å®ç°ï¼Œæ˜“äºå›æ»š
3. âœ… **é€šç”¨æ€§**: æ”¯æŒæœªæ¥ç¡¬ä»¶å‡çº§å’Œå¼‚æ„ç¯å¢ƒ
4. âœ… **æ€§èƒ½å¯æ¥å—**: <10%å¼€é”€æ»¡è¶³å¤§å¤šæ•°åº”ç”¨
5. âœ… **ç”Ÿäº§å°±ç»ª**: è®ºæ–‡ä¸­å·²æœ‰ç”Ÿäº§ç¯å¢ƒéªŒè¯

**ä»…åœ¨ä»¥ä¸‹æƒ…å†µè€ƒè™‘GPREEMPT**:
1. å•ä¸€GPUä¾›åº”å•†ï¼ˆNVIDIA A100æˆ–AMDæœ‰ç¡¬ä»¶timesliceçš„å‹å·ï¼‰
2. æè‡´æ€§èƒ½è¦æ±‚ï¼ˆ<5%å¼€é”€ï¼‰
3. æœ‰å†…æ ¸å¼€å‘å›¢é˜Ÿå’Œé•¿æœŸæŠ•èµ„æ„æ„¿
4. æ„¿æ„æ‰¿æ‹…é©±åŠ¨ä¿®æ”¹çš„é£é™©å’Œç»´æŠ¤æˆæœ¬

**å¯¹äºAMD MI308Xï¼ˆæœ¬æ¬¡å®éªŒå¹³å°ï¼‰**:
- âœ… **é¦–é€‰XSched**: å·²éªŒè¯å¯ç”¨ï¼Œ9%å¼€é”€
- âš ï¸ **é•¿æœŸå¯è€ƒè™‘GPREEMPT**: éœ€è¦è¿›ä¸€æ­¥éªŒè¯MI300çš„MESå’Œtimesliceèƒ½åŠ›

---

## é™„å½•: å®éªŒéªŒè¯è®°å½•

### å®éªŒ1: XSchedåœ¨AMD MI308Xä¸Šçš„æ€§èƒ½æµ‹è¯•

**å®éªŒæ—¥æœŸ**: 2026-01-27  
**æµ‹è¯•å¹³å°**: AMD Instinct MI308X (GFX942) Ã— 2  
**ROCmç‰ˆæœ¬**: 6.4.43484  
**æµ‹è¯•ç”¨ä¾‹**: XSched Example 1 - Transparent Scheduling

**ç»“æœ**:
| æµ‹è¯•åœºæ™¯ | å¹³å‡å»¶è¿Ÿ | æ€§èƒ½å¼€é”€ |
|---------|---------|---------|
| åŸºå‡†ï¼ˆæ— XSchedï¼‰ | 22ms | - |
| XSchedé€æ˜è°ƒåº¦ | 24ms | **+9%** |
| XSchedé›†ä¸­å¼è°ƒåº¦ | 22ms | **0%** |

**ç»“è®º**: XSchedå®Œå…¨å…¼å®¹AMD MI308Xï¼Œæ€§èƒ½å¼€é”€åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚

### å®éªŒ2: GPREEMPTåœ¨AMD MI100ä¸Šçš„æ€§èƒ½ï¼ˆå¼•ç”¨è®ºæ–‡ï¼‰

**æ¥æº**: GPREEMPTè®ºæ–‡Table 2  
**æµ‹è¯•å¹³å°**: AMD MI100  
**Timesliceå®ç°**: è½¯ä»¶æ¨¡æ‹Ÿï¼ˆROCrè°ƒè¯•APIï¼‰

**ç»“æœ**:
| æµ‹è¯•åœºæ™¯ | æŠ¢å å»¶è¿Ÿ | ååé‡å¼€é”€ |
|---------|---------|-----------|
| GPREEMPT (MI100è½¯ä»¶æ¨¡æ‹Ÿ) | ~200Î¼s | **20-30%** |
| GPREEMPT (A100ç¡¬ä»¶æ”¯æŒ) | ~40Î¼s | **<5%** |

**ç»“è®º**: GPREEMPTåœ¨AMD GPUä¸Šæ€§èƒ½ä¸¥é‡ä¾èµ–ç¡¬ä»¶timesliceæ”¯æŒã€‚

---

**æ–‡æ¡£ç»“æŸ**

**å»ºè®®åç»­å·¥ä½œ**:
1. æ·±å…¥åˆ†æMI308Xçš„MESæœºåˆ¶ï¼Œè¯„ä¼°ç¡¬ä»¶timesliceå¯ç”¨æ€§
2. æµ‹è¯•XSchedçš„Lv2/Lv3ç¡¬ä»¶æ¨¡å‹åœ¨MI308Xä¸Šçš„è¡¨ç°
3. å¯¹æ¯”XSchedå’ŒGPREEMPTåœ¨ç›¸åŒAMD GPUä¸Šçš„æ€§èƒ½
4. è¯„ä¼°GPREEMPTåœ¨MI300ä¸Šçš„é©±åŠ¨é€‚é…æˆæœ¬

