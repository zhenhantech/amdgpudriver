# CWSR ä»£ç å¤æ‚åº¦ä¸ Userspace å¯è¡Œæ€§åˆ†æ

**æ–‡æ¡£**: ARCH_Design_03  
**æ—¥æœŸ**: 2026-01-28  
**ç›®çš„**: åˆ†æ CWSR æŠ¢å æœºåˆ¶çš„ä»£ç å¤æ‚åº¦ï¼Œè¯„ä¼° userspace å®ç°çš„å¯è¡Œæ€§  
**å‰ç½®æ–‡æ¡£**: ARCH_Design_01, ARCH_Design_02

---

## ğŸ“Œ æ ¸å¿ƒé—®é¢˜

**ç”¨æˆ·çš„å…³é”®ç–‘é—®**:
> CWSR æŠ¢å æ—¶çš„ä»£ç é€»è¾‘ï¼Œæ˜¯ç®€å•çš„å†™å‡ ä¸ªå¯„å­˜å™¨ï¼Ÿè¿˜æ˜¯æœ‰å¾ˆå¤æ‚çš„è½¯ä»¶é€»è¾‘ï¼Ÿ  
> å¦‚æœæ˜¯å‰è€…ï¼Œæˆ‘ä»¬ä¹Ÿè®¸å¯ä»¥æŠŠæŸäº›å†…å®¹æ”¾åˆ° userspaceã€‚

**ç®€çŸ­å›ç­”**: 
```
âœ… æ˜¯çš„ï¼CWSR çš„è½¯ä»¶é€»è¾‘éå¸¸ç®€å•ï¼ˆ2-3 ä¸ª memcpy + å‡ ä¸ªå­—æ®µèµ‹å€¼ï¼‰
âœ… å¤æ‚çš„å·¥ä½œåœ¨ GPU ç¡¬ä»¶å±‚é¢ï¼ˆTrap Handler æ±‡ç¼–ä»£ç ï¼‰
âš ï¸ ç†è®ºä¸Šå¯ä»¥æ”¾åˆ° userspaceï¼Œä½†æœ‰æƒé™å’Œå®‰å…¨é—®é¢˜
```

---

## ğŸ” CWSR æ ¸å¿ƒ API ä»£ç åˆ†æ

### 1. `checkpoint_mqd()` - ä¿å­˜é˜Ÿåˆ—çŠ¶æ€

**ä»£ç ä½ç½®**: `kfd_mqd_manager_v9.c:436-446`

```c
static void checkpoint_mqd(struct mqd_manager *mm, void *mqd, 
                          void *mqd_dst, void *ctl_stack_dst)
{
    struct v9_mqd *m;
    
    // â­ è®¡ç®—æ§åˆ¶æ ˆåœ°å€ï¼ˆMQDåé¢ä¸€é¡µï¼‰
    void *ctl_stack = (void *)((uintptr_t)mqd + PAGE_SIZE);
    
    m = get_mqd(mqd);
    
    // â­â­â­ è¿™å°±æ˜¯å…¨éƒ¨çš„å·¥ä½œï¼åªæœ‰ 2 ä¸ª memcpy
    
    // 1ï¸âƒ£ ä¿å­˜ MQD æœ¬èº«ï¼ˆé˜Ÿåˆ—å…ƒæ•°æ®ï¼‰
    memcpy(mqd_dst, m, sizeof(struct v9_mqd));
    
    // 2ï¸âƒ£ ä¿å­˜æ§åˆ¶æ ˆï¼ˆåŒ…å« wave çŠ¶æ€ï¼‰
    memcpy(ctl_stack_dst, ctl_stack, m->cp_hqd_cntl_stack_size);
}
```

**å¤æ‚åº¦åˆ†æ**:
```
è¡Œæ•°: ~10 è¡Œ
æ“ä½œ: 2 ä¸ª memcpy
æ—¶é—´: O(n)ï¼Œn æ˜¯ MQD + æ§åˆ¶æ ˆçš„å¤§å°ï¼ˆå‡ å KBï¼‰
éš¾åº¦: â­â˜†â˜†â˜†â˜† (æç®€å•)
```

**ç»“è®º**: âœ… **æå…¶ç®€å•ï¼Œåªæ˜¯å†…å­˜æ‹·è´**

---

### 2. `restore_mqd()` - æ¢å¤é˜Ÿåˆ—çŠ¶æ€

**ä»£ç ä½ç½®**: `kfd_mqd_manager_v9.c:448-489`

```c
static void restore_mqd(struct mqd_manager *mm, void **mqd,
                       struct kfd_mem_obj *mqd_mem_obj, uint64_t *gart_addr,
                       struct queue_properties *qp,
                       const void *mqd_src,
                       const void *ctl_stack_src, u32 ctl_stack_size)
{
    uint64_t addr;
    struct v9_mqd *m;
    void *ctl_stack;
    
    m = (struct v9_mqd *) mqd_mem_obj->cpu_ptr;
    addr = mqd_mem_obj->gpu_addr;
    
    // â­ æ­¥éª¤ 1: æ¢å¤æ§åˆ¶æ ˆï¼ˆ1 ä¸ª memcpyï¼‰
    ctl_stack = (void *)((uintptr_t)m + PAGE_SIZE);
    memcpy(ctl_stack, ctl_stack_src, ctl_stack_size);
    
    // â­ æ­¥éª¤ 2: æ›´æ–° MQD å­—æ®µï¼ˆç®€å•çš„èµ‹å€¼æ“ä½œï¼‰
    m->cp_hqd_pq_control = qp->pq_control;
    m->cp_hqd_pq_base = qp->queue_address >> 8;
    m->cp_hqd_pq_rptr_report_addr = qp->read_ptr_address >> 8;
    m->cp_hqd_pq_wptr_poll_addr = qp->write_ptr_address >> 2;
    m->cp_hqd_pq_doorbell_control = qp->doorbell_off << 2;
    m->cp_hqd_vmid = qp->vmid;
    
    // â­ æ­¥éª¤ 3: æ›´æ–° CWSR ç›¸å…³åœ°å€
    m->cp_hqd_cntl_stack_offset = qp->ctl_stack_size;
    m->cp_hqd_cntl_stack_size = ctl_stack_size;
    m->cp_hqd_ctx_save_base = qp->ctx_save_restore_area_address >> 8;
    m->cp_hqd_ctx_save_size = qp->ctx_save_restore_area_size >> 8;
    
    // â­ æ­¥éª¤ 4: æ ‡è®°é˜Ÿåˆ—ä¸ºæ´»åŠ¨
    m->cp_hqd_active = 1;
    
    *mqd = m;
    *gart_addr = addr;
}
```

**å¤æ‚åº¦åˆ†æ**:
```
è¡Œæ•°: ~40 è¡Œ
æ“ä½œ: 1 ä¸ª memcpy + çº¦ 15 ä¸ªå­—æ®µèµ‹å€¼
æ—¶é—´: O(n)ï¼Œn æ˜¯æ§åˆ¶æ ˆå¤§å°ï¼ˆå‡  KBï¼‰
éš¾åº¦: â­â­â˜†â˜†â˜† (ç®€å•)
```

**ç»“è®º**: âœ… **ä»ç„¶å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯ memcpy å’Œå­—æ®µèµ‹å€¼**

---

### 3. `destroy_mqd()` - è§¦å‘ç¡¬ä»¶æŠ¢å 

**ä»£ç ä½ç½®**: `kfd_mqd_manager_v9.c:destroy_mqd()`ï¼ˆç®€åŒ–ç‰ˆï¼‰

```c
static int destroy_mqd(struct mqd_manager *mm, void *mqd,
                      enum kfd_preempt_type type,
                      unsigned int timeout, uint32_t pipe_id,
                      uint32_t queue_id)
{
    struct v9_mqd *m = get_mqd(mqd);
    struct kfd_node *dev = mm->dev;
    
    // â­â­â­ æ ¸å¿ƒå·¥ä½œï¼šå†™ GPU å¯„å­˜å™¨ï¼Œå‘Šè¯‰ç¡¬ä»¶å¼€å§‹æŠ¢å 
    
    switch (type) {
    case KFD_PREEMPT_TYPE_WAVEFRONT_DRAIN:
        // ç­‰å¾… wave è‡ªç„¶å®Œæˆï¼ˆæ…¢ï¼Œä¸ä¿å­˜çŠ¶æ€ï¼‰
        return kfd_hqd_drain(...);
        
    case KFD_PREEMPT_TYPE_WAVEFRONT_RESET:
        // ç«‹å³åœæ­¢ waveï¼ˆå¿«ï¼Œä½†ä¸¢å¤±çŠ¶æ€ï¼‰
        return kfd_hqd_reset(...);
        
    case KFD_PREEMPT_TYPE_WAVEFRONT_SAVE:
        // â­ è§¦å‘ CWSR ç¡¬ä»¶ä¿å­˜æœºåˆ¶
        // å®é™…ä¸Šå°±æ˜¯å†™å‡ ä¸ª GPU å¯„å­˜å™¨
        return kfd_hqd_save_and_unmap(...);
    }
}
```

**`kfd_hqd_save_and_unmap()` çš„å®ç°**ï¼ˆä¼ªä»£ç ï¼‰:

```c
static int kfd_hqd_save_and_unmap(struct kfd_node *dev,
                                  uint32_t pipe_id,
                                  uint32_t queue_id)
{
    uint32_t reg_offset = ...;
    
    // â­â­â­ è¿™å°±æ˜¯å…¨éƒ¨å·¥ä½œï¼šå†™å‡ ä¸ªå¯„å­˜å™¨
    
    // 1ï¸âƒ£ å†™ CP_HQD_DEQUEUE_REQUEST å¯„å­˜å™¨
    //    å‘Šè¯‰ GPU: "è¯·ä¿å­˜å¹¶åœæ­¢è¿™ä¸ªé˜Ÿåˆ—"
    WREG32(reg_offset + CP_HQD_DEQUEUE_REQUEST, 
           DEQUEUE_REQUEST_PREEMPT_SAVE_CWSR);
    
    // 2ï¸âƒ£ ç­‰å¾…ç¡¬ä»¶å®Œæˆï¼ˆè½®è¯¢çŠ¶æ€å¯„å­˜å™¨ï¼‰
    for (i = 0; i < timeout; i++) {
        uint32_t status = RREG32(reg_offset + CP_HQD_ACTIVE);
        if (!(status & HQD_ACTIVE_BIT)) {
            return 0;  // âœ… æˆåŠŸ
        }
        usleep(1000);  // ç­‰å¾… 1ms
    }
    
    return -ETIME;  // âŒ è¶…æ—¶
}
```

**å¤æ‚åº¦åˆ†æ**:
```
è¡Œæ•°: ~20 è¡Œ
æ“ä½œ: å†™ 1-2 ä¸ª GPU å¯„å­˜å™¨ + è½®è¯¢ç­‰å¾…
æ—¶é—´: O(timeout)ï¼Œé€šå¸¸ 1-10ms
éš¾åº¦: â­â­â˜†â˜†â˜† (ç®€å•ï¼Œä¸»è¦æ˜¯å¯„å­˜å™¨æ“ä½œ)
```

**ç»“è®º**: âœ… **ä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦æ˜¯å†™å¯„å­˜å™¨å’Œç­‰å¾…**

---

## ğŸ¯ å¤æ‚åº¦æ€»ç»“

### è½¯ä»¶å±‚é¢ï¼ˆKFD é©±åŠ¨ï¼‰

| API | ä»£ç è¡Œæ•° | ä¸»è¦æ“ä½œ | å¤æ‚åº¦ |
|-----|---------|---------|--------|
| `checkpoint_mqd()` | ~10 è¡Œ | 2 ä¸ª memcpy | â­â˜†â˜†â˜†â˜† |
| `restore_mqd()` | ~40 è¡Œ | 1 ä¸ª memcpy + å­—æ®µèµ‹å€¼ | â­â­â˜†â˜†â˜† |
| `destroy_mqd()` | ~20 è¡Œ | å†™å¯„å­˜å™¨ + è½®è¯¢ | â­â­â˜†â˜†â˜† |
| **æ€»è®¡** | **~70 è¡Œ** | **ç®€å•å†…å­˜å’Œ I/O æ“ä½œ** | **â­â­â˜†â˜†â˜†** |

**å…³é”®å‘ç°**: 
```
âœ… è½¯ä»¶é€»è¾‘æå…¶ç®€å•
âœ… æ²¡æœ‰å¤æ‚çš„ç®—æ³•
âœ… æ²¡æœ‰å¤æ‚çš„çŠ¶æ€æœº
âœ… ä¸»è¦æ˜¯ memcpy å’Œå¯„å­˜å™¨è¯»å†™
```

---

### ç¡¬ä»¶å±‚é¢ï¼ˆGPU Firmwareï¼‰

**è¿™æ‰æ˜¯å¤æ‚çš„åœ°æ–¹ï¼**

```
GPU Trap Handler (æ±‡ç¼–ä»£ç ):
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ–‡ä»¶: cwsr_trap_handler_gfx9.asm (MI300)
å¤§å°: ~2000 è¡Œæ±‡ç¼–ä»£ç  âš ï¸

ä¸»è¦å·¥ä½œ:
â”œâ”€â”€ L_SAVE_HWREG:          ä¿å­˜ç¡¬ä»¶å¯„å­˜å™¨ï¼ˆPC, STATUS ç­‰ï¼‰
â”œâ”€â”€ L_SAVE_SGPR_LOOP:      ä¿å­˜æ ‡é‡å¯„å­˜å™¨ï¼ˆ128 ä¸ª SGPRï¼‰
â”œâ”€â”€ L_SAVE_FIRST_VGPRS:    ä¿å­˜å‘é‡å¯„å­˜å™¨ï¼ˆ256 ä¸ª VGPRï¼‰
â”œâ”€â”€ L_SAVE_LDS:            ä¿å­˜ Local Data Shareï¼ˆ64KBï¼‰
â”‚   â”œâ”€â”€ L_SAVE_LDS_LOOP_SQC:   ä½¿ç”¨ SQC ä¿å­˜
â”‚   â””â”€â”€ L_SAVE_LDS_LOOP_VECTOR: ä½¿ç”¨å‘é‡æŒ‡ä»¤ä¿å­˜
â”œâ”€â”€ L_SAVE_VGPR:           ä¿å­˜å‰©ä½™ VGPRs
â””â”€â”€ L_SAVE_ACCVGPR:        ä¿å­˜ç´¯åŠ å™¨ï¼ˆGFX9.1+ï¼‰

å¤æ‚åº¦: â­â­â­â­â­ (æå…¶å¤æ‚)
å»¶è¿Ÿ: 1-10Î¼sï¼ˆç¡¬ä»¶ä¼˜åŒ–ï¼‰
```

**å…³é”®ç†è§£**:
```
è½¯ä»¶å±‚é¢ (KFD):
  â€¢ åªæ˜¯è§¦å‘æœºåˆ¶
  â€¢ å†™å¯„å­˜å™¨å‘Šè¯‰ GPU "å¼€å§‹ä¿å­˜"
  â€¢ ~70 è¡Œç®€å•ä»£ç 

ç¡¬ä»¶å±‚é¢ (GPU Firmware):
  â€¢ å®é™…æ‰§è¡Œä¿å­˜/æ¢å¤
  â€¢ ~2000 è¡Œæ±‡ç¼–ä»£ç 
  â€¢ åœ¨ GPU ä¸Šè¿è¡Œï¼Œå¯¹è½¯ä»¶é€æ˜
  â€¢ ç¡¬ä»¶ä¼˜åŒ–ï¼Œé€Ÿåº¦æå¿«ï¼ˆ1-10Î¼sï¼‰
```

---

## ğŸ¤” å¯ä»¥æ”¾åˆ° Userspace å—ï¼Ÿ

### æ–¹æ¡ˆ A: å®Œå…¨æ”¾åˆ° Userspace âŒ

```c
// å‡è®¾æˆ‘ä»¬åœ¨ userspace åš...
void userspace_preempt_queue(int queue_id) {
    // âŒ é—®é¢˜ 1: éœ€è¦è®¿é—®å†…æ ¸å†…å­˜
    struct v9_mqd *mqd = ...; // æ— æ³•è·å–ï¼mqd åœ¨å†…æ ¸ç©ºé—´
    
    // âŒ é—®é¢˜ 2: éœ€è¦å†™ GPU å¯„å­˜å™¨
    WREG32(CP_HQD_DEQUEUE_REQUEST, ...); // éœ€è¦ç‰¹æƒï¼
    
    // âŒ é—®é¢˜ 3: éœ€è¦ç®¡ç†å†…æ ¸èµ„æº
    checkpoint_mqd(...); // mqd, ctl_stack éƒ½åœ¨å†…æ ¸
}
```

**ç»“è®º**: âŒ **å®Œå…¨æ”¾åˆ° userspace ä¸å¯è¡Œ**

**åŸå› **:
1. âŒ **æ— æ³•è®¿é—®å†…æ ¸å†…å­˜**ï¼ˆMQD, æ§åˆ¶æ ˆï¼‰
2. âŒ **æ— æ³•å†™ GPU å¯„å­˜å™¨**ï¼ˆéœ€è¦ root/ç‰¹æƒï¼‰
3. âŒ **æ— æ³•ç®¡ç†å†…æ ¸èµ„æº**ï¼ˆé˜Ÿåˆ—çŠ¶æ€ã€å†…å­˜å¯¹è±¡ï¼‰
4. âŒ **å®‰å…¨é£é™©**ï¼ˆæ¶æ„ç¨‹åºå¯ä»¥æŠ¢å ä»»æ„é˜Ÿåˆ—ï¼‰

---

### æ–¹æ¡ˆ B: æ··åˆæ¨¡å¼ï¼ˆéƒ¨åˆ†åœ¨ Userspaceï¼‰âš ï¸

```c
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Userspace: åº”ç”¨å±‚é€»è¾‘
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void userspace_scheduler() {
    // âœ… å¯ä»¥åœ¨ userspace åš:
    // 1. è°ƒåº¦ç­–ç•¥å†³ç­–
    // 2. ä¼˜å…ˆçº§ç®¡ç†
    // 3. ç»Ÿè®¡å’Œç›‘æ§
    
    struct queue_priority priority_list[MAX_QUEUES];
    
    // æ£€æµ‹ä¼˜å…ˆçº§å€’ç½®
    if (high_priority_waiting && low_priority_running) {
        // âœ… å†³å®šæŠ¢å ï¼ˆç­–ç•¥å±‚ï¼‰
        int target_queue = find_queue_to_preempt();
        
        // â­ è°ƒç”¨å†…æ ¸æ¥å£ï¼ˆæ‰§è¡Œå±‚ï¼‰
        ioctl(kfd_fd, AMDKFD_IOC_PREEMPT_QUEUE, target_queue);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Kernel: æ‰§è¡Œå±‚ï¼ˆç‰¹æƒæ“ä½œï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

int kfd_ioctl_preempt_queue(int queue_id) {
    // â­ å†…æ ¸æ‰§è¡Œå®é™…çš„æŠ¢å æ“ä½œ
    struct queue *q = find_queue(queue_id);
    
    // 1. checkpoint_mqd() - å†…æ ¸å†…å­˜è®¿é—®
    // 2. destroy_mqd() - å†™ GPU å¯„å­˜å™¨
    // 3. çŠ¶æ€ç®¡ç† - å†…æ ¸èµ„æºç®¡ç†
    
    return kfd_queue_preempt_single(q, ...);
}
```

**ç»“è®º**: âš ï¸ **æ··åˆæ¨¡å¼æ˜¯å¯è¡Œçš„**

**ä¼˜åŠ¿**:
- âœ… **ç­–ç•¥å±‚åœ¨ userspace**ï¼ˆçµæ´»ã€å¯å®šåˆ¶ï¼‰
- âœ… **æ‰§è¡Œå±‚åœ¨ kernel**ï¼ˆå®‰å…¨ã€ç‰¹æƒï¼‰
- âœ… **é€šè¿‡ ioctl é€šä¿¡**ï¼ˆæ ‡å‡†æ¥å£ï¼‰
- âœ… **ä¿æŒç³»ç»Ÿå®‰å…¨æ€§**ï¼ˆå†…æ ¸éªŒè¯ï¼‰

**åŠ£åŠ¿**:
- âš ï¸ **ioctl æœ‰ç³»ç»Ÿè°ƒç”¨å¼€é”€**ï¼ˆ~1-5Î¼s per callï¼‰
- âš ï¸ **ç”¨æˆ·ç©ºé—´éœ€è¦è½®è¯¢æˆ–äº‹ä»¶é€šçŸ¥**
- âš ï¸ **è·¨è¶Šç”¨æˆ·/å†…æ ¸è¾¹ç•Œ**

---

### æ–¹æ¡ˆ C: å†…æ ¸æ€ç›‘æ§ + Userspace ç­–ç•¥ âœ… **æ¨è**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Userspace: ç­–ç•¥å¼•æ“ï¼ˆå¯é€‰ï¼‰                 â”‚
â”‚  â€¢ å¤æ‚è°ƒåº¦ç­–ç•¥ï¼ˆWeighted Fair, EDF ç­‰ï¼‰                â”‚
â”‚  â€¢ ç»Ÿè®¡å’Œç›‘æ§ç•Œé¢                                        â”‚
â”‚  â€¢ é€šè¿‡ ioctl é…ç½®å†…æ ¸è°ƒåº¦å™¨                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ ioctl (é…ç½®ï¼Œéå…³é”®è·¯å¾„)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Kernel: ç›‘æ§çº¿ç¨‹ + åŸºç¡€è°ƒåº¦å™¨ â­                 â”‚
â”‚  â€¢ 5ms å®šæœŸå”¤é†’                                          â”‚
â”‚  â€¢ ä¸»åŠ¨è½®è¯¢é˜Ÿåˆ—çŠ¶æ€ï¼ˆMMIO readï¼‰                        â”‚
â”‚  â€¢ æ£€æµ‹ä¼˜å…ˆçº§å€’ç½®                                        â”‚
â”‚  â€¢ ç«‹å³è§¦å‘ CWSRï¼ˆæ—  ioctlï¼ï¼‰                          â”‚
â”‚  â€¢ å®Œæˆå›è°ƒå’ŒçŠ¶æ€æ›´æ–°                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ ç›´æ¥è°ƒç”¨ï¼ˆ<1Î¼sï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           KFD CWSR APIsï¼ˆå†…æ ¸å‡½æ•°ï¼‰                      â”‚
â”‚  â€¢ checkpoint_mqd()                                      â”‚
â”‚  â€¢ destroy_mqd(WAVEFRONT_SAVE)                           â”‚
â”‚  â€¢ restore_mqd()                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ å†™å¯„å­˜å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GPU Hardware + Trap Handler                 â”‚
â”‚  â€¢ CWSR ç¡¬ä»¶æœºåˆ¶ï¼ˆ1-10Î¼sï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä¼˜åŠ¿**:
1. âœ… **ç›‘æ§åœ¨å†…æ ¸æ€**ï¼ˆæ—  ioctl å¼€é”€ï¼Œ<1Î¼s è§¦å‘ï¼‰
2. âœ… **ç­–ç•¥å¯åœ¨ userspace**ï¼ˆçµæ´»é…ç½®ï¼‰
3. âœ… **å…³é”®è·¯å¾„å…¨åœ¨å†…æ ¸**ï¼ˆä½å»¶è¿Ÿï¼‰
4. âœ… **å®‰å…¨æ€§æœ‰ä¿éšœ**ï¼ˆå†…æ ¸éªŒè¯æ‰€æœ‰æ“ä½œï¼‰

**è¿™æ­£æ˜¯ ARCH_Design_01 çš„è®¾è®¡ï¼**

---

## ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ

### 1. CWSR è½¯ä»¶å±‚é¢æå…¶ç®€å•

```
æ€»ä»£ç é‡: ~70 è¡Œ
ä¸»è¦æ“ä½œ:
  â€¢ 2-3 ä¸ª memcpy
  â€¢ å†™ 1-2 ä¸ª GPU å¯„å­˜å™¨
  â€¢ è½®è¯¢ç­‰å¾…å®Œæˆ

å¤æ‚åº¦: â­â­â˜†â˜†â˜†
```

### 2. å¤æ‚æ€§åœ¨ç¡¬ä»¶å±‚é¢

```
Trap Handler: ~2000 è¡Œæ±‡ç¼–
æ‰§è¡Œä½ç½®: GPU ç¡¬ä»¶
å¯¹è½¯ä»¶é€æ˜: æ˜¯
å»¶è¿Ÿ: 1-10Î¼sï¼ˆç¡¬ä»¶ä¼˜åŒ–ï¼‰

å¤æ‚åº¦: â­â­â­â­â­ï¼ˆä½†è½¯ä»¶ä¸éœ€è¦ç®¡ï¼‰
```

### 3. Userspace å®ç°çš„æƒè¡¡

| æ–¹æ¡ˆ | çµæ´»æ€§ | æ€§èƒ½ | å®‰å…¨æ€§ | å¯è¡Œæ€§ |
|------|--------|------|--------|--------|
| **å®Œå…¨ Userspace** | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | âŒ | âŒ ä¸å¯è¡Œ |
| **æ··åˆæ¨¡å¼** | â­â­â­â­â˜† | â­â­â­â˜†â˜† | âš ï¸ | âš ï¸ å¯è¡Œä½†æ…¢ |
| **å†…æ ¸ç›‘æ§** | â­â­â­â˜†â˜† | â­â­â­â­â­ | âœ… | âœ… **æ¨è** |

### 4. ä¸ºä»€ä¹ˆæ¨èå†…æ ¸ç›‘æ§ï¼Ÿ

```
æ•°æ®å¹³é¢ï¼ˆDoorbell æäº¤ï¼‰:
  â€¢ åº”ç”¨ â†’ GPU
  â€¢ ~100ns
  â€¢ å®Œå…¨åœ¨ userspace âœ…
  â€¢ ä¸èƒ½ç ´åï¼

æ§åˆ¶å¹³é¢ï¼ˆæŠ¢å è§¦å‘ï¼‰:
  â€¢ ç›‘æ§ â†’ CWSR
  â€¢ ~1-10Î¼s
  â€¢ åœ¨å†…æ ¸æ€æœ€ä¼˜ âœ…
  â€¢ 5ms æ£€æµ‹å»¶è¿Ÿå¯æ¥å—

å…³é”®åˆ†ç¦»:
  â€¢ æ•°æ®å¹³é¢: å¿«é€Ÿè·¯å¾„ï¼ˆuserspaceï¼‰
  â€¢ æ§åˆ¶å¹³é¢: è°ƒåº¦è·¯å¾„ï¼ˆkernelï¼‰
  â€¢ ä¸¤è€…ç‹¬ç«‹ï¼Œäº’ä¸å¹²æ‰° âœ…
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¸åŒæ–¹æ¡ˆçš„å»¶è¿Ÿåˆ†æ

| æ–¹æ¡ˆ | æ£€æµ‹å»¶è¿Ÿ | è§¦å‘å»¶è¿Ÿ | CWSR å»¶è¿Ÿ | æ€»å»¶è¿Ÿ |
|------|---------|---------|----------|--------|
| **Userspace è½®è¯¢** | 0-10ms | ~1-5Î¼s (ioctl) | 1-10Î¼s | **~15ms** âš ï¸ |
| **Userspace äº‹ä»¶** | ~1ms | ~1-5Î¼s (ioctl) | 1-10Î¼s | **~6ms** âš ï¸ |
| **Kernel è½®è¯¢** | 0-5ms | <1Î¼s (ç›´æ¥è°ƒç”¨) | 1-10Î¼s | **~5ms** âœ… |

**ç»“è®º**: å†…æ ¸ç›‘æ§æ–¹æ¡ˆå»¶è¿Ÿæœ€ä½

### ioctl å¼€é”€åˆ†æ

```c
// Userspace è°ƒç”¨ ioctl çš„å¼€é”€
int userspace_preempt() {
    // â­ ç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼š~1-5Î¼s
    ioctl(kfd_fd, AMDKFD_IOC_PREEMPT_QUEUE, &args);
    //    â†‘
    //    â€¢ ç”¨æˆ·æ€ â†’ å†…æ ¸æ€åˆ‡æ¢ (~500ns)
    //    â€¢ å‚æ•°æ‹·è´ (~100ns)
    //    â€¢ æƒé™æ£€æŸ¥ (~100ns)
    //    â€¢ å‡½æ•°è°ƒç”¨ (~100ns)
    //    â€¢ å†…æ ¸æ€ â†’ ç”¨æˆ·æ€åˆ‡æ¢ (~500ns)
    //    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //    æ€»è®¡: ~1-5Î¼s âš ï¸
}

// Kernel ç›´æ¥è°ƒç”¨çš„å¼€é”€
int kernel_preempt() {
    // â­ å‡½æ•°è°ƒç”¨å¼€é”€ï¼š<100ns
    kfd_queue_preempt_single(q, ...);
    //    â†‘
    //    â€¢ ç›´æ¥å‡½æ•°è°ƒç”¨ (~50ns)
    //    â€¢ æ— ä¸Šä¸‹æ–‡åˆ‡æ¢ âœ…
    //    â€¢ æ— å‚æ•°æ‹·è´ âœ…
    //    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //    æ€»è®¡: <100ns âœ…
}
```

**å·®è·**: 10-50Ã— å»¶è¿Ÿå·®å¼‚ï¼

---

## ğŸ“ ç»“è®ºä¸å»ºè®®

### æ ¸å¿ƒç»“è®º

1. **CWSR è½¯ä»¶é€»è¾‘æå…¶ç®€å•** âœ…
   - åªæœ‰ ~70 è¡Œä»£ç 
   - ä¸»è¦æ˜¯ memcpy å’Œå¯„å­˜å™¨æ“ä½œ
   - æ²¡æœ‰å¤æ‚ç®—æ³•

2. **å¤æ‚æ€§åœ¨ GPU ç¡¬ä»¶å±‚** âœ…
   - Trap Handler (~2000 è¡Œæ±‡ç¼–)
   - åœ¨ GPU ä¸Šæ‰§è¡Œï¼Œå¯¹è½¯ä»¶é€æ˜
   - å»¶è¿Ÿå¾ˆä½ï¼ˆ1-10Î¼sï¼‰

3. **å®Œå…¨ Userspace ä¸å¯è¡Œ** âŒ
   - æ— æ³•è®¿é—®å†…æ ¸å†…å­˜
   - æ— æ³•å†™ GPU å¯„å­˜å™¨
   - å®‰å…¨é£é™©å¤ªå¤§

4. **å†…æ ¸ç›‘æ§æ˜¯æœ€ä¼˜æ–¹æ¡ˆ** âœ…
   - ä½å»¶è¿Ÿï¼ˆæ—  ioctl å¼€é”€ï¼‰
   - é«˜å®‰å…¨æ€§ï¼ˆå†…æ ¸éªŒè¯ï¼‰
   - å¯é…ç½®ï¼ˆuserspace ç­–ç•¥ï¼‰

### å®æ–½å»ºè®®

```
æ¨èæ¶æ„ï¼ˆå·²åœ¨ ARCH_Design_01 ä¸­è®¾è®¡ï¼‰:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Userspace (å¯é€‰):                  â”‚
â”‚  â€¢ é«˜çº§è°ƒåº¦ç­–ç•¥                     â”‚
â”‚  â€¢ ç›‘æ§å’Œç»Ÿè®¡                       â”‚
â”‚  â€¢ é…ç½®æ¥å£                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ioctl (é…ç½®)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kernel Monitor (æ ¸å¿ƒ):             â”‚
â”‚  â€¢ 5ms å®šæœŸè½®è¯¢ â­                  â”‚
â”‚  â€¢ æ£€æµ‹ä¼˜å…ˆçº§å€’ç½®                   â”‚
â”‚  â€¢ ç›´æ¥è§¦å‘ CWSR (<1Î¼s) â­          â”‚
â”‚  â€¢ å®Œæˆå›è°ƒ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ å†…æ ¸å‡½æ•°è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KFD CWSR APIs:                     â”‚
â”‚  â€¢ checkpoint_mqd()                 â”‚
â”‚  â€¢ destroy_mqd()                    â”‚
â”‚  â€¢ restore_mqd()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ å†™å¯„å­˜å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GPU Hardware:                      â”‚
â”‚  â€¢ CWSR Trap Handler                â”‚
â”‚  â€¢ 1-10Î¼s å®Œæˆ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŒ–æ–¹å‘

å¦‚æœç¡®å®æƒ³å‡å°‘å†…æ ¸è´Ÿæ‹…ï¼š

1. **ç­–ç•¥å±‚åœ¨ userspace** âœ…
   - å¤æ‚è°ƒåº¦ç®—æ³•
   - ç»Ÿè®¡åˆ†æ
   - å¯è§†åŒ–ç›‘æ§

2. **æ‰§è¡Œå±‚åœ¨ kernel** âœ…
   - é˜Ÿåˆ—çŠ¶æ€ç›‘æ§
   - CWSR è§¦å‘
   - çŠ¶æ€ç®¡ç†

3. **é…ç½®é€šè¿‡ ioctl** âœ…
   - è®¾ç½®ä¼˜å…ˆçº§
   - é…ç½®æ—¶é—´ç‰‡
   - å¯ç”¨/ç¦ç”¨è°ƒåº¦å™¨

4. **å…³é”®è·¯å¾„åœ¨å†…æ ¸** âœ…
   - æ—  ioctl å¼€é”€
   - ä½å»¶è¿Ÿè§¦å‘
   - é«˜å®‰å…¨æ€§

---

## ğŸ“š ä»£ç ç¤ºä¾‹å¯¹æ¯”

### å†…æ ¸æ€å®ç°ï¼ˆæ¨èï¼‰âœ…

```c
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å†…æ ¸ç›‘æ§çº¿ç¨‹ï¼ˆ5ms è½®è¯¢ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

static int kfd_priority_monitor_thread(void *data) {
    while (!kthread_should_stop()) {
        // 1. ä¼‘çœ  5ms
        wait_event_interruptible_timeout(..., msecs_to_jiffies(5));
        
        // 2. æ‰«æé˜Ÿåˆ—ï¼ˆMMIO readï¼Œ<10Î¼sï¼‰
        for_each_queue(q) {
            q->wptr = readl(q->write_ptr);
            q->rptr = readl(q->read_ptr);
            q->pending = q->wptr - q->rptr;
        }
        
        // 3. æ£€æµ‹ä¼˜å…ˆçº§å€’ç½®
        if (high_prio_waiting && low_prio_running) {
            // 4. â­ ç›´æ¥è§¦å‘ CWSRï¼ˆ<1Î¼sï¼Œæ—  ioctlï¼ï¼‰
            kfd_queue_preempt_single(low_queue, WAVEFRONT_SAVE, 0);
        }
    }
}

// â­ å…³é”®ä¼˜åŠ¿ï¼š
// â€¢ æ—  ioctl å¼€é”€
// â€¢ ç›´æ¥å‡½æ•°è°ƒç”¨ï¼ˆ<100nsï¼‰
// â€¢ 5ms æ£€æµ‹å»¶è¿Ÿå¯æ¥å—
// â€¢ æ€»å»¶è¿Ÿï¼š~5ms
```

### Userspace å®ç°ï¼ˆä¸æ¨èï¼‰âŒ

```c
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Userspace ç›‘æ§çº¿ç¨‹ï¼ˆå‡è®¾å¯è¡Œï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

void* userspace_monitor_thread(void* arg) {
    while (running) {
        // 1. ä¼‘çœ  5ms
        usleep(5000);
        
        // 2. âŒ é—®é¢˜ï¼šå¦‚ä½•è·å–é˜Ÿåˆ—çŠ¶æ€ï¼Ÿ
        // æ–¹æ¡ˆ A: ioctl æŸ¥è¯¢ï¼ˆæ…¢ï¼Œ~1-5Î¼s per queueï¼‰
        for (int i = 0; i < num_queues; i++) {
            struct queue_status status;
            ioctl(kfd_fd, AMDKFD_IOC_GET_QUEUE_STATUS, &status);
            // 32 ä¸ªé˜Ÿåˆ— = 32-160Î¼s âš ï¸
        }
        
        // 3. æ£€æµ‹ä¼˜å…ˆçº§å€’ç½®
        if (high_prio_waiting && low_prio_running) {
            // 4. âŒ ioctl è§¦å‘æŠ¢å ï¼ˆæ…¢ï¼Œ~1-5Î¼sï¼‰
            ioctl(kfd_fd, AMDKFD_IOC_PREEMPT_QUEUE, low_queue_id);
        }
    }
}

// âŒ å…³é”®é—®é¢˜ï¼š
// â€¢ æ¯æ¬¡æ£€æŸ¥ï¼š32 æ¬¡ ioctlï¼ˆè·å–çŠ¶æ€ï¼‰= 32-160Î¼s
// â€¢ è§¦å‘æŠ¢å ï¼š1 æ¬¡ ioctl = 1-5Î¼s
// â€¢ æ€»å¼€é”€ï¼š~40-170Î¼s per checkï¼ˆvs å†…æ ¸ <10Î¼sï¼‰
// â€¢ åŠ ä¸Šæ£€æµ‹å»¶è¿Ÿï¼š~5ms
// â€¢ æ€»å»¶è¿Ÿï¼š~5msï¼ˆä½†å¼€é”€å¤§å¾—å¤šï¼‰
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-28  
**æ ¸å¿ƒç»“è®º**: CWSR è½¯ä»¶é€»è¾‘æç®€ï¼ˆ~70 è¡Œï¼‰ï¼Œä½†å®Œå…¨ userspace ä¸å¯è¡Œã€‚æ¨èå†…æ ¸ç›‘æ§ + userspace ç­–ç•¥çš„æ··åˆæ–¹æ¡ˆã€‚

**ç›¸å…³æ–‡æ¡£**:
- ARCH_Design_01: AMD ROCm ä¼˜å…ˆçº§è°ƒåº¦ç³»ç»Ÿå®Œæ•´æ¶æ„
- ARCH_Design_02: Doorbell ä¸ Kernel æäº¤æœºåˆ¶æ·±åº¦è§£æ
- KFD_CWSRæŠ¢å æœºåˆ¶æ·±åº¦åˆ†æ.md: CWSR è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
