================================================================================
                    CWSR机制快速参考卡
          Compute Wave Save/Restore Quick Reference
================================================================================

📌 什么是CWSR？
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
CWSR = AMD GPU的硬件加速wave级别抢占机制
     = 微秒级任务切换 + 完整状态保存/恢复
     = GPREEMPT的底层实现基础

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 三种抢占类型对比
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
类型                 延迟        状态保存    GPREEMPT使用
────────────────────────────────────────────────────────
WAVEFRONT_DRAIN     1-10ms        ❌            ❌
WAVEFRONT_RESET    10-50μs        ❌            ❌
WAVEFRONT_SAVE      1-10μs        ✅            ✅ ⭐

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💾 CWSR保存的内容
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
每个Wave:
  ├── 程序计数器 (PC)
  ├── 标量寄存器 (SGPRs)
  ├── 向量寄存器 (VGPRs)
  ├── 累加器寄存器 (ACC VGPRs)
  ├── Local Data Share (LDS)
  └── 硬件状态寄存器

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏗️ 三层架构
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌────────────────────────────────────┐
│     GPREEMPT层 (用户空间)          │ ← Phase 1已完成
│  • ioctl接口                       │
│  • 调度策略                        │
└────────────┬───────────────────────┘
             │
┌────────────▼───────────────────────┐
│     KFD CWSR层 (驱动)              │ ← 驱动已有
│  • checkpoint_mqd()                │
│  • restore_mqd()                   │
│  • destroy_mqd()                   │
└────────────┬───────────────────────┘
             │
┌────────────▼───────────────────────┐
│     硬件CWSR (GPU)                 │ ← GPU支持
│  • Trap Handler                    │
│  • 状态保存/恢复                   │
└────────────────────────────────────┘

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💻 关键代码位置
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

KFD驱动:
  /usr/src/amdgpu-6.12.12-2194681.el8/amd/amdkfd/
  ├── cwsr_trap_handler_gfx9.asm      # MI100/MI200/MI300
  ├── kfd_mqd_manager_v9.c            # checkpoint/restore
  ├── kfd_device_queue_manager.c      # CWSR使用
  └── kfd_queue.c                     # CWSR内存管理

我们的代码:
  /mnt/md0/zhehan/code/coderampup/private_github/amdgpu_DKMS/
  └── amdgpu-6.12.12-2194681.el8/amd/amdkfd/
      └── kfd_queue_preempt.c         # Phase 1实现

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔧 关键函数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

KFD接口:
  checkpoint_mqd()    - 保存MQD和控制栈
  restore_mqd()       - 恢复MQD和控制栈
  destroy_mqd()       - 触发抢占

GPREEMPT封装:
  kfd_queue_preempt_single()  - 抢占单个队列
  kfd_queue_resume_single()   - 恢复单个队列
  kfd_queue_cleanup_snapshot()- 清理snapshot

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📏 内存开销 (MI300)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

每个队列:
  Control Stack:     ~8.6 MB
  Workgroup Data:    ~177 MB
  Debug Memory:      ~0.3 MB
  ──────────────────────────
  Total:             ~186 MB

32个队列:              ~5.8 GB ⚠️

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔄 抢占流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

用户调用 ioctl(AMDKFD_IOC_PREEMPT_QUEUE)
    ↓
kfd_queue_preempt_single()
    ↓
checkpoint_mqd() → 保存到备份
    ↓
destroy_mqd(WAVEFRONT_SAVE) → 触发硬件
    ↓
硬件Trap Handler执行 → 保存所有状态
    ↓
Wave挂起 ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔙 恢复流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

用户调用 ioctl(AMDKFD_IOC_RESUME_QUEUE)
    ↓
kfd_queue_resume_single()
    ↓
restore_mqd() → 从备份恢复
    ↓
load_mqd() → 加载到GPU
    ↓
硬件从CWSR内存恢复状态
    ↓
Wave继续执行 ✅

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🚀 编译和测试
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

编译:
  cd /mnt/md0/zhehan/code/coderampup/private_github/amdgpu_DKMS/
     amdgpu-6.12.12-2194681.el8
  make -j$(nproc)

安装:
  sudo make modules_install
  sudo depmod -a
  sudo modprobe -r amdgpu
  sudo modprobe amdgpu

验证:
  sudo dmesg | grep -i "gpreempt\|cwsr"
  lsmod | grep amdgpu

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📚 文档位置
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

简要总结:
  /mnt/md0/zhehan/code/rampup_doc/GPREEMPT_MI300_Testing/
  └── CWSR机制简要总结.md

深度分析:
  /mnt/md0/zhehan/code/coderampup/private_github/amdgpudriver/
  doc/scheduler/
  └── KFD_CWSR抢占机制深度分析.md

实施报告:
  /mnt/md0/zhehan/code/rampup_doc/GPREEMPT_MI300_Testing/
  └── Phase1实施完成报告.md

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ 关键发现
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. AMD GPU硬件已支持CWSR (GFX8+)
2. KFD驱动已完整实现CWSR接口
3. GPREEMPT只需封装现有接口
4. Phase 1: 8分钟完成 (vs 预计1-2天)
5. 实施风险大幅降低

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 关键洞察
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

"GPREEMPT论文中的wave-level preemption with state save
 实际上就是AMD的CWSR机制。
 KFD驱动已经完整实现。
 我们只需要包装和调度策略。"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 项目状态
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Phase 1: ████████████████████ 100% ✅ 完成
Phase 2: ░░░░░░░░░░░░░░░░░░░░   0% ⏳ 编译测试
Phase 3: ░░░░░░░░░░░░░░░░░░░░   0% ⏳ 性能测试

总体:    ████████░░░░░░░░░░░░  33%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

最后更新: 2026-01-27 10:45
状态: Phase 1完成，准备Phase 2

================================================================================

