# 实验1快速开始指南

**时间**: < 20分钟  
**目标**: 确定AI模型使用的队列

---

## 🚀 3步快速开始

### 步骤1: 进入目录

```bash
cd /mnt/md0/zhehan/code/flashinfer/dockercode/gpreempt_test
```

### 步骤2: 运行实验

```bash
./exp01_queue_monitor.sh
```

**说明**:
- 自动启动测试模型
- 持续监控100秒
- 每10秒采样一次
- 自动收集MQD和HQD数据

### 步骤3: 分析结果

```bash
python3 analyze_queue_usage.py ./exp01_results
```

**输出内容**:
- 队列数量变化
- Queue ID分布
- 队列属性
- MQD → HQD映射验证
- 实验总结

---

## 📊 预期输出示例

```
╔════════════════════════════════════════════════════════╗
║  队列使用情况分析                                       ║
╚════════════════════════════════════════════════════════╝

📊 找到 10 个MQD快照

🎯 目标进程PID: 12345

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析1: 队列数量变化
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  采样  1: 2 个队列
  采样  2: 2 个队列
  采样  3: 2 个队列
  ...
  
  平均队列数: 2.0
  最小队列数: 2
  最大队列数: 2
  ✅ 队列数量稳定（一致）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析2: Queue ID分布
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  采样  1: [0, 1]
  采样  2: [0, 1]
  ...
  
  所有出现的Queue IDs: [0, 1]
  唯一Queue ID数量: 2
  ✅ Queue ID在所有采样中一致

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析3: 队列属性分析
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Queue ID 0:
    Priority: 0
    Type: COMPUTE
    Active: True

  Queue ID 1:
    Priority: 0
    Type: SDMA
    Active: True

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
分析4: MQD → HQD映射验证
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  总HQD数: 960
  Active HQD数: 8

  Active HQD分布（按XCC）:
    XCC 0: 2 个
    XCC 1: 2 个
    XCC 2: 2 个
    XCC 3: 2 个

  MQD数量: 2
  Active HQD数量: 8
  期望HQD数量: 8 (MQD × 4)
  ✅ 映射关系正确: 1 MQD → 4 HQD

╔════════════════════════════════════════════════════════╗
║  实验总结                                               ║
╚════════════════════════════════════════════════════════╝

✅ 该模型使用 2 个队列（MQD）
✅ Queue IDs: [0, 1]
✅ 队列数量稳定性: 一致

💡 对POC Stage 1的意义:
   - 抢占粒度: 2 个队列
   - 批量操作可行: ✅ (可以一次操作2个队列)
   - 识别策略: 使用PID过滤，Queue ID: [0, 1]
```

---

## ✅ 成功标准

实验成功的标志：

1. ✅ 找到模型的队列（至少1个）
2. ✅ 队列数量稳定（10次采样一致）
3. ✅ 验证了MQD → HQD映射（1:4）

如果看到这3个✅，说明实验成功！

---

## 🔍 数据文件说明

运行后会在 `./exp01_results/` 生成：

```
exp01_results/
  ├─ baseline_mqd.txt              # 基线MQD
  ├─ baseline_hqd.txt              # 基线HQD
  ├─ snapshot_mqd_1_*.txt          # 采样1的MQD
  ├─ snapshot_hqd_1_*.txt          # 采样1的HQD
  ├─ queue_info_1_*.txt            # 采样1的队列信息（提取）
  ├─ snapshot_ps_1_*.txt           # 采样1的进程信息
  ├─ ... (共10个采样)
  ├─ final_mqd.txt                 # 最终MQD
  ├─ final_hqd.txt                 # 最终HQD
  └─ model_output.log              # 模型运行日志
```

---

## 💡 实验意义

这个实验将告诉我们：

### 1. 队列数量
```
知道了: 一个模型用几个队列
影响: POC的抢占粒度
示例: 2个队列 → batch_unmap([0, 1])
```

### 2. Queue ID
```
知道了: 模型使用的具体Queue ID
影响: 如何识别要抢占的队列
示例: PID=12345, Queue IDs=[0,1]
```

### 3. 映射关系
```
知道了: 1个MQD → 4个HQD (MI308X)
影响: 理解系统资源使用
示例: 2个MQD = 8个HQD占用
```

### 4. 稳定性
```
知道了: 队列数量和ID是否稳定
影响: 是否可以硬编码还是需要动态识别
示例: 稳定 → 可以简化POC实现
```

---

## 🐛 常见问题

### Q1: 未找到容器内进程

**症状**: 
```
⚠️ 未找到容器内的进程
```

**解决**:
1. 检查容器是否运行: `docker ps | grep zhenaiter`
2. 检查模型输出: `cat exp01_results/model_output.log`
3. 可能是PyTorch初始化失败，查看日志

---

### Q2: 未找到队列信息

**症状**:
```
⚠️ 未找到队列信息
```

**原因**:
- 模型初始化太慢
- PyTorch没有真正使用GPU
- debugfs权限问题

**解决**:
1. 等待更久（30秒）
2. 检查GPU是否真正被使用
3. 确认有sudo权限

---

### Q3: MQD → HQD映射不匹配

**症状**:
```
❌ 映射关系不匹配（差异: X）
```

**原因**:
- 可能有其他进程的队列
- 可能有系统队列

**解决**:
这是正常的，只要差异不大（<10）就可以接受

---

## 📚 相关文档

- **详细设计**: `EXP_01_QUEUE_USAGE_ANALYSIS.md`
- **Map/Unmap机制**: `New_SW_QUEUE_HW_QUEUE_MAPPING_MECHANISM.md`
- **POC设计**: `New_DESIGN_MAP_UNMAP_BASED_PREEMPTION.md`

---

## 🎯 下一步

实验完成后，根据结果决定：

### 如果队列数量稳定（推荐）⭐⭐⭐⭐⭐
```
→ 可以使用简化的POC实现
→ 硬编码Queue ID
→ 快速验证概念
```

### 如果队列数量不稳定
```
→ 需要动态识别Queue ID
→ 实现更复杂
→ 但更通用
```

---

**现在就开始吧！**

```bash
cd /mnt/md0/zhehan/code/flashinfer/dockercode/gpreempt_test
./exp01_queue_monitor.sh
```

预计时间: 10-15分钟  
难度: ⭐⭐ (简单，自动化)  
收益: ⭐⭐⭐⭐⭐ (为POC提供关键数据)
