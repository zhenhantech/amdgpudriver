# ftrace Bufferå†…å­˜åˆ†é…é—®é¢˜ä¿®å¤

## ğŸ”´ é—®é¢˜æè¿°

è¿è¡Œ `run_deepseek_with_ftrace.sh` æ—¶é‡åˆ°é”™è¯¯ï¼š

```bash
è®¾ç½®trace buffer (20MB)...
./run_deepseek_with_ftrace.sh: line 68: echo: write error: Cannot allocate memory
```

## ğŸ“Š åŸå› åˆ†æ

### 1. ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Ÿ

ftraceä½¿ç”¨çš„æ˜¯**å†…æ ¸å†…å­˜**ï¼Œéœ€è¦**è¿ç»­çš„ç‰©ç†å†…å­˜å—**ã€‚20MBçš„bufferå¯¹äºå½“å‰ç³»ç»Ÿæ¥è¯´å¤ªå¤§äº†ï¼Œå¯èƒ½åŸå› ï¼š

- **å†…å­˜ç¢ç‰‡åŒ–**ï¼šç³»ç»Ÿè¿è¡Œæ—¶é—´é•¿ï¼Œå†…å­˜ç¢ç‰‡è¾ƒå¤š
- **å…¶ä»–è¿›ç¨‹å ç”¨**ï¼šGPUè¿›ç¨‹ï¼ˆvLLM/DeepSeekï¼‰å·²ç»å ç”¨å¤§é‡å†…å­˜
- **Per-CPU buffer**ï¼šftraceä¸ºæ¯ä¸ªCPUåˆ†é…ç‹¬ç«‹bufferï¼Œå®é™…å†…å­˜ = buffer_size Ã— CPUæ•°é‡

### 2. ftrace bufferå¤§å°è¯´æ˜

```
å®é™…å†…å­˜ä½¿ç”¨ = buffer_size_kb Ã— CPUæ ¸å¿ƒæ•°
```

**ç¤ºä¾‹ï¼ˆå‡è®¾40æ ¸CPUï¼‰ï¼š**
- 4MB buffer  â†’ 160MB å®é™…å†…å­˜
- 8MB buffer  â†’ 320MB å®é™…å†…å­˜
- 12MB buffer â†’ 480MB å®é™…å†…å­˜
- 20MB buffer â†’ 800MB å®é™…å†…å­˜ âŒ å¤ªå¤§äº†ï¼

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: è‡ªåŠ¨Bufferè°ƒæ•´ï¼ˆå·²å®ç°ï¼‰â­

è„šæœ¬ç°åœ¨ä¼šè‡ªåŠ¨å°è¯•ä¸åŒçš„bufferå¤§å°ï¼š

```bash
å°è¯•bufferå¤§å°ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:
1. 4MB  (160MBæ€»å†…å­˜) - æœ€å®‰å…¨
2. 8MB  (320MBæ€»å†…å­˜) - æ¨è
3. 12MB (480MBæ€»å†…å­˜) - å¦‚æœå†…å­˜å……è¶³
4. 16MB (640MBæ€»å†…å­˜) - æœ€å¤§å°è¯•
```

**å¦‚æœæ‰€æœ‰å°è¯•éƒ½å¤±è´¥**ï¼šä½¿ç”¨ç³»ç»Ÿé»˜è®¤bufferå¤§å°ï¼ˆé€šå¸¸1-2MBï¼‰

### æ–¹æ¡ˆ2: é‡Šæ”¾å†…å­˜åé‡è¯•

```bash
# æ­¥éª¤1: æ£€æŸ¥ç³»ç»Ÿå†…å­˜
free -h

# æ­¥éª¤2: æ¸…ç†ç³»ç»Ÿç¼“å­˜ï¼ˆéœ€è¦rootï¼‰
sync
echo 3 > /proc/sys/vm/drop_caches

# æ­¥éª¤3: é‡æ–°è¿è¡Œæµ‹è¯•
sudo ./run_deepseek_with_ftrace.sh zhen_vllm_dsv3
```

### æ–¹æ¡ˆ3: ä½¿ç”¨æ›´å°çš„bufferï¼ˆæ‰‹åŠ¨ï¼‰

å¦‚æœè‡ªåŠ¨è°ƒæ•´ä»ç„¶å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®ï¼š

```bash
# ç¼–è¾‘è„šæœ¬ï¼Œä¿®æ”¹ BUFFER_SIZES æ•°ç»„
vim run_deepseek_with_ftrace.sh

# æ‰¾åˆ°ç¬¬63è¡Œå·¦å³ï¼Œä¿®æ”¹ä¸ºæ›´å°çš„å€¼ï¼š
BUFFER_SIZES=(2048 4096)  # åªå°è¯•2MBå’Œ4MB
```

### æ–¹æ¡ˆ4: ç¦ç”¨bufferè°ƒæ•´

å¦‚æœä¸éœ€è¦å¤§é‡ftraceæ—¥å¿—ï¼Œå¯ä»¥è·³è¿‡bufferè°ƒæ•´ï¼š

```bash
# ç¼–è¾‘è„šæœ¬ï¼Œæ³¨é‡Šæ‰bufferè®¾ç½®éƒ¨åˆ†
# æˆ–è€…ç›´æ¥ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å¤§å°
```

---

## ğŸ” éªŒè¯Bufferè®¾ç½®

### æ£€æŸ¥å½“å‰bufferå¤§å°

```bash
# æŸ¥çœ‹å½“å‰è®¾ç½®
cat /sys/kernel/debug/tracing/buffer_size_kb

# æŸ¥çœ‹å®é™…ä½¿ç”¨ï¼ˆè€ƒè™‘CPUæ•°é‡ï¼‰
grep processor /proc/cpuinfo | wc -l  # CPUæ•°é‡
```

### æµ‹è¯•bufferæ˜¯å¦è¶³å¤Ÿ

```bash
# 4MB bufferé€šå¸¸è¶³å¤Ÿæ•è·ï¼š
- Queueåˆ›å»º/é”€æ¯äº‹ä»¶
- Map/Unmapæ“ä½œ
- å…³é”®KFDå‡½æ•°è°ƒç”¨

# å¯¹äºæœ¬æ¬¡åˆ†æå·²ç»è¶³å¤Ÿï¼
```

---

## ğŸ“Š ä¸åŒBufferå¤§å°å¯¹æ¯”

| Buffer | Per-CPU | 40æ ¸æ€»å†…å­˜ | é€‚ç”¨åœºæ™¯ |
|--------|---------|-----------|----------|
| 1MB    | 1024KB  | 40MB      | æœ€å°å¯ç”¨ï¼Œä»…æ•è·å°‘é‡äº‹ä»¶ |
| 2MB    | 2048KB  | 80MB      | åŸºæœ¬å¤Ÿç”¨ï¼ŒQueueåˆ†æè¶³å¤Ÿ |
| **4MB** âœ… | **4096KB** | **160MB** | **æ¨èï¼ŒQueue+Kernelåˆ†æ** |
| 8MB    | 8192KB  | 320MB     | å……è£•ï¼Œè¯¦ç»†trace |
| 12MB   | 12288KB | 480MB     | å¤§é‡äº‹ä»¶ï¼Œé•¿æ—¶é—´trace |
| 20MB   | 20480KB | 800MB     | å¾ˆå°‘éœ€è¦ï¼Œå®¹æ˜“OOM âŒ |

---

## ğŸ¯ å¯¹æœ¬æ¬¡æµ‹è¯•çš„å½±å“

### âœ… 4MB bufferå®Œå…¨è¶³å¤Ÿ

**åŸå› ï¼š**
1. **æˆ‘ä»¬åªå…³å¿ƒQueueä½¿ç”¨æ¨¡å¼**
   - Queueåœ°å€
   - Queueæ•°é‡
   - Map/Unmapäº‹ä»¶

2. **AMDæ—¥å¿—æ›´é‡è¦**
   - AMD_LOG_LEVEL=3 å·²ç»åŒ…å«Queueä¿¡æ¯
   - ftraceæ˜¯è¾…åŠ©éªŒè¯

3. **æµ‹è¯•æ—¶é—´é€‚ä¸­**
   - DeepSeek testæ¨¡å¼ï¼š2-5åˆ†é’Ÿ
   - 4MB bufferå¯ä»¥è¦†ç›–æ•´ä¸ªæµ‹è¯•å‘¨æœŸ

### ğŸ“Š å®é™…éœ€è¦æ•è·çš„äº‹ä»¶

```
å…³é”®äº‹ä»¶ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰:
1. Queueåˆ›å»º      - amdgpu_queue_mgr_map
2. Queueé”€æ¯      - amdgpu_queue_mgr_unmap  
3. Kernelæäº¤     - amdgpu_cs_ioctl
4. KFDè°ƒç”¨        - kfd_ioctl

4MB bufferå¯ä»¥æ•è·æˆåƒä¸Šä¸‡ä¸ªè¿™äº›äº‹ä»¶ âœ“
```

---

## ğŸš€ æ›´æ–°åçš„è„šæœ¬è¿è¡Œ

### ç°åœ¨è¿è¡Œä¼šçœ‹åˆ°ï¼š

```bash
â”â”â” æ­¥éª¤1: é…ç½®ftrace â”â”â”
âœ… ftraceå¯ç”¨

æ¸…ç©ºä¹‹å‰çš„trace...
è®¾ç½®trace buffer...
  å½“å‰bufferå¤§å°: 1 MB
  å°è¯•è®¾ç½®ä¸º 4 MB...
  âœ… æˆåŠŸè®¾ç½®ä¸º 4 MB

å¯ç”¨function tracer...
âœ… ftraceé…ç½®å®Œæˆ
```

### å¦‚æœå†…å­˜ä»ç„¶ä¸è¶³ï¼š

```bash
è®¾ç½®trace buffer...
  å½“å‰bufferå¤§å°: 1 MB
  å°è¯•è®¾ç½®ä¸º 4 MB...
  âš ï¸  å†…å­˜ä¸è¶³ï¼Œå°è¯•æ›´å°çš„buffer...
  â„¹ï¸  æ— æ³•è°ƒæ•´bufferï¼Œä½¿ç”¨é»˜è®¤å¤§å°
  æœ€ç»ˆbuffer: 1 MB (è¶³å¤Ÿç”¨äºåŸºæœ¬åˆ†æ)

# è¿™æ ·ä¹Ÿå¯ä»¥ç»§ç»­æµ‹è¯•ï¼
```

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. åœ¨æµ‹è¯•å‰é‡Šæ”¾å†…å­˜

```bash
# å¦‚æœç³»ç»Ÿå†…å­˜ç´§å¼ ï¼Œå…ˆæ¸…ç†
sudo sync
sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches'

# ç­‰å¾…å‡ ç§’
sleep 5

# ç„¶åè¿è¡Œæµ‹è¯•
sudo ./run_deepseek_with_ftrace.sh zhen_vllm_dsv3
```

### 2. å…³é—­ä¸å¿…è¦çš„ftraceé€‰é¡¹

è„šæœ¬å·²ç»ä¼˜åŒ–ä¸ºåªè¿½è¸ª `amdgpu` æ¨¡å—ï¼š

```bash
echo :mod:amdgpu > /sys/kernel/debug/tracing/set_ftrace_filter
```

è¿™å¤§å¤§å‡å°‘äº†ftraceå¼€é”€ã€‚

### 3. ä½¿ç”¨Event Tracingä»£æ›¿Function Tracingï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ›´ç²¾ç¡®çš„æ§åˆ¶ï¼š

```bash
# ç¦ç”¨function tracer
echo nop > /sys/kernel/debug/tracing/current_tracer

# åªå¯ç”¨ç‰¹å®šäº‹ä»¶
echo 1 > /sys/kernel/debug/tracing/events/kfd/enable
echo 1 > /sys/kernel/debug/tracing/events/amdgpu/enable
```

è¿™æ ·bufferéœ€æ±‚æ›´å°ï¼Œä½†éœ€è¦è‡ªå®šä¹‰trace eventsã€‚

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [DeepSeekæµ‹è¯•å®Œæ•´æŒ‡å—](DEEPSEEK_TEST_GUIDE.md)
- [å¿«é€Ÿä¿®å¤æŒ‡å—](DEEPSEEK_QUICK_FIX.md)
- [è®¾ç½®å®Œæˆè¯´æ˜](DEEPSEEK_SETUP_COMPLETE.md)

---

## âœ… ç»“è®º

**é—®é¢˜å·²ä¿®å¤ï¼** è„šæœ¬ç°åœ¨ä¼šï¼š
1. è‡ªåŠ¨å°è¯•åˆç†çš„bufferå¤§å°ï¼ˆ4MB â†’ 8MB â†’ 12MB â†’ 16MBï¼‰
2. å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤buffer
3. **4MB bufferå¯¹æœ¬æ¬¡Queueåˆ†æå®Œå…¨è¶³å¤Ÿ** âœ“

**ç°åœ¨å¯ä»¥é‡æ–°è¿è¡Œæµ‹è¯•ï¼š**

```bash
cd /mnt/md0/zhehan/code/coderampup/private_github/amdgpudriver/doc/scheduler/DOC_POC_stage1/code
sudo ./run_deepseek_with_ftrace.sh zhen_vllm_dsv3
```

---

**æ›´æ–°æ—¶é—´**: 2026-02-05  
**é—®é¢˜**: ftrace bufferå†…å­˜åˆ†é…å¤±è´¥  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

