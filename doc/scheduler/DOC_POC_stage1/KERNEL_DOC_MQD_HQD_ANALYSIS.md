# Linux Kernel å®˜æ–¹æ–‡æ¡£ï¼šMQD & HQD æ·±åº¦åˆ†æ

**æ¥æº**: [AMD GPU Driver Core Documentation](https://docs.kernel.org/gpu/amdgpu/driver-core.html)  
**æ—¥æœŸ**: 2026-02-03  
**é‡è¦æ€§**: â­â­â­â­â­ (å®˜æ–¹æƒå¨æ–‡æ¡£)

---

## ğŸ“– å®˜æ–¹æ–‡æ¡£å…³é”®ç« èŠ‚

### GFX, Compute, and SDMA Overall Behavior

è¿™ä¸€ç« èŠ‚è¯¦ç»†è§£é‡Šäº† Queue çš„å·¥ä½œæœºåˆ¶ï¼Œæ˜¯ç†è§£ MQD/HQD çš„æ ¸å¿ƒã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„æ¦‚å¿µ

### 1. Pipes å’Œ Queues çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Pipe   â”‚ â—„â”€â”€â”€â”€â”€â”€ â”‚  Multiple Queues â”‚  â”‚
â”‚  â”‚         â”‚         â”‚                  â”‚  â”‚
â”‚  â”‚ (æ‰§è¡Œå™¨)â”‚         â”‚  Queue 0         â”‚  â”‚
â”‚  â”‚         â”‚         â”‚  Queue 1         â”‚  â”‚
â”‚  â”‚ ä¸€æ¬¡åª  â”‚         â”‚  Queue 2         â”‚  â”‚
â”‚  â”‚ æ‰§è¡Œä¸€ä¸ªâ”‚         â”‚  ...             â”‚  â”‚
â”‚  â”‚ Queue   â”‚         â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®˜æ–¹æè¿°**:
> Queues must be associated with a Pipe and vice-versa. Every specific hardware IP may have a different number of Pipes and, in turn, a different number of Queues.

**å…³é”®ç‚¹**:
1. âœ… **Queues å¿…é¡»ä¸ Pipe å…³è”**
2. âœ… **Pipe ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ª Queue**
3. âœ… **ä¸åŒç¡¬ä»¶ IP æœ‰ä¸åŒæ•°é‡çš„ Pipes å’Œ Queues**

**ç¤ºä¾‹ (GFX 11)**:
```
GFX 11 å‰ç«¯:
  - 2 ä¸ª Pipes
  - æ¯ä¸ª Pipe æœ‰ 2 ä¸ª Queues
```

---

### 2. Pipe çš„å·¥ä½œæœºåˆ¶

**å®˜æ–¹æè¿°**:
> Pipe is the hardware that processes the instructions available in the Queues; in other words, it is a thread executing the operations inserted in the Queue.

**Pipe çš„ç‰¹æ€§**:
- ğŸ”§ **ç¡¬ä»¶å¤„ç†å™¨**: æ‰§è¡Œ Queue ä¸­çš„æŒ‡ä»¤
- ğŸ”„ **Queue åˆ‡æ¢èƒ½åŠ›**: å¯ä»¥åœ¨ç¡¬ä»¶å±‚é¢åˆ‡æ¢ Queue
- âš¡ **åªæ‰§è¡Œ Mapped Queues**: åªå¤„ç†å·²æ˜ å°„çš„é˜Ÿåˆ—

**Queue åˆ‡æ¢çš„è§¦å‘æ¡ä»¶**:
1. **Command Stream** (å‘½ä»¤æµ)
2. **Packet by Packet** (é€åŒ…)
3. **å…¶ä»–ç¡¬ä»¶è¯·æ±‚** (ä¾‹å¦‚ MES)

---

## ğŸ¯ MQD (Memory Queue Descriptor)

### å®˜æ–¹å®šä¹‰

**åŸæ–‡**:
> Associated with the HQD concept, we have the Memory Queue Descriptor (MQD), which is responsible for storing information about the state of each of the available Queues in the memory.

### MQD çš„èŒè´£

```
MQD (å†…å­˜ä¸­)
  â”œâ”€ å­˜å‚¨ Queue çŠ¶æ€ä¿¡æ¯
  â”‚   â”œâ”€ GPU è™šæ‹Ÿåœ°å€
  â”‚   â”œâ”€ Save areas
  â”‚   â”œâ”€ Doorbell
  â”‚   â””â”€ å…¶ä»–çŠ¶æ€
  â”‚
  â””â”€ å­˜å‚¨ HQD å¯„å­˜å™¨
      â””â”€ ç”¨äºæ¿€æ´»/åœç”¨ Queue
```

**å®˜æ–¹æè¿°**:
> The state of a Queue contains information such as the GPU virtual address of the queue itself, save areas, doorbell, etc. The MQD also stores the HQD registers, which are vital for activating or deactivating a given Queue.

### MQD åŒ…å«çš„ä¿¡æ¯

| å†…å®¹ | è¯´æ˜ |
|------|------|
| **GPU Virtual Address** | Queue åœ¨ GPU åœ°å€ç©ºé—´ä¸­çš„ä½ç½® |
| **Save Areas** | ä¿å­˜ Queue ä¸Šä¸‹æ–‡çš„å†…å­˜åŒºåŸŸ |
| **Doorbell** | ç”¨æˆ·æ€é€šçŸ¥ç¡¬ä»¶çš„ MMIO å¯„å­˜å™¨ |
| **HQD Registers** | ç¡¬ä»¶é˜Ÿåˆ—æè¿°ç¬¦å¯„å­˜å™¨å‰¯æœ¬ |
| **Queue State** | Queue çš„è¿è¡ŒçŠ¶æ€ |

---

## ğŸ”© HQD (Hardware Queue Descriptor)

### å®˜æ–¹å®šä¹‰

**åŸæ–‡**:
> Queues within Pipes are defined by the Hardware Queue Descriptors (HQD).

### HQD çš„ç‰¹æ€§

```
HQD (ç¡¬ä»¶å¯„å­˜å™¨)
  â”œâ”€ å®šä¹‰ Pipe å†…çš„ Queue
  â”œâ”€ HQD_ACTIVE ä½
  â”‚   â”œâ”€ 1 = Queue æ´»è·ƒ
  â”‚   â””â”€ 0 = Queue éæ´»è·ƒ
  â”‚
  â””â”€ æ§åˆ¶ Queue çš„ç¡¬ä»¶çŠ¶æ€
```

**å…³é”®å¯„å­˜å™¨**:
- **HQD_ACTIVE**: æŒ‡ç¤º Queue æ˜¯å¦æ´»è·ƒçš„å…³é”®ä½

**å®˜æ–¹æè¿°**:
> The firmware waits for the HQD_ACTIVE bit to change to low before saving the state into the MQD.

---

## ğŸ”„ Queue åˆ‡æ¢æœºåˆ¶

### å›ºä»¶çš„è§’è‰²

**å®˜æ–¹æè¿°**:
> The scheduling firmware (e.g., MES) is responsible for loading HQDs from MQDs and vice versa.

**MES (Micro-Engine Scheduler)**:
- GFX 11+ çš„è°ƒåº¦å›ºä»¶
- è´Ÿè´£ Queue çš„è°ƒåº¦å’Œåˆ‡æ¢
- æ›¿ä»£äº†æ—§çš„ KIQ æœºåˆ¶

---

### Queue åˆ‡æ¢æµç¨‹

#### 1. åœç”¨ Queue (Deactivate)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å›ºä»¶è¯·æ±‚æŠ¢å /å¸è½½ Queue                    â”‚
â”‚    firmware requests preemption/unmapping   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å›ºä»¶ç­‰å¾… HQD_ACTIVE ä½å˜ä¸º LOW            â”‚
â”‚    firmware waits for HQD_ACTIVE = 0        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. å°† HQD çŠ¶æ€ä¿å­˜åˆ° MQD                     â”‚
â”‚    save HQD state into MQD                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®˜æ–¹åŸæ–‡**:
> The firmware waits for the HQD_ACTIVE bit to change to low before saving the state into the MQD.

---

#### 2. æ¿€æ´» Queue (Activate)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å›ºä»¶å°† MQD çŠ¶æ€å¤åˆ¶åˆ° HQD å¯„å­˜å™¨           â”‚
â”‚    firmware copies MQD state into HQD regs  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åŠ è½½ä»»ä½•é¢å¤–çŠ¶æ€                          â”‚
â”‚    load any additional state                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è®¾ç½® HQD_ACTIVE ä½ä¸º HIGH                 â”‚
â”‚    set HQD_ACTIVE = 1                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Pipe å¼€å§‹æ‰§è¡Œè¯¥ Queue çš„å·¥ä½œ              â”‚
â”‚    Pipe executes work from active Queue     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®˜æ–¹åŸæ–‡**:
> To make a different Queue become active, the firmware copies the MQD state into the HQD registers and loads any additional state. Finally, it sets the HQD_ACTIVE bit to high to indicate that the queue is active. The Pipe will then execute work from active Queues.

---

## ğŸ”‘ å…³é”®æœºåˆ¶ï¼šHQD_ACTIVE ä½

### HQD_ACTIVE çš„ä½œç”¨

```
HQD_ACTIVE å¯„å­˜å™¨
  â”‚
  â”œâ”€ bit[0] = 1  â†’  Queue æ´»è·ƒï¼Œæ­£åœ¨è¢« Pipe æ‰§è¡Œ
  â”‚
  â””â”€ bit[0] = 0  â†’  Queue éæ´»è·ƒï¼Œå¯ä»¥å®‰å…¨æ“ä½œ
```

**è¿™ä¸æˆ‘ä»¬ä¹‹å‰çš„å‘ç°å®Œå…¨ä¸€è‡´ï¼**

å›é¡¾æˆ‘ä»¬çš„æ–‡æ¡£ï¼š
```markdown
private_github/amdgpudriver/doc/kernel_submit/test_queue_limits/logs_KCQ_config/PRECISE_HQD_COUNTING_METHOD.md

mmCP_HQD_ACTIVE (0x1247):
  - Index: 2 (åœ¨ HQD dump ä¸­çš„ä½ç½®)
  - bit[0]: 1 = active, 0 = inactive
```

---

## ğŸ® KIQ vs MES

### KIQ (Kernel Interface Queue)

**å®˜æ–¹å®šä¹‰**:
> This is a control queue used by the kernel driver to manage other gfx and compute queues on the GFX/compute engine. You can use it to map/unmap additional queues, etc.

**ç”¨é€”**:
- å†…æ ¸é©±åŠ¨çš„æ§åˆ¶é˜Ÿåˆ—
- ç®¡ç†å…¶ä»– GFX å’Œ compute queues
- å¯ä»¥ map/unmap é˜Ÿåˆ—

**æ³¨æ„**:
> This is replaced by MES on GFX 11 and newer hardware.

---

### MES (Micro-Engine Scheduler)

**åœ¨ GFX 11+ ä¸Š**:
- MES æ›¿ä»£äº† KIQ
- è´Ÿè´£ Queue è°ƒåº¦
- ä» MQD åŠ è½½ HQDï¼Œåä¹‹äº¦ç„¶

---

## ğŸ’¡ å¯¹ POC Stage 1 çš„å¯ç¤º

### 1. MQD debugfs çš„æœ¬è´¨

```
/sys/kernel/debug/kfd/mqds
  â”‚
  â”œâ”€ æ˜¾ç¤ºæ‰€æœ‰ Queue çš„ MQD ä¿¡æ¯
  â”‚   â”œâ”€ Queue ID (è½¯ä»¶æ ‡è¯†)
  â”‚   â”œâ”€ Process PID
  â”‚   â”œâ”€ GPU Virtual Address
  â”‚   â”œâ”€ Priority
  â”‚   â””â”€ Active Status (è½¯ä»¶è§†è§’)
  â”‚
  â””â”€ è¿™æ˜¯è½¯ä»¶å±‚é¢çš„ Queue çŠ¶æ€
```

---

### 2. HQD debugfs çš„æœ¬è´¨

```
/sys/kernel/debug/kfd/hqds
  â”‚
  â”œâ”€ æ˜¾ç¤ºæ‰€æœ‰ HQD çš„ç¡¬ä»¶å¯„å­˜å™¨
  â”‚   â”œâ”€ CP Pipe å’Œ Queue åæ ‡
  â”‚   â”œâ”€ HQD_ACTIVE å¯„å­˜å™¨ (ç¡¬ä»¶è§†è§’)
  â”‚   â””â”€ å…¶ä»– 55 ä¸ªç¡¬ä»¶å¯„å­˜å™¨
  â”‚
  â””â”€ è¿™æ˜¯ç¡¬ä»¶å±‚é¢çš„ Queue çŠ¶æ€
```

---

### 3. suspend_queues çš„å·¥ä½œåŸç†

åŸºäºå®˜æ–¹æ–‡æ¡£ï¼Œ`suspend_queues` åº”è¯¥ï¼š

```
1. è¯·æ±‚å›ºä»¶åœæ­¢æŒ‡å®šçš„ Queue
   â†“
2. å›ºä»¶ç­‰å¾… HQD_ACTIVE = 0
   â†“
3. å›ºä»¶ä¿å­˜ HQD â†’ MQD
   â†“
4. Queue è¢«æš‚åœ
```

è¿™æ­£æ˜¯ CWSR (Compute Wave Save/Restore) çš„æœºåˆ¶ï¼

---

### 4. Queue ID çš„æœ¬è´¨

**è½¯ä»¶å±‚é¢ (MQD)**:
- Queue ID: è¿›ç¨‹å†…çš„é€»è¾‘ç¼–å· (0, 1, 2, ...)
- ä¸ PID å…³è”
- è½¯ä»¶ç®¡ç†

**ç¡¬ä»¶å±‚é¢ (HQD)**:
- ç”± (Inst, Pipe, Queue) ä¸‰å…ƒç»„æ ‡è¯†
- ä¾‹å¦‚: (0, 0, 5) è¡¨ç¤º Instance 0, Pipe 0, Queue 5
- ç¡¬ä»¶åæ ‡

**æ˜ å°„å…³ç³»**:
```
MQD Queue ID (è½¯ä»¶)  â†â†’  HQD (Inst, Pipe, Queue) (ç¡¬ä»¶)
                    â†‘
                    ç”±å›ºä»¶ (MES/KIQ) ç®¡ç†
```

---

## ğŸ” ä¸æˆ‘ä»¬å®éªŒçš„å…³è”

### ä¸ºä»€ä¹ˆ MQD æ–‡ä»¶æœ‰æ—¶ä¸ºç©ºï¼Ÿ

**ç­”æ¡ˆ**: å› ä¸ºå½“å‰æ²¡æœ‰æ´»è·ƒçš„ Queueï¼

ä»å®˜æ–¹æ–‡æ¡£æˆ‘ä»¬çŸ¥é“ï¼š
1. MQD å­˜å‚¨åœ¨**å†…å­˜**ä¸­
2. åªæœ‰**æ˜ å°„çš„ Queue** æ‰ä¼šåœ¨ debugfs ä¸­æ˜¾ç¤º
3. Queue ç»“æŸåï¼ŒMQD è¢«é‡Šæ”¾

**è§£å†³æ–¹æ¡ˆ**: å¿…é¡»åœ¨ GPU ç¨‹åº**è¿è¡ŒæœŸé—´**æŸ¥çœ‹ MQDï¼

---

### Queue åˆ‡æ¢çš„æ—¶æœº

å®˜æ–¹æ–‡æ¡£æŒ‡å‡ºï¼ŒPipe å¯ä»¥åŸºäºä»¥ä¸‹è¾“å…¥åˆ‡æ¢ Queueï¼š

1. **Command Stream** (å‘½ä»¤æµ)
2. **Packet by Packet** (é€åŒ…)
3. **Other hardware requests** (ä¾‹å¦‚ MES è¯·æ±‚)

**å¯¹ POC çš„æ„ä¹‰**:
- æˆ‘ä»¬çš„ `suspend_queues` å±äºç¬¬ 3 ç±»
- é€šè¿‡ IOCTL â†’ KFD â†’ å›ºä»¶ (MES) â†’ HQD
- å›ºä»¶è´Ÿè´£å®é™…çš„ Queue åˆ‡æ¢

---

## ğŸ¯ POC Stage 1 å®æ–½å»ºè®®æ›´æ–°

### åŸºäºå®˜æ–¹æ–‡æ¡£çš„ç†è§£

#### 1. Queue ID è·å–

```python
# MQD æä¾›è½¯ä»¶å±‚é¢çš„ Queue ID
def get_queue_ids_from_mqd(pid):
    """
    ä» MQD debugfs è·å–æŒ‡å®šè¿›ç¨‹çš„ Queue IDs
    """
    queues = parse_mqd("/sys/kernel/debug/kfd/mqds")
    return [q.queue_id for q in queues if q.pid == pid]
```

**æ³¨æ„**: 
- Queue ID æ˜¯**è¿›ç¨‹å†…çš„é€»è¾‘ç¼–å·**
- ä¸ç¡¬ä»¶ HQD åæ ‡ä¸åŒ
- ç”± KFD ç®¡ç†æ˜ å°„å…³ç³»

---

#### 2. Queue çŠ¶æ€ç›‘æ§

```python
# è½¯ä»¶è§†è§’ï¼šMQD
mqd_active = check_mqd_active(queue_id)

# ç¡¬ä»¶è§†è§’ï¼šHQD
hqd_active = check_hqd_active_bit(inst, pipe, queue)

# ä¸¤è€…å¯èƒ½ä¸åŒï¼
if mqd_active and not hqd_active:
    print("Queue è½¯ä»¶è®¤ä¸ºæ´»è·ƒï¼Œä½†ç¡¬ä»¶æœªæ¿€æ´»")
```

---

#### 3. suspend_queues å·¥ä½œæµç¨‹

```
ç”¨æˆ·ç¨‹åº (POC Test Framework)
  â†“ IOCTL (KFD_IOC_DBG_TRAP_SUSPEND_QUEUES)
KFD Driver
  â†“ è°ƒç”¨å›ºä»¶æ¥å£
MES/KIQ Firmware
  â†“ ç­‰å¾… HQD_ACTIVE = 0
  â†“ ä¿å­˜ HQD â†’ MQD
Queue æš‚åœæˆåŠŸ
```

**å…³é”®ç‚¹**:
- å›ºä»¶è´Ÿè´£å®é™…æ“ä½œ
- å›ºä»¶ç­‰å¾…ç¡¬ä»¶å°±ç»ª
- å›ºä»¶ç®¡ç† MQD â†” HQD è½¬æ¢

---

## ğŸ“Š æ¶æ„å›¾ï¼šMQD/HQD å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·ç©ºé—´ (User Space)                       â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    Doorbell    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  GPU Program â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•> â”‚ Ring Buffer  â”‚             â”‚
â”‚  â”‚  (PyTorch)   â”‚    (MMIOå†™)     â”‚  (Commands)  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚ (1) åˆ›å»º Queue                    â”‚ (2) æäº¤å‘½ä»¤
         â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†…æ ¸ç©ºé—´ (Kernel Space)                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    KFD (Kernel Fusion Driver)            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚   MQD       â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   Debugfs   â”‚               â”‚  â”‚
â”‚  â”‚  â”‚  (Memory)   â”‚         â”‚  /kfd/mqds  â”‚               â”‚  â”‚
â”‚  â”‚  â”‚             â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â”‚  â”‚ Queue State â”‚                                        â”‚  â”‚
â”‚  â”‚  â”‚   - Queue IDâ”‚                                        â”‚  â”‚
â”‚  â”‚  â”‚   - PID     â”‚                                        â”‚  â”‚
â”‚  â”‚  â”‚   - Address â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚  â”‚
â”‚  â”‚  â”‚   - Doorbellâ”‚ â—„â”€â”€â”€â”€â”€â–º â”‚   Debugfs   â”‚               â”‚  â”‚
â”‚  â”‚  â”‚   - HQD Regsâ”‚         â”‚  /kfd/hqds  â”‚               â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚  â”‚
â”‚  â”‚         â–²                                               â”‚  â”‚
â”‚  â”‚         â”‚ (3) MQD â†” HQD                                â”‚  â”‚
â”‚  â”‚         â–¼                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚            MES/KIQ Firmware                     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  (è°ƒåº¦å›ºä»¶ï¼Œç®¡ç† Queue åˆ‡æ¢)                     â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                 â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Load MQD â†’ HQD (æ¿€æ´» Queue)                  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Wait HQD_ACTIVE = 0                         â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  - Save HQD â†’ MQD (åœç”¨ Queue)                  â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (4) ç¡¬ä»¶æ“ä½œ
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¡¬ä»¶å±‚ (Hardware)                           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              GFX/Compute Engine                          â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚
â”‚  â”‚  â”‚        Pipe 0            â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  HQD 0            â”‚  â”‚  â† HQD_ACTIVE å¯„å­˜å™¨       â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  (ç¡¬ä»¶å¯„å­˜å™¨)      â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  HQD 1            â”‚  â”‚  â† ä¸€æ¬¡åªæ‰§è¡Œä¸€ä¸ª Queue    â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚
â”‚  â”‚  â”‚        Pipe 1            â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  HQD 0            â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  HQD 1            â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                            â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— å…³é”®æœ¯è¯­å¯¹ç…§è¡¨

| æœ¯è¯­ | è‹±æ–‡ | å±‚æ¬¡ | è¯´æ˜ |
|------|------|------|------|
| **MQD** | Memory Queue Descriptor | è½¯ä»¶/å†…å­˜ | Queue çŠ¶æ€åœ¨å†…å­˜ä¸­çš„è¡¨ç¤º |
| **HQD** | Hardware Queue Descriptor | ç¡¬ä»¶ | Queue åœ¨ç¡¬ä»¶å¯„å­˜å™¨ä¸­çš„è¡¨ç¤º |
| **Pipe** | Pipe | ç¡¬ä»¶ | æ‰§è¡Œ Queue çš„ç¡¬ä»¶çº¿ç¨‹ |
| **Queue** | Queue | é€»è¾‘ | å‘½ä»¤é˜Ÿåˆ— |
| **KIQ** | Kernel Interface Queue | è½¯ä»¶ | å†…æ ¸æ§åˆ¶é˜Ÿåˆ— (æ—§) |
| **MES** | Micro-Engine Scheduler | å›ºä»¶ | å¾®å¼•æ“è°ƒåº¦å™¨ (æ–°ï¼ŒGFX 11+) |
| **CWSR** | Compute Wave Save/Restore | æœºåˆ¶ | è®¡ç®—æ³¢ä¿å­˜/æ¢å¤ |
| **HQD_ACTIVE** | HQD_ACTIVE bit | ç¡¬ä»¶ | æŒ‡ç¤º Queue æ˜¯å¦æ´»è·ƒçš„ç¡¬ä»¶ä½ |

---

## ğŸ“ é‡è¦å‘ç°æ€»ç»“

### 1. MQD å’Œ HQD çš„æœ¬è´¨åŒºåˆ«

| ç‰¹æ€§ | MQD | HQD |
|------|-----|-----|
| **ä½ç½®** | å†…å­˜ä¸­ | ç¡¬ä»¶å¯„å­˜å™¨ä¸­ |
| **ç®¡ç†è€…** | KFD + å›ºä»¶ | å›ºä»¶ + ç¡¬ä»¶ |
| **å¯è§æ€§** | debugfs: `/kfd/mqds` | debugfs: `/kfd/hqds` |
| **æ ‡è¯†** | Queue ID (è¿›ç¨‹å†…) | (Inst, Pipe, Queue) |
| **ä½œç”¨** | ä¿å­˜ Queue çŠ¶æ€ | æ§åˆ¶ç¡¬ä»¶æ‰§è¡Œ |

---

### 2. Queue ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º â†’ æ˜ å°„ â†’ æ¿€æ´» â†’ æ‰§è¡Œ â†’ æš‚åœ â†’ æ¢å¤ â†’ åœç”¨ â†’ é”€æ¯
  â†“      â†“      â†“      â†“      â†“      â†“      â†“      â†“
 MQD   å›ºä»¶   HQD   Pipe   å›ºä»¶   å›ºä»¶   å›ºä»¶   é‡Šæ”¾
       åˆ†é…   åŠ è½½   æ‰§è¡Œ   ä¿å­˜   æ¢å¤   å¸è½½   MQD
```

---

### 3. æŠ¢å æœºåˆ¶çš„æ­£ç¡®ç†è§£

**åŸºäºå®˜æ–¹æ–‡æ¡£**:

```
æŠ¢å è¯·æ±‚ (suspend_queues)
  â†“
å›ºä»¶å¤„ç†
  â†“
ç­‰å¾… HQD_ACTIVE = 0 (ç¡¬ä»¶ç©ºé—²)
  â†“
ä¿å­˜ HQD â†’ MQD (ä¸Šä¸‹æ–‡ä¿å­˜)
  â†“
Queue æš‚åœ
```

**å…³é”®**:
- âœ… å›ºä»¶ç­‰å¾…ç¡¬ä»¶ç©ºé—²
- âœ… è‡ªåŠ¨ä¿å­˜ä¸Šä¸‹æ–‡
- âœ… ç¡¬ä»¶æ”¯æŒçš„æœºåˆ¶

---

## ğŸ¯ å¯¹ POC æµ‹è¯•çš„å½±å“

### æ›´æ–°çš„æµ‹è¯•ç­–ç•¥

#### 1. æ­£ç¡®çš„ Queue ID è·å–

```bash
# åœ¨ç¨‹åºè¿è¡ŒæœŸé—´æŸ¥çœ‹
while [ ç¨‹åºåœ¨è¿è¡Œ ]; do
    sudo cat /sys/kernel/debug/kfd/mqds | grep "Queue ID"
done
```

#### 2. MQD vs HQD çŠ¶æ€éªŒè¯

```bash
# è½¯ä»¶è§†è§’ (MQD)
sudo cat /sys/kernel/debug/kfd/mqds | grep "is active"

# ç¡¬ä»¶è§†è§’ (HQD)
sudo cat /sys/kernel/debug/kfd/hqds | awk 'NR % 58 == 3 { print $2 }'
```

#### 3. ç†è§£ suspend_queues çš„å»¶è¿Ÿ

**é¢„æœŸè¡Œä¸º**:
- å›ºä»¶éœ€è¦ç­‰å¾… HQD_ACTIVE = 0
- å¦‚æœ Queue æ­£åœ¨æ‰§è¡Œï¼Œä¼šæœ‰å»¶è¿Ÿ
- Grace period å‚æ•°æ§åˆ¶ç­‰å¾…æ—¶é—´

---

## ğŸ”¬ å®éªŒéªŒè¯è®¡åˆ’

### å®éªŒ 1: MQD ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿ

```bash
# 1. æŸ¥çœ‹åˆå§‹ MQD (åº”è¯¥ä¸ºç©º)
sudo cat /sys/kernel/debug/kfd/mqds

# 2. å¯åŠ¨ GPU ç¨‹åº
python gpu_test.py &

# 3. è§‚å¯Ÿ MQD åˆ›å»º
sudo cat /sys/kernel/debug/kfd/mqds

# 4. ç­‰å¾…ç¨‹åºç»“æŸ

# 5. è§‚å¯Ÿ MQD é”€æ¯ (åº”è¯¥å†æ¬¡ä¸ºç©º)
sudo cat /sys/kernel/debug/kfd/mqds
```

---

### å®éªŒ 2: HQD_ACTIVE ä½ç›‘æ§

```bash
# æŒç»­ç›‘æ§ HQD_ACTIVE ä½
watch -n 1 'sudo cat /sys/kernel/debug/kfd/hqds | awk "NR % 58 == 3 { print \$2 }"'
```

---

### å®éªŒ 3: suspend_queues å»¶è¿Ÿæµ‹è¯•

```python
# æµ‹è¯• grace period å¯¹å»¶è¿Ÿçš„å½±å“
for grace in [100, 1000, 10000]:  # us
    start = time.time()
    suspend_queues([qid], grace)
    latency = time.time() - start
    print(f"Grace {grace}us â†’ Latency {latency*1000}ms")
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **å®˜æ–¹æ–‡æ¡£**: https://docs.kernel.org/gpu/amdgpu/driver-core.html
2. **å…³é”®ç« èŠ‚**: "GFX, Compute, and SDMA Overall Behavior"
3. **ç›¸å…³æ–‡æ¡£**:
   - `/mnt/md0/zhehan/code/coderampup/private_github/amdgpudriver/doc/scheduler/DOC_POC_stage1/ARCH_Design_04_HQDä¿¡æ¯è·å–å®Œæ•´æŒ‡å—.md`
   - `/mnt/md0/zhehan/code/coderampup/private_github/amdgpudriver/doc/kernel_submit/test_queue_limits/logs_KCQ_config/PRECISE_HQD_COUNTING_METHOD.md`

---

## âœ… å…³é”®ç»“è®º

### 1. MQD å’Œ HQD æ˜¯ Queue åœ¨ä¸åŒå±‚æ¬¡çš„è¡¨ç¤º

- **MQD**: è½¯ä»¶/å†…å­˜å±‚ï¼Œå­˜å‚¨ Queue çŠ¶æ€
- **HQD**: ç¡¬ä»¶å±‚ï¼Œæ§åˆ¶å®é™…æ‰§è¡Œ

### 2. å›ºä»¶ (MES/KIQ) æ˜¯å…³é”®ä¸­ä»‹

- ç®¡ç† MQD â†” HQD è½¬æ¢
- è´Ÿè´£ Queue è°ƒåº¦å’Œåˆ‡æ¢
- ç­‰å¾…ç¡¬ä»¶å°±ç»ªåæ“ä½œ

### 3. HQD_ACTIVE æ˜¯æ ¸å¿ƒçŠ¶æ€ä½

- bit[0] = 1: Queue æ´»è·ƒ
- bit[0] = 0: Queue ç©ºé—²ï¼Œå¯å®‰å…¨æ“ä½œ
- å›ºä»¶åœ¨åˆ‡æ¢å‰ç­‰å¾…æ­¤ä½

### 4. POC Stage 1 çš„ suspend_queues æ˜¯æ­£ç¡®çš„æ–¹å‘

- åˆ©ç”¨å®˜æ–¹æ”¯æŒçš„æœºåˆ¶
- å›ºä»¶è‡ªåŠ¨å¤„ç†ä¸Šä¸‹æ–‡ä¿å­˜
- ç¡¬ä»¶çº§åˆ«çš„ Queue åˆ‡æ¢

---

**æœ€åæ›´æ–°**: 2026-02-03  
**åŸºäº**: Linux Kernel 6.19.0-rc8 Documentation

è¿™ä»½å®˜æ–¹æ–‡æ¡£å®Œç¾åœ°éªŒè¯äº†æˆ‘ä»¬ä¹‹å‰çš„ç ”ç©¶æ–¹å‘ï¼âœ…
