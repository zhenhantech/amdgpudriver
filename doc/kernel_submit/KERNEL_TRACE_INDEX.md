# Kernelæäº¤æµç¨‹å®Œæ•´ä»£ç è¿½è¸ª

**ç›®çš„**: ä»ä»£ç å±‚é¢è¿½è¸ªä¸€ä¸ªå®Œæ•´çš„kernelæäº¤æµç¨‹ï¼Œç†è§£æ¯ä¸€æ­¥çš„å®ç°æœºåˆ¶  
**ä»£ç åŸºç¡€**: ROCm_keyDriver ä»£ç åº“  
**åˆ›å»ºæ—¶é—´**: 2026-01-16  
**æ›´æ–°æ—¶é—´**: 2026-01-29

---

## ğŸš¨ é‡è¦å‘ç° - Stream ä¼˜å…ˆçº§ä»£ç é—®é¢˜ï¼ˆå¿…è¯»ï¼ï¼‰

### âš ï¸ HSA Runtime ä¸­ä¼˜å…ˆçº§è¢«å†™æ­» âš ï¸

**å…³é”®å‘ç°**: åœ¨æ·±åº¦è¿½è¸ª Stream ä¼˜å…ˆçº§æœºåˆ¶æ—¶å‘ç°ï¼šHSA Runtime ä¸­ Queue ä¼˜å…ˆçº§è¢«ç¡¬ç¼–ç ä¸º `NORMAL`ï¼Œå¯¼è‡´**æ‰€æœ‰ä¼˜å…ˆçº§è®¾ç½®å¤±æ•ˆ**ï¼

**ä½ç½®**: `rocr-runtime/core/runtime/amd_aql_queue.cpp` **Line 100**

```cpp
priority_(HSA_QUEUE_PRIORITY_NORMAL),  // âš ï¸âš ï¸âš ï¸ å†™æ­»äº†ï¼
```

**å½±å“**: 
- âŒ æ‰€æœ‰ `hipStreamCreateWithPriority()` è®¾ç½®çš„ä¼˜å…ˆçº§è¢«å¿½ç•¥
- âŒ æ‰€æœ‰ Queue éƒ½æ˜¯ NORMAL ä¼˜å…ˆçº§
- âŒ MQD ä¸­çš„ `cp_hqd_pipe_priority` å¯„å­˜å™¨éƒ½æ˜¯ç›¸åŒå€¼ (1)
- âŒ CP/MES ç¡¬ä»¶æ— æ³•åŒºåˆ†é«˜ä½ä¼˜å…ˆçº§ Queue
- âŒ æ— æ³•æµ‹è¯•æˆ–ä½¿ç”¨ä¼˜å…ˆçº§è°ƒåº¦åŠŸèƒ½

**é€‚ç”¨èŒƒå›´**: 
- âœ… CPSCH æ¨¡å¼ (MI308X ç­‰) - å—å½±å“
- âœ… MES æ¨¡å¼ (é«˜ç«¯ GFX11+ GPU) - å—å½±å“
- âœ… **æ‰€æœ‰ä½¿ç”¨ HSA Runtime çš„ AMD GPU** - éƒ½å—å½±å“

**ç›¸å…³æ–‡æ¡£**: 
- ğŸ“‹ [PRIORITY_CODE_FIX_TODO.md](./PRIORITY_CODE_FIX_TODO.md) - **è¯¦ç»†ä¿®å¤æ­¥éª¤å’Œæµ‹è¯•è®¡åˆ’** â­â­â­
- ğŸ“Š [PRIORITY_SUMMARY_FOR_MI308X.md](./PRIORITY_SUMMARY_FOR_MI308X.md) - MI308X ä¼˜å…ˆçº§æœºåˆ¶æ€»ç»“
- ğŸ”¬ [PRIORITY_TO_HARDWARE_DEEP_TRACE.md](./PRIORITY_TO_HARDWARE_DEEP_TRACE.md) - ä¼˜å…ˆçº§åˆ°ç¡¬ä»¶é…ç½®çš„å®Œæ•´è¿½è¸ª
- ğŸ”§ [PRIORITY_CPSCH_MODE_TRACE.md](./PRIORITY_CPSCH_MODE_TRACE.md) - CPSCH æ¨¡å¼ï¼ˆMI308Xï¼‰ä¼˜å…ˆçº§å¤„ç†

**çŠ¶æ€**: ğŸ“ å¾…ä¿®å¤ | ä¼˜å…ˆçº§: ğŸ”´ é«˜ | é¢„è®¡å·¥ä½œé‡: 2.5 å¤©

---

## âš ï¸ ç¡¬ä»¶æ”¯æŒè¯´æ˜

æœ¬ç³»åˆ—æ–‡æ¡£ä¸»è¦æè¿°ä½¿ç”¨ **MES (Micro-Engine Scheduler)** ç¡¬ä»¶è°ƒåº¦å™¨çš„ kernel æäº¤æµç¨‹ã€‚

### âœ… å®Œå…¨é€‚ç”¨çš„ GPUï¼ˆæ”¯æŒ MESï¼‰
- **CDNA3**: MI300A/X (IP_VERSION 12.0.x)
- **CDNA2**: MI250X, MI210 (IP_VERSION 9.4.1)
- **RDNA3**: RX 7900 XT/XTX (IP_VERSION 11.0.x)

### âš ï¸ éƒ¨åˆ†é€‚ç”¨çš„ GPUï¼ˆä½¿ç”¨ CPSCHï¼‰
ä»¥ä¸‹ GPU ä½¿ç”¨ **CPSCH (Compute Process Scheduler)** è½¯ä»¶è°ƒåº¦å™¨ï¼Œæµç¨‹æœ‰æ‰€ä¸åŒï¼š
- **CDNA2**: **MI308X (Aqua Vanjaram)** (IP_VERSION 9.4.2/3) - ç‰¹æ®Šæƒ…å†µï¼šè™½åç§°ä¼¼ MI300ï¼Œä½†ä¸æ”¯æŒ MES
- **CDNA1**: MI100 (IP_VERSION 9.4.0)
- **Vega 20**: MI50, MI60 (IP_VERSION 9.0.x)
- **RDNA2**: RX 6000 ç³»åˆ— (IP_VERSION 10.3.x)

**æ£€æŸ¥æ‚¨çš„ GPU**:
```bash
cat /sys/module/amdgpu/parameters/mes  # 1=MES, 0=CPSCH
```
[root@hjbog-srdc-26 zhehan]# cat /sys/module/amdgpu/parameters/mes
0

**ä¸»è¦åŒºåˆ«**:

âš ï¸ **é‡è¦æ¾„æ¸…**ï¼šæ— è®º MES è¿˜æ˜¯ CPSCHï¼Œ**ç”¨æˆ·ç©ºé—´æäº¤ AQL packet çš„æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„**ï¼š
```
ç”¨æˆ·ç©ºé—´å†™ AQL packet åˆ° Queue â†’ å†™ Doorbell â†’ GPU ç¡¬ä»¶æ„ŸçŸ¥
```

**çœŸæ­£çš„åŒºåˆ«åœ¨äº Queue çš„è°ƒåº¦ç®¡ç†**ï¼š

| ç‰¹æ€§ | MES æ¨¡å¼ | CPSCH æ¨¡å¼ |
|------|---------|-----------|
| **AQL Packet æäº¤** | âœ… ç”¨æˆ·ç©ºé—´ç›´æ¥å†™ doorbell | âœ… ç”¨æˆ·ç©ºé—´ç›´æ¥å†™ doorbell |
| **Queue åˆ›å»º/æ¿€æ´»** | é€šè¿‡ MES APIï¼ˆç¡¬ä»¶è°ƒåº¦ï¼‰ | é€šè¿‡ PM4 runlistï¼ˆè½¯ä»¶è°ƒåº¦ï¼‰ |
| **Queue è°ƒåº¦å™¨** | MES ç¡¬ä»¶è‡ªåŠ¨è°ƒåº¦ | CPSCH é©±åŠ¨ç®¡ç† runlist |
| **å»¶è¿Ÿæ¥æº** | Queue è°ƒåº¦ï¼ˆç¡¬ä»¶ï¼Œå¿«ï¼‰ | Queue è°ƒåº¦ï¼ˆè½¯ä»¶ï¼Œæ…¢ï¼‰ |
| **Kernel æ‰§è¡Œ** | CP ç›´æ¥ä» Queue è¯»å– | CP ç›´æ¥ä» Queue è¯»å– |

**å…³é”®æ´å¯Ÿ**ï¼ˆåŸºäº MI308X å®æµ‹ï¼‰:
- âœ… **Compute Ring æäº¤**: ä¸ç»è¿‡é©±åŠ¨å±‚ï¼Œç”¨æˆ·ç©ºé—´ â†’ doorbell â†’ ç¡¬ä»¶
- âœ… **MES/CPSCH åªå½±å“**: Queue çš„åˆ›å»ºã€æ¿€æ´»ã€è°ƒåº¦ç®¡ç†
- âœ… **ä¸€æ—¦ Queue æ¿€æ´»å**: packet æäº¤æµç¨‹å®Œå…¨ä¸€æ ·

è¯¦è§ï¼š[KERNEL_TRACE_CPSCH_MECHANISM.md](./KERNEL_TRACE_CPSCH_MECHANISM.md)

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µæ¾„æ¸…

### HSA Queue ä¸ AQL çš„å…³ç³»

**å¸¸è§è¯¯è§£**: HSA Queue å’Œ AQL Queue æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å±‚  
**å®é™…æƒ…å†µ**: å®ƒä»¬æ˜¯åŒä¸€ä¸ªå®ä½“çš„ä¸åŒè§†è§’

```
HSA Queue = é˜Ÿåˆ—å¯¹è±¡ï¼ˆé€»è¾‘æ¥å£ + å…ƒæ•°æ®ï¼‰
  â”œâ”€ base_address å­—æ®µ â†’ æŒ‡å‘å†…å­˜ä¸­çš„ ring buffer
  â””â”€ ring buffer ä¸­å­˜å‚¨çš„æ˜¯ â†’ AQL Packetsï¼ˆæŒ‰ AQL æ ¼å¼å®šä¹‰ï¼‰

AQL = Architected Queuing Languageï¼ˆå®šä¹‰ packet çš„æ ¼å¼è§„èŒƒï¼‰
  â”œâ”€ kernel_dispatch_packet
  â”œâ”€ barrier_and_packet
  â””â”€ agent_dispatch_packet
```

**ç±»æ¯”ç†è§£**:
- **HSA Queue** â‰ˆ æ–‡ä»¶å¯¹è±¡ï¼ˆFILE*ï¼‰ï¼ŒåŒ…å«æ–‡ä»¶å…ƒæ•°æ®
- **AQL Packets** â‰ˆ æ–‡ä»¶å†…å®¹çš„æ ¼å¼è§„èŒƒï¼ˆå¦‚ JSONã€XMLï¼‰
- **base_address** â‰ˆ æ–‡ä»¶å†…å®¹çš„å®é™…å­˜å‚¨ä½ç½®

è¯¦è§ï¼š
- [KERNEL_TRACE_01_APP_TO_HIP.md ç¬¬ 4.1 èŠ‚](./KERNEL_TRACE_01_APP_TO_HIP.md#41-hip-streamä¸hsa-queueçš„å…³ç³») - HIP Stream ä¸ HSA Queue çš„æ˜ å°„å…³ç³»
- [AQLå®šä¹‰è¯¦è§£.md](./AQLå®šä¹‰è¯¦è§£.md) - AQL Packet æ ¼å¼çš„å®Œæ•´å®šä¹‰

---

## ğŸ“š æ–‡æ¡£ç»“æ„

æœ¬ç³»åˆ—æ–‡æ¡£æŒ‰ç…§kernelæäº¤çš„æµç¨‹é¡ºåºï¼Œåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š

### 1ï¸âƒ£ [åº”ç”¨å±‚åˆ°HIP Runtime](./KERNEL_TRACE_01_APP_TO_HIP.md)
- Python/C++åº”ç”¨å±‚è°ƒç”¨
- HIP APIå±‚ï¼ˆhipLaunchKernelï¼‰
- HIP Runtimeå®ç°
- ä»£ç è·¯å¾„ï¼šä»ç”¨æˆ·ä»£ç åˆ° `ROCm_keyDriver/rocm-systems/projects/clr/`

### 2ï¸âƒ£ [HSA Runtimeå±‚](./KERNEL_TRACE_02_HSA_RUNTIME.md)
- HSA Queueåˆ›å»ºï¼ˆhsa_queue_createï¼‰
- AQL Packetç»“æ„å’Œå†™å…¥
- Doorbellæœºåˆ¶å®ç°
- ä»£ç è·¯å¾„ï¼š`ROCm_keyDriver/rocm-systems/projects/rocr-runtime/`

### 3ï¸âƒ£ [KFDé©±åŠ¨å±‚ - Queueç®¡ç†](./KERNEL_TRACE_03_KFD_QUEUE.md)
- KFD ioctlæ¥å£ï¼ˆAMDKFD_IOC_CREATE_QUEUEï¼‰
- Queueå±æ€§è®¾ç½®
- Device Queue Manager
- ä»£ç è·¯å¾„ï¼š`ROCm_keyDriver/kfd-amdgpu-debug-20260106/amd/amdkfd/`

### 4ï¸âƒ£ [MESè°ƒåº¦å™¨ä¸ç¡¬ä»¶å±‚](./KERNEL_TRACE_04_MES_HARDWARE.md)
- MES add_hw_queueå®ç°
- Doorbellåˆ°ç¡¬ä»¶çš„ä¼ é€’
- MESè°ƒåº¦å™¨å·¥ä½œåŸç†
- ä»£ç è·¯å¾„ï¼š`ROCm_keyDriver/kfd-amdgpu-debug-20260106/amd/amdgpu/mes_*.c`

### 4.5ï¸âƒ£ [CPSCHè½¯ä»¶è°ƒåº¦å™¨æœºåˆ¶è¯¦è§£](./KERNEL_TRACE_CPSCH_MECHANISM.md) â­ **æ–°å¢**
- CPSCHçš„æ ¸å¿ƒå·¥ä½œæœºåˆ¶ï¼š"æ”¶åˆ°Queueåæ‰¾ç©ºé—²CPå¹¶ç»‘å®š"
- HQDï¼ˆHardware Queue Descriptorï¼‰åˆ†é…ç­–ç•¥
- `allocate_hqd()` çš„è½®è¯¢åˆ†é…ç®—æ³•
- Queue åˆ° CPï¼ˆCommand Processorï¼‰çš„ç¡¬ä»¶ç»‘å®šè¿‡ç¨‹
- `kgd_hqd_load()` çš„å¯„å­˜å™¨å†™å…¥æµç¨‹
- å¤šè¿›ç¨‹åœºæ™¯ä¸‹çš„èµ„æºåˆ†é…é—®é¢˜åˆ†æ
- ä»£ç è·¯å¾„ï¼š`ROCm_keyDriver/kfd-amdgpu-debug-20260106/amd/amdkfd/kfd_device_queue_manager.c`

### 5ï¸âƒ£ [å…³é”®æ•°æ®ç»“æ„è¯¦è§£](./KERNEL_TRACE_05_DATA_STRUCTURES.md)
- AQL Queueç»“æ„
- AQL Packetæ ¼å¼
- Contextå’ŒEntityç»“æ„
- MESå‘½ä»¤æ ¼å¼

### ğŸ“– [æ·±åº¦å‚è€ƒ: AQLå®šä¹‰è¯¦è§£](./AQLå®šä¹‰è¯¦è§£.md)
- å®Œæ•´çš„HSAæ ‡å‡†å®šä¹‰
- æ‰€æœ‰Packetç±»å‹è¯¦è§£
- Headerã€Fence Scopeç­‰è¯¦ç»†è¯´æ˜
- é€‚åˆæ·±å…¥ç ”ç©¶AQLè§„èŒƒ

### ğŸ“– [æ·±åº¦å‚è€ƒ: MECæ¶æ„è¯¦è§£](./MEC_ARCHITECTURE.md) â­ **æ–°å¢**
- MEC (Micro-Engine Compute) å®Œæ•´æ¶æ„
- MEC â†’ Pipe â†’ Queue ä¸‰å±‚ç»“æ„
- ä¸ºä»€ä¹ˆ KFD åªä½¿ç”¨ MEC 0
- MEC å›ºä»¶å’Œå¯„å­˜å™¨è®¿é—®
- MI308X çš„å®Œæ•´ MEC é…ç½®ï¼ˆ2 MECs Ã— 4 Pipes Ã— 8 Queuesï¼‰
- éªŒè¯å’Œè°ƒè¯•æ–¹æ³•

### ğŸ“Œ [ä¸“é¢˜: Stream ç®¡ç†æœºåˆ¶](./KERNEL_TRACE_STREAM_MANAGEMENT.md)
- Stream çš„æ¦‚å¿µå’Œä½œç”¨
- Stream ä¸ HSA Queue çš„æ˜ å°„
- é»˜è®¤ Stream vs ç”¨æˆ·åˆ›å»ºçš„ Stream
- Stream åŒæ­¥æœºåˆ¶
- å¤š Stream å¹¶å‘æ‰§è¡Œ
- âš ï¸ **é‡è¦å‘ç°**: å¤šè¿›ç¨‹åœºæ™¯ä¸‹çš„ Stream åˆ° Queue æ˜ å°„é—®é¢˜
  - å¤šä¸ª Stream å¯èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªåº•å±‚ KFD Queue
  - å¯¼è‡´ä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œæ€§èƒ½ä¸‹é™ 50%+
  - éœ€è¦è¿›ä¸€æ­¥ç ”ç©¶ Queue åˆ†é…æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–å»ºè®®

### ğŸ”§ [å·¥å…·: ROCm Profiling Tools ä½¿ç”¨æŒ‡å—](./ROCM_PROFILING_TOOLS_GUIDE.md)
- ROCprofiler-SDK (rocprofv3) vs æ—§ç‰ˆå·¥å…·å¯¹æ¯”
- ä¸ºä»€ä¹ˆé€‰æ‹© ROCprofiler-SDK
- åŸºç¡€ä½¿ç”¨å’Œå¸¸ç”¨å‘½ä»¤

### âœ… [éªŒè¯æŒ‡å—: æ–‡æ¡£æ­£ç¡®æ€§éªŒè¯](./VERIFICATION_GUIDE.md)
- æµ‹è¯•ç¨‹åºå’ŒéªŒè¯è„šæœ¬
- 6 ç§éªŒè¯æ–¹æ³•ï¼ˆrocprof, ftrace, strace, dmesg ç­‰ï¼‰
- å…³é”®éªŒè¯ç‚¹æ¸…å•
- å®Œæ•´éªŒè¯æµç¨‹
- æ•…éšœæ’æŸ¥æŒ‡å—
- éªŒè¯ Kernel æäº¤æµç¨‹çš„æ–¹æ³•
- è¾“å‡ºæ ¼å¼å’Œå¯è§†åŒ– (Perfetto, CSV, OTF2)
- å®Œæ•´ç¤ºä¾‹å’Œå¸¸è§é—®é¢˜

### â“ [é‡è¦æ¾„æ¸… 1: Kernel æäº¤è·¯å¾„å®Œæ•´åˆ†æ](./KERNEL_SUBMISSION_PATHS.md)
- **å…³é”®é—®é¢˜**: æ˜¯å¦ 100% çš„ HIP compute kernel éƒ½é€šè¿‡ Doorbellï¼Ÿ
- **ç­”æ¡ˆ**: MES æ¨¡å¼ä¸‹ï¼Œcompute kernel **100%** èµ° Doorbellï¼Œ**0%** èµ° KFD Ring
- **æ¾„æ¸…**: ä¹‹å‰è¯´çš„"90%"æ˜¯ä»æ“ä½œæ¬¡æ•°ç»Ÿè®¡ï¼ˆåŒ…å« SDMAï¼‰ï¼Œä¸æ˜¯å•æŒ‡ compute kernel
- Compute Kernel vs SDMA æ“ä½œçš„å®Œæ•´è·¯å¾„å¯¹æ¯”
- MES vs CPSCH æ¨¡å¼ä¸‹çš„æäº¤è·¯å¾„å·®å¼‚
- ftrace éªŒè¯æ–¹æ³•å’Œé¢„æœŸç»“æœ
- ä»£ç å±‚é¢çš„è¯æ˜ï¼ˆæ— åˆ†æ”¯èµ° KFDï¼‰
- ç‰¹æ®Šæƒ…å†µåˆ†æï¼ˆCooperative kernel ç­‰ï¼‰

### â“ [é‡è¦æ¾„æ¸… 2: hipMemcpy ä»£ç åˆ†æ”¯å®Œæ•´è¿½è¸ª](./HIPMEMCPY_CODE_TRACE.md)
- **å…³é”®é—®é¢˜**: hipMemcpy çš„ Blit Kernel vs SDMA Engine é€‰æ‹©é€»è¾‘
- **å…³é”®é˜ˆå€¼**: 128 MBï¼ˆPinned vs Stagingï¼‰ï¼Œ32 MBï¼ˆPinned åˆ†å—ï¼‰ï¼Œ4 MBï¼ˆStaging åˆ†å—ï¼‰
- **H2D/D2H æ‹·è´**: 100% èµ° SDMA Engineï¼ˆè§¦å‘ drm_run_jobï¼‰
- **D2D æ‹·è´**: HSA Runtime è‡ªåŠ¨é€‰æ‹© Blit Kernel æˆ– SDMA
- å®Œæ•´ä»£ç è¿½è¸ªï¼šHIP â†’ ROCclr â†’ HSA Runtime â†’ KFD
- getBuffer() å‡½æ•°çš„é˜ˆå€¼åˆ¤æ–­é€»è¾‘
- rocrCopyBuffer() çš„å¼•æ“é€‰æ‹©
- ä»£ç ä½ç½®ç´¢å¼•

### â“ [é‡è¦æ¾„æ¸… 3: Stream ä¼˜å…ˆçº§ä¸ Queue æ˜ å°„](./STREAM_PRIORITY_AND_QUEUE_MAPPING.md)
- **å…³é”®é—®é¢˜**: ä¸åŒä¼˜å…ˆçº§çš„ Stream æ˜¯å¦å…±äº« ring-bufferï¼Ÿ
- **ç­”æ¡ˆ**: âœ… **æ¯ä¸ª Stream éƒ½æœ‰ç‹¬ç«‹çš„ Queue (ring-buffer)**ï¼Œæ— è®ºä¼˜å…ˆçº§æ˜¯å¦ç›¸åŒ
- **æ˜ å°„å…³ç³»**: 1 Stream = 1 HSA Queue = 1 ring-buffer = 1 Queue ID = 1 doorbell
- ä¼˜å…ˆçº§çš„ä½œç”¨ï¼šå½±å“è°ƒåº¦é¡ºåºï¼Œä¸å½±å“ Queue ç‹¬ç«‹æ€§
- ä¼˜å…ˆçº§æ˜ å°„ï¼šHigh(11-15) â†’ PIPE_HIGH, Normal(7-10) â†’ PIPE_MEDIUM, Low(0-6) â†’ PIPE_LOW
- å®Œæ•´ä»£ç è¿½è¸ªï¼šhipStreamCreateWithPriority â†’ AqlQueue â†’ KFD
- å¤šè¿›ç¨‹åœºæ™¯ä¸‹çš„ Queue éš”ç¦»
- MQD ä¸­çš„ priority å­—æ®µï¼ˆcp_hqd_pipe_priority, cp_hqd_queue_priorityï¼‰
- å®é™…æµ‹è¯•ç¨‹åºï¼š[test_stream_priority/](./test_stream_priority/)

### ğŸ”¬ [æ·±åº¦è¿½è¸ª: ä¼˜å…ˆçº§åˆ°ç¡¬ä»¶é…ç½®çš„å®Œæ•´è·¯å¾„](./PRIORITY_TO_HARDWARE_DEEP_TRACE.md)
- **æ ¸å¿ƒç›®æ ‡**: è¿½è¸ªä¼˜å…ˆçº§å¦‚ä½•é…ç½®ç¡¬ä»¶å¯„å­˜å™¨ï¼Œè®© GPU æ ¹æ®ä¼˜å…ˆçº§è°ƒåº¦
- **å…³é”®å‘ç°**:
  - âœ… ä¸åŒä¼˜å…ˆçº§çš„ Queue æœ‰**ä¸åŒçš„ ring-buffer ç‰©ç†åœ°å€**
  - âœ… ä¸åŒä¼˜å…ˆçº§çš„ Queue æœ‰**ä¸åŒçš„ doorbell åç§»åœ°å€**
  - âœ… MQD ä¸­æœ‰ä¸“é—¨çš„**ä¼˜å…ˆçº§å¯„å­˜å™¨** (`cp_hqd_pipe_priority`, `cp_hqd_queue_priority`)
  - âœ… MES/CP ç¡¬ä»¶**ç›´æ¥è¯»å–è¿™äº›å¯„å­˜å™¨**è¿›è¡Œè°ƒåº¦å†³ç­–
  - âš ï¸ **é‡è¦**: HSA Runtime ä¸­ä¼˜å…ˆçº§è¢«å†™æ­»ï¼Œéœ€è¦ä¿®å¤ï¼ˆè§ä¸‹æ–¹ TODOï¼‰
- **MQD (Memory Queue Descriptor)** è¯¦è§£
- ä» `hipStreamCreateWithPriority` åˆ° `set_priority()` çš„å®Œæ•´è°ƒç”¨æ ˆ
- MQD å¯„å­˜å™¨å¯¹æ¯”ï¼šHIGH vs LOW priority
- ç¡¬ä»¶è°ƒåº¦æµç¨‹ï¼šMES å¦‚ä½•ä½¿ç”¨ä¼˜å…ˆçº§å¯„å­˜å™¨
- éªŒè¯æ–¹æ³•ï¼šdebugfsã€dmesgã€æµ‹è¯•ç¨‹åº

### ğŸ”§ [CPSCH æ¨¡å¼ä¸‹çš„ä¼˜å…ˆçº§å¤„ç†](./PRIORITY_CPSCH_MODE_TRACE.md)
- **é€‚ç”¨åœºæ™¯**: ä½¿ç”¨ CP Scheduler (CPSCH) è€Œé MES çš„ GPUï¼ˆå¦‚ MI308Xï¼‰
- **CPSCH vs MES å¯¹æ¯”**
- **Runlist æäº¤æœºåˆ¶** - CPSCH ç‰¹æœ‰çš„ PM4 packet æµç¨‹
- **MAP_QUEUES Packet** è¯¦è§£
- **CP è¯»å– MQD å’Œä¼˜å…ˆçº§** çš„å®Œæ•´è¿‡ç¨‹
- å…³é”®å·®å¼‚ï¼šCPSCH éœ€è¦æ˜¾å¼æäº¤ runlistï¼ŒMES è‡ªåŠ¨å‘ç°
- ä¼˜å…ˆçº§å¤„ç†æœ¬è´¨ç›¸åŒï¼šéƒ½é€šè¿‡ MQD ä¸­çš„å¯„å­˜å™¨é…ç½®

### ğŸš¨ [ä¼˜å…ˆçº§ä»£ç ä¿®å¤ TODO](./PRIORITY_CODE_FIX_TODO.md) â­â­â­
- **æ ¸å¿ƒé—®é¢˜**: `amd_aql_queue.cpp` Line 100 ä¼˜å…ˆçº§è¢«å†™æ­»ä¸º NORMAL
- **å½±å“**: æ‰€æœ‰ Queue éƒ½æ˜¯ç›¸åŒä¼˜å…ˆçº§ï¼Œæ— æ³•æµ‹è¯•ä¼˜å…ˆçº§è°ƒåº¦
- **ä¿®å¤æ–¹æ¡ˆ**:
  - ä¿®æ”¹ `AqlQueue` æ„é€ å‡½æ•°ï¼Œæ¥å— priority å‚æ•°
  - ä¿®æ”¹åˆå§‹åŒ–åˆ—è¡¨ï¼š`priority_(priority)` è€Œé `priority_(NORMAL)`
  - ä¿®æ”¹ `GpuAgent::QueueCreate()` ä¼ é€’ priority
  - éªŒè¯æ•´ä¸ªè°ƒç”¨é“¾
- **æµ‹è¯•è®¡åˆ’**: åŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½æµ‹è¯•ã€å¤šè¿›ç¨‹æµ‹è¯•
- **å®æ–½è®¡åˆ’**: 3 ä¸ª Phaseï¼Œé¢„è®¡ 2.5 å¤©
- **çŠ¶æ€**: ğŸ“ å¾…å®æ–½ï¼ŒğŸ”´ é«˜ä¼˜å…ˆçº§
- **é€‚ç”¨èŒƒå›´**: ä¸»è¦æè¿° MES æ¨¡å¼ï¼ŒCPSCH æ¨¡å¼çš„å·®å¼‚è§ä¸‹æ–‡

### âš™ï¸ [CPSCH æ¨¡å¼ä¸‹çš„ä¼˜å…ˆçº§å¤„ç†](./PRIORITY_CPSCH_MODE_TRACE.md)
- **é€‚ç”¨åœºæ™¯**: ä½¿ç”¨ CP Scheduler (CPSCH) çš„ GPUï¼ˆå¦‚ MI308Xï¼‰
- **å…³é”®åŒºåˆ«**: CPSCH vs MES è°ƒåº¦å™¨
  - CPSCH = è½¯ä»¶è°ƒåº¦ï¼ŒMES = ç¡¬ä»¶è°ƒåº¦
  - MI308X ä½¿ç”¨ CPSCH æ¨¡å¼
  - **æ ¸å¿ƒæœºåˆ¶ç›¸åŒ**ï¼šéƒ½é€šè¿‡ MQD é…ç½®ä¼˜å…ˆçº§
- **CPSCH ç‰¹æœ‰æµç¨‹**: Runlist æäº¤
  - éœ€è¦é€šè¿‡ PM4 `MAP_QUEUES` packet æäº¤é˜Ÿåˆ—åˆ—è¡¨
  - `MAP_QUEUES` åŒ…å« MQD åœ°å€
  - CP ä» MQD è¯»å–ä¼˜å…ˆçº§ç­‰æ‰€æœ‰é…ç½®
- **å®Œæ•´è°ƒåº¦æµç¨‹**: Queue åˆ›å»º â†’ MQD é…ç½® â†’ Runlist æäº¤ â†’ CP è°ƒåº¦
- **æœ¬è´¨ç›¸åŒ**: CPSCH å’Œ MES çš„ä¼˜å…ˆçº§å¤„ç†æœºåˆ¶å®Œå…¨ç›¸åŒ
  - éƒ½é…ç½®ç›¸åŒçš„ MQD å¯„å­˜å™¨
  - éƒ½é€šè¿‡ `cp_hqd_pipe_priority` è°ƒåº¦
  - å”¯ä¸€å·®å¼‚æ˜¯ Queue æ¿€æ´»æ–¹å¼

### ğŸ“Š [æ¡ˆä¾‹åˆ†æ: å¤šè¿›ç¨‹å¤š Doorbell Queue ä¼˜åŒ–å®éªŒ](./multiple_doorbellQueue/README.md)
- **å®éªŒèƒŒæ™¯**: å†å²ç ”ç©¶ä¸­å°è¯•é€šè¿‡è®©ä¸åŒè¿›ç¨‹ä½¿ç”¨ä¸åŒ Queue ID æ¥æé«˜æ€§èƒ½
- **å®éªŒè¯„ä¼°**: âœ… æŠ€æœ¯å®ç°æ­£ç¡® / âŒ æ€§èƒ½æœªè¾¾é¢„æœŸï¼ˆ60.7% vs ç›®æ ‡â‰¥95%ï¼‰
- **æ ¸å¿ƒå‘ç°**: 
  - Queue ID åˆ†é…ä¼˜åŒ–æ˜¯å¿…è¦çš„ä½†ä¸å……åˆ†çš„
  - å‘ç°äº†æ›´æ·±å±‚ç“¶é¢ˆï¼š`active_runlist` ä¸²è¡ŒåŒ–ã€Ring å…±äº«ç­‰
  - å•è¿›ç¨‹å·²é¥±å’Œ GPU CUï¼Œå¤šè¿›ç¨‹ CU ç«äº‰ä¸æ˜¯ä¸»è¦é—®é¢˜
- **æŠ€æœ¯æ´å¯Ÿ**:
  - Doorbell æœºåˆ¶ç†è§£æ­£ç¡®æ€§éªŒè¯
  - è°ƒåº¦å™¨å±‚é¢çš„ä¸²è¡ŒåŒ–æ˜¯å…³é”®ç“¶é¢ˆ
  - æ€§èƒ½ä¼˜åŒ–éœ€è¦ç³»ç»Ÿæ€§æ€ç»´å’Œå…¨æ ˆåˆ†æ
- **æ¦‚å¿µæ¾„æ¸…**: [è½¯ä»¶é˜Ÿåˆ— vs ç¡¬ä»¶é˜Ÿåˆ—](./multiple_doorbellQueue/SOFTWARE_VS_HARDWARE_QUEUES.md) ğŸ”‘
  - ä¸ºä»€ä¹ˆæœ‰ 1024 ä¸ªè½¯ä»¶é˜Ÿåˆ—ï¼ˆQueue IDï¼‰ä½†åªæœ‰ 32 ä¸ªç¡¬ä»¶é˜Ÿåˆ—ï¼ˆHQDï¼‰
  - è½¯ä»¶é˜Ÿåˆ—åˆ°ç¡¬ä»¶é˜Ÿåˆ—çš„æ˜ å°„æœºåˆ¶
  - ä¸ºä»€ä¹ˆå®éªŒä¸­ç¡¬ä»¶èµ„æºä¸æ˜¯ç“¶é¢ˆ
- **ä¼˜åŒ–è·¯å¾„å»ºè®®**: è°ƒåº¦å™¨ä¼˜åŒ– â†’ Doorbell éš”ç¦» â†’ Ring æ˜ å°„ä¼˜åŒ–
- è¯¦ç»†åˆ†æè¯·é˜…è¯» [å®Œæ•´æŠ¥å‘Š](./multiple_doorbellQueue/ANALYSIS_REPORT.md)

---

## ğŸ¯ é˜…è¯»å»ºè®®

### å¿«é€Ÿäº†è§£
å¦‚æœåªæƒ³å¿«é€Ÿäº†è§£æµç¨‹ï¼š
1. é˜…è¯»æœ¬æ–‡æ¡£çš„"æµç¨‹æ¦‚è§ˆ"éƒ¨åˆ†
2. æŸ¥çœ‹å„å­æ–‡æ¡£çš„"å…³é”®ä»£ç "éƒ¨åˆ†

### æ·±å…¥å­¦ä¹ 
å¦‚æœæƒ³æ·±å…¥ç†è§£å®ç°ï¼š
1. æŒ‰ç…§1â†’2â†’3â†’4â†’5çš„é¡ºåºé˜…è¯»
2. å¯¹ç…§ä»£ç åº“å®é™…æŸ¥çœ‹æºç 
3. å…³æ³¨"å…³é”®å‘ç°"å’Œ"é‡è¦æ³¨æ„"éƒ¨åˆ†

### ä»£ç è°ƒè¯•
å¦‚æœè¦è¿›è¡Œè°ƒè¯•ï¼š
1. å…ˆçœ‹"éªŒè¯æ–¹æ³•"éƒ¨åˆ†
2. ä½¿ç”¨æä¾›çš„æ—¥å¿—ã€traceã€straceæ–¹æ³•
3. å‚è€ƒ"å…³é”®æ—¥å¿—ç¤ºä¾‹"

---

## ğŸ”„ å®Œæ•´æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚: åº”ç”¨å±‚ (Python/C++)                                       â”‚
â”‚ æ–‡ä»¶: ç”¨æˆ·ä»£ç                                                    â”‚
â”‚ æ“ä½œ: è°ƒç”¨ hipLaunchKernel()                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚: HIP Runtime                                              â”‚
â”‚ è·¯å¾„: ROCm_keyDriver/rocm-systems/projects/clr/hipamd/         â”‚
â”‚ æ“ä½œ: HIP APIå®ç°ï¼Œè°ƒç”¨HSA Runtime                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚: HSA Runtime - Queueåˆ›å»º                                  â”‚
â”‚ è·¯å¾„: ROCm_keyDriver/rocm-systems/projects/rocr-runtime/       â”‚
â”‚ æ“ä½œ: hsa_queue_create() åˆ›å»ºAQL Queue                         â”‚
â”‚ ç³»ç»Ÿè°ƒç”¨: ioctl(AMDKFD_IOC_CREATE_QUEUE)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬4å±‚: HSA Runtime - Kernelæäº¤                                 â”‚
â”‚ è·¯å¾„: ROCm_keyDriver/rocm-systems/projects/rocr-runtime/       â”‚
â”‚ æ“ä½œ: å†™å…¥AQL packet â†’ æ›´æ–°wptr â†’ å†™å…¥doorbell                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬5å±‚: KFDé©±åŠ¨ - Queueåˆ›å»ºå¤„ç†                                  â”‚
â”‚ è·¯å¾„: ROCm_keyDriver/kfd-amdgpu-debug-20260106/amd/amdkfd/     â”‚
â”‚ æ–‡ä»¶: kfd_chardev.c, kfd_device_queue_manager.c                â”‚
â”‚ æ“ä½œ: å¤„ç†CREATE_QUEUE ioctlï¼Œè°ƒç”¨add_queue_mes()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬6å±‚: MESè°ƒåº¦å™¨ - æ³¨å†ŒQueue                                    â”‚
â”‚ è·¯å¾„: ROCm_keyDriver/kfd-amdgpu-debug-20260106/amd/amdgpu/     â”‚
â”‚ æ–‡ä»¶: mes_v12_0.c, amdgpu_mes.c                                â”‚
â”‚ æ“ä½œ: MESé€šè¿‡MES Ringæäº¤ADD_QUEUEå‘½ä»¤                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬7å±‚: Doorbellæ£€æµ‹                                             â”‚
â”‚ ç¡¬ä»¶: GPUæ£€æµ‹åˆ°doorbellå¯„å­˜å™¨æ›´æ–°                               â”‚
â”‚ æ“ä½œ: MESç¡¬ä»¶è°ƒåº¦å™¨è¢«è§¦å‘                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬8å±‚: MESç¡¬ä»¶è°ƒåº¦å™¨                                            â”‚
â”‚ ç¡¬ä»¶: MES (Micro-Engine Scheduler)                             â”‚
â”‚ æ“ä½œ: ä»AQL Queueè¯»å–packetï¼ˆæ ¹æ®rptrï¼‰                        â”‚
â”‚       è§£æDispatch Header                                       â”‚
â”‚       è°ƒåº¦kernelåˆ°GPUæ‰§è¡Œå•å…ƒ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬9å±‚: GPUæ‰§è¡Œ                                                  â”‚
â”‚ ç¡¬ä»¶: GPU Compute Units                                        â”‚
â”‚ æ“ä½œ: æ‰§è¡Œkernelä»£ç                                            â”‚
â”‚       å®Œæˆåæ›´æ–°completion signal                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®å‘ç°æ€»ç»“

### 1. ä¸¤ç§æäº¤è·¯å¾„

**ä¸»è¦è·¯å¾„ï¼ˆ90%ï¼‰- Doorbellæœºåˆ¶**:
```
åº”ç”¨ â†’ HIP â†’ HSA Runtime â†’ å†™AQL packet â†’ å†™doorbell 
â†’ MESç¡¬ä»¶è°ƒåº¦å™¨ â†’ GPUæ‰§è¡Œ
```
- âœ… ä¸ç»è¿‡KFDé©±åŠ¨å±‚Ring
- âœ… ä¸è§¦å‘ `drm_run_job` äº‹ä»¶
- âœ… ä½å»¶è¿Ÿã€é«˜ååé‡

**è¾…åŠ©è·¯å¾„ - SDMAæ“ä½œ**:
```
åº”ç”¨ â†’ HIP â†’ HSA Runtime â†’ KFDé©±åŠ¨ â†’ SDMA Ring 
â†’ GPUè°ƒåº¦å™¨ â†’ GPUæ‰§è¡Œ
```
- âœ… ç»è¿‡KFDé©±åŠ¨å±‚Ring
- âœ… è§¦å‘ `drm_run_job` äº‹ä»¶
- âœ… ä¸»è¦ç”¨äºå†…å­˜æ‹·è´ç­‰æ“ä½œ

### 2. Queueç”Ÿå‘½å‘¨æœŸ

**åˆ›å»ºæ—¶æœº**: åº”ç”¨é¦–æ¬¡ä½¿ç”¨GPUæ—¶ï¼ˆå¦‚hipInitã€é¦–æ¬¡hipMallocç­‰ï¼‰
**åˆ›å»ºæ¬¡æ•°**: æ¯ä¸ªHIP Streamå¯èƒ½å¯¹åº”ä¸€ä¸ªQueue
**ç”Ÿå‘½å‘¨æœŸ**: ä»åˆ›å»ºåˆ°åº”ç”¨ç»“æŸæˆ–æ˜¾å¼é”€æ¯

### 3. MES vs CPSCH

| ç‰¹æ€§ | MESè°ƒåº¦å™¨ | CPSCHè°ƒåº¦å™¨ |
|------|----------|------------|
| ç±»å‹ | ç¡¬ä»¶è°ƒåº¦å™¨ | è½¯ä»¶è°ƒåº¦å™¨ |
| Compute Kernel | é€šè¿‡doorbellï¼Œä¸ç»è¿‡KFD Ring | ç»è¿‡KFD Ring |
| é€‚ç”¨æ¶æ„ | æ–°æ¶æ„ï¼ˆMI300ç­‰ï¼‰ | æ—§æ¶æ„ |
| æ€§èƒ½ | ä½å»¶è¿Ÿ | ç›¸å¯¹é«˜å»¶è¿Ÿ |

### 4. å¤šè¿›ç¨‹åœºæ™¯ä¸‹çš„ Stream åˆ° Queue æ˜ å°„é—®é¢˜ âš ï¸âš ï¸

**é‡è¦å‘ç°**ï¼ˆåŸºäºå®é™…ç ”ç©¶ `/mnt/md0/zhehan/code/rampup_doc/2PORC_streams`ï¼‰:

```
ã€é—®é¢˜ã€‘
å¤šä¸ªè¿›ç¨‹çš„ HIP Stream â†’ å¯èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªåº•å±‚ KFD Queue
  â†“
Queue ä¸­çš„ä»»åŠ¡ä¸²è¡Œæ‰§è¡Œ
  â†“
æ€§èƒ½ä¸‹é™ 50%+
```

**å®éªŒæ•°æ®**:
- âœ… HIP Runtime å±‚é¢ï¼šæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„ Stream å¯¹è±¡
- âŒ KFD Queue å±‚é¢ï¼šå¤šä¸ªè¿›ç¨‹å…±äº«ç›¸åŒçš„ Queue IDï¼ˆ1ã€2ç­‰ï¼‰
- ç»“æœï¼šå•è¿›ç¨‹ QPS 107-116ï¼Œ4è¿›ç¨‹ QPS ä»… 59.0

**å½±å“èŒƒå›´**:
- ä¸»è¦å½±å“å¤šè¿›ç¨‹åº”ç”¨ï¼ˆå¦‚åˆ†å¸ƒå¼è®­ç»ƒã€å¤šè¿›ç¨‹æ¨ç†ï¼‰
- Default Streamï¼ˆQueue ID 0ï¼‰é€šå¸¸æ˜¯ç‹¬ç«‹çš„
- è‡ªå®šä¹‰ Streamï¼ˆQueue ID 1ã€2ç­‰ï¼‰å¯èƒ½å…±äº«

#### åç»­ç ”ç©¶ï¼šQueue ID åˆ†é…ä¼˜åŒ–çš„å®æ–½ä¸ç»“æœ âš ï¸

**å·²å®æ–½çš„ä¼˜åŒ–** (v5 ç‰ˆæœ¬):
- âœ… ä¿®æ”¹äº† `find_available_queue_slot()` å‡½æ•°
- âœ… æ ¹æ®è¿›ç¨‹ PID åˆ†é…ä¸åŒçš„ Queue ID èŒƒå›´
- âœ… æŠ€æœ¯å®ç°å®Œå…¨ç¬¦åˆé¢„æœŸï¼Œä¸åŒè¿›ç¨‹ä½¿ç”¨äº†ä¸åŒçš„ Queue ID

**ä½†æ€§èƒ½å¹¶æ²¡æœ‰æ˜¾è‘—æå‡**:
- 2-PROC: ä» 72 QPS æå‡åˆ° 99.75 QPS (+38.5%)
- 4-PROC: ä»ç„¶åªæœ‰ 58.5 QPSï¼ˆä¸ v4 ç›¸åŒï¼‰
- æ€§èƒ½åœ¨ 4-PROC åè¶‹äºç¨³å®šï¼ˆ~60 QPSï¼‰

**æ ¹æœ¬åŸå› åˆ†æ**:

1. **Queue ID åˆ°ç¡¬ä»¶é˜Ÿåˆ—ï¼ˆACEï¼‰çš„æ˜ å°„é—®é¢˜**
   - å³ä½¿ Queue ID ä¸åŒï¼Œå¯èƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªç¡¬ä»¶é˜Ÿåˆ—ï¼ˆACEï¼‰
   - éœ€è¦æ›´æ·±å±‚çš„ç¡¬ä»¶æ˜ å°„ä¼˜åŒ–

2. **GPU èµ„æºé¥±å’Œ**
   - å•è¿›ç¨‹æµ‹è¯•æ˜¾ç¤ºï¼šå‡å°‘ 10 ä¸ª CU å¯¼è‡´æ€§èƒ½ä¸‹é™ 28.3%ï¼ˆè¿œè¶…çº¿æ€§é¢„æœŸï¼‰
   - è¯´æ˜æµ‹è¯•è´Ÿè½½å·²ç»å……åˆ†åˆ©ç”¨ GPUï¼Œä¸æ˜¯"å°è´Ÿè½½"
   - å¤šè¿›ç¨‹ç«äº‰æœ‰é™çš„ CU èµ„æºï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™

3. **å…¶ä»–ç“¶é¢ˆ**
   - Doorbell å±‚é¢å¯èƒ½ä»ç„¶å…±äº«
   - å†…å­˜å¸¦å®½æˆä¸ºç“¶é¢ˆ
   - CPSCH è°ƒåº¦å™¨å¯èƒ½å­˜åœ¨ä¸²è¡ŒåŒ–

**å…³é”®æ´å¯Ÿ**:
```
é—®é¢˜æ˜¯å¤šå±‚æ¬¡çš„ï¼š
- åº”ç”¨å±‚: HIP Stream      âœ… ç‹¬ç«‹
- KFDå±‚: Queue ID         âœ… v5å·²ä¼˜åŒ–
- ç¡¬ä»¶å±‚: ACEæ˜ å°„         âŒ ä»å¯èƒ½å…±äº«
- ç¡¬ä»¶å±‚: CUèµ„æº          âŒ å·²é¥±å’Œ
- ç¡¬ä»¶å±‚: å†…å­˜å¸¦å®½        âŒ å¯èƒ½æˆä¸ºç“¶é¢ˆ
```

**é‡è¦è­¦å‘Š**:
- âš ï¸ **Queue ID å±‚é¢çš„ä¼˜åŒ–æ˜¯å¿…è¦çš„ï¼Œä½†ä¸å……åˆ†**
- âš ï¸ **ä¸è¦ç›²ç›®å‡è®¾å¤š Stream = é«˜æ€§èƒ½**
- âš ï¸ **éœ€è¦è€ƒè™‘å·¥ä½œè´Ÿè½½å¤§å°å’Œ GPU èµ„æºé¥±å’Œæƒ…å†µ**
- âš ï¸ **åœ¨å®é™…åº”ç”¨ä¸­å¿…é¡»é€šè¿‡æµ‹è¯•éªŒè¯æ€§èƒ½æå‡**

è¯¦è§ï¼š[KERNEL_TRACE_STREAM_MANAGEMENT.md ç¬¬ 3.4.9 èŠ‚](./KERNEL_TRACE_STREAM_MANAGEMENT.md#349-åç»­ç ”ç©¶queue-id-åˆ†é…ä¼˜åŒ–çš„å®æ–½ä¸ç»“æœ-)

---

## ğŸ“– ä»£ç è·¯å¾„å¿«é€Ÿç´¢å¼•

### ROCm Runtime (HSA)
- Queueåˆ›å»º: `rocr-runtime/runtime/hsa-runtime/core/runtime/amd_gpu_agent.cpp`
- KFDæ¥å£: `rocr-runtime/libhsakmt/src/queues.c`
- Doorbellå†™å…¥: `rocr-runtime/runtime/hsa-runtime/core/runtime/amd_blit_kernel.cpp`

### KFDé©±åŠ¨å±‚
- ioctlå¤„ç†: `amdkfd/kfd_chardev.c`
- Queueç®¡ç†: `amdkfd/kfd_device_queue_manager.c`
- Doorbellç®¡ç†: `amdkfd/kfd_doorbell.c`

### AMDGPUé©±åŠ¨å±‚
- MESè°ƒåº¦å™¨: `amdgpu/mes_v12_0.c`
- Contextç®¡ç†: `amdgpu/amdgpu_ctx.c`
- Ringç®¡ç†: `amdgpu/amdgpu_ring.c`

---

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æŸ¥çœ‹Doorbellæ—¥å¿—
```bash
export AMD_LOG_LEVEL=5
export AMD_LOG_MASK=0xFFFFFFFF
./your_hip_app
```

### 2. è¿½è¸ªç³»ç»Ÿè°ƒç”¨
```bash
strace -e trace=ioctl ./your_hip_app 2>&1 | grep KFD_IOC
```

### 3. æŸ¥çœ‹ftraceäº‹ä»¶
```bash
echo 1 > /sys/kernel/debug/tracing/events/drm/drm_run_job/enable
./your_hip_app
cat /sys/kernel/debug/tracing/trace
```

### 4. æŸ¥çœ‹å·²æ‰“å¼€çš„æ–‡ä»¶
```bash
lsof -p <pid> | grep /dev/kfd
```

---

## ğŸ“ æ–‡æ¡£æ›´æ–°è®°å½•

- **2026-01-16**: åˆ›å»ºæ–‡æ¡£ç´¢å¼•ï¼Œè§„åˆ’5ä¸ªå­æ–‡æ¡£
- åŸºäº ROCm_keyDriver ä»£ç åº“ç»„ç»‡å†…å®¹

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. åˆ›å»ºå„ä¸ªå­æ–‡æ¡£
2. å¡«å……è¯¦ç»†çš„ä»£ç åˆ†æ
3. æ·»åŠ ä»£ç ç‰‡æ®µå’Œæ³¨é‡Š
4. è¡¥å……éªŒè¯å®éªŒ


